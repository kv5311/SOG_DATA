0	-1	3	1	2	СвободныйТекст	01.01.2009 0:00:00	Маска для ввода свободного текста	Отправка смс вручную	1	True	$СвободныйТекст$. С уважением, СК "Согласие"	SELECT 'шаблон для ручной отправки' as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
1	-1	1	1	1	Платеж	21.01.2011 12:11:00	СМС об очередном платеже по договору	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Продавец1 штатный сотрудник или агент ФЛ. На основании суммы фактических и плановых платежей на дату	0	True	$Обращение$, напоминаем, что по Вашему полису №$НомерДоговораКратко$ необходимо внести очередной платеж в размере $СуммаПлатежа$$ВалютаПлатежа$ в срок до $ДатаПлатежа$. Внести платеж Вы можете в офисе или на официальном сайте Компании. Спасибо за доверие, СК Согласие	SELECT 'STARTSELECT' AS STARTSELECT, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL,1 as id_ext_type, MIN((P.PaymentID)) AS id_ext, ci.InsurerID as idx_client, MIN((P.PaymentID)) as PaymentID, P.ContractInsOID AS idx_contract, d.Number_ as Number_, ci.InsurerID as id_client,replace(f.PhoneMobile, ',', ';') AS PhoneMobile , f.Email, Fund.Brief as curr, SUM(P.Ammount2) AS "Очередной платеж", (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (P_MUST.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) AS Оплатить, (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE  (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) AND (P_IS.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) AS Оплачено FROM Sogins.Payment P INNER JOIN Sogins.ContractIns ci ON P.ContractInsOID = ci.ContractID left join sogins.inscase ic on ic.contractinsid=ci.contractid LEFT JOIN Sogins.Document d ON ci.ContractID = d.DocumentId LEFT JOIN Sogins.Fund Fund ON ci.FundID = Fund.FundID INNER JOIN Sogins.Face f ON f.FaceID = ci.InsurerID INNER JOIN Sogins.FacePerson fp ON f.FaceID = fp.FaceID inner join sogins.osagosellers os on os.sellerid=ci.seller1id left join sogins.agent sa on sa.agentid=os.faceid left join sogins.face af on af.faceid=sa.faceid WHERE (os.faceentityid=1079 or (os.faceentityid=1267 and sa.status=7)) AND (CASE WHEN  to_char(sysdate,'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 AND (nvl(P.IsFact, 0) = 0) AND (P.PaymentCategoryID = 34) AND (P.PayDate BETWEEN TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) AND (ci.InsProductID  IN ($PRODUCT_SEL$)) AND (ci.CancelDate IS NULL OR ci.CancelDate > sysdate) and (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (P_MUST.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) - (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) > 100 and (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE  (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) > 0 GROUP BY P.ContractInsOID, d.Number_,ci.policyno_lv, ci.InsurerID, f.PhoneMobile, f.Email, Fund.Brief, P.PayDate, fp.secondname, fp.lastname, fp.firstname	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
2	-1	1	2	1	Пролонгация	23.06.2011 12:12:00	СМС с напоминанием об окончании договора. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен.	0	True	$Обращение$, действие Вашего полиса КАСКО №$НомерБСО$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ $КудаОращаться$. Спасибо за доверие, СК Согласие, 8 (495) 739 0101	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid))*NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, 0 as SKIP_IF_EMAIL, (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid)) as ADExists, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 2 as id_ext_type, ci.contractid as idx_contract, replace(f.PhoneMobile, ',', ';') AS PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join (select emm.employeeid, emm.dismissal, rank() over(partition by emm.employeeid order by emm.movedate desc) rnk from employeemove emm where emm.movedate < sysdate) emm on emm.employeeid = se.employeeid and emm.rnk = 1 left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and (CASE WHEN to_char(sysdate, 'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND f.PhoneMobile is not null and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 70 WHEN 86 THEN 50 ELSE 1 END DESC	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
3	-1	1	1	2	Выплата	21.01.2011 12:13:00	Отключена 26.11.14 - Анохина / Фурсова. СМС о перечислении выплаты по КАСКО на р/с Клиента	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Убытки с местоположением 'Зам. гл. бухгалтера' и соответствующим полем 'номер счета'. Не суброгация. ТИП ПВУ не равен 1 ('по требованию других СК'). Телефон сначала заявитель, потом страхователь.	0	True	Ваше дело №$НомерУбытка$ передано на оплату. Денежные средства будут зачислены на р/с в течение 5-и банковских дней. С уважением, СК Согласие	SELECT 'STARTSELECT' AS STARTSELECT, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL,3 as id_ext_type, CI.InsurerID as idx_client, PMSL.LossID as id_ext, PMSL.MoveDate, L.Name as LossNumber, PMSL.LossID as idx_loss, LL.Name AS location, PM.NCash,  CI.InsurerID as id_client, CI.InsProductID, replace (ic.declarantphone,',',';') || ';' || replace(f.PhoneMobile, ',', ';') As PhoneMobile, F.Email FROM Sogins.PayMoveStateLocation PMSL INNER JOIN Sogins.LossLocation LL ON LL.LossLocationID = PMSL.LossLocationID INNER JOIN Sogins.PayMovie PM ON PMSL.LossID = PM.LossID INNER JOIN Sogins.LossO L ON PMSL.LossID = L.LossID INNER JOIN sogins.InsCase ic on l.inscaseid=ic.inscaseid INNER JOIN Sogins.ContractIns CI ON L.ContractID = CI.ContractID left join sogins.DamageCompensation dc on dc.inscaseid = ic.inscaseid INNER JOIN Sogins.Face F ON F.FaceID = CI.InsurerID  INNER JOIN Sogins.FacePerson FP ON F.FaceID = FP.FaceID WHERE nvl(L.DIRECTSTLMNTTYPE,0)<>1 AND (CASE WHEN  to_char(sysdate,'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 AND NOT EXISTS (Select 1  From sogins.SubrogationCasco subc Where subc.DamageCompensationID = dc.documentid) AND (PMSL.MoveDate BETWEEN TRUNC(SYSDATE-3, 'dd') AND TRUNC(SYSDATE, 'dd')) AND (LL.LossLocationID = 8) AND (PM.NCash = 'рс' OR PM.NCash = 'р/с' OR PM.NCash = 'РФБ' OR PM.NCash LIKE '%банк%') AND (CI.InsProductID IN ($PRODUCT_SEL$)) ORDER BY CI.InsurerID	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	1
4	-1	1	1	0	Возврат	02.03.2011 12:14:00	СМС, что касса готова осуществить возврат средств по рассторгнутому договору	На основании данных финансового отдела в файле MSExcel 	1	True	Добрый день! Денежные средства по расторгнутому договору №$НомерДоговора$ можете получить в офисе $ОфисВозврата$. С уважением, СК Согласие, 8 (495) 739 0101	SELECT contract_number,record_date,refund_office FROM Refunds WHERE [contract_number] <>CHAR(160)+CHAR(32)+CHAR(160) AND [contract_number]<>'' AND contract_number IS NOT NULL AND record_date >=  DATEADD(dd, - 3, CONVERT(date, GETDATE()))	KPConnString	MSSQL	1	NULL	1	5	20	90	99
5	-1	2	1	0	Расторжение	20.02.2012 10:14:00	Уведомление о рассторжении договора	Ручная печать писем. Диасофт. На основании поля 'Дата расторжения'	0	True	cancellation.dotx	select 'STARTSELECT' AS STARTSELECT, ci.insurerid as idx_client,ci.contractid as id_ext,5 as id_ext_type,ci.contractid as idx_contract, CASE WHEN InStr(adr.address,adr.index_)=0 then adr.index_ || ', ' || adr.address ELSE adr.address END as Address, CASE WHEN InStr(adr.address,adr.index_)=0 then adr.index_ || ', ' || adr.address ELSE adr.address END as Address1,CASE WHEN InStr(adr.address, adr.index_) = 0 then adr.address ELSE trim(substr(adr.address, InStr(adr.address, adr.index_)+length(adr.index_)+2))END as AddressWOIndex, fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO, fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO1, CASE nvl(fp.secondname, '') WHEN '' THEN '' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 1, 2))  WHEN 'ич' THEN 'Уважаемый' WHEN 'на' THEN 'Уважаемая' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 3, 4))  WHEN 'оглы' THEN 'Уважаемый' WHEN 'кызы' THEN 'Уважаемая' ELSE '' END END END  || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as reference, to_char(sysdate,'dd.mm.yyyy') as LetterIssueDate, case os.faceentityid  WHEN 1267 THEN CASE af.entityid WHEN 1001 THEN nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') ELSE  trim(af.name)  END ELSE nvl(efp.lastname, '') || ' ' || nvl(efp.firstname, '') || ' ' ||  nvl(efp.secondname, '') END as Seller, CASE os.faceentityid  WHEN 1267 THEN CASE af.entityid WHEN 1001 THEN CASE  WHEN nvl(af.phonemobile, '0') <> '0' THEN 'тел.: ' || af.phonemobile ELSE CASE WHEN nvl(af.phone2, '0') <> '0' THEN  'тел.: ' || af.phone2 ELSE ' ' END END ELSE  CASE WHEN nvl(af.phone1, '0') <> '0' THEN 'тел.: ' || af.phone1 ELSE ' ' END END ELSE CASE  WHEN nvl(ef.phonemobile, '0') <> '0' THEN  'тел.: ' || ef.phonemobile ELSE CASE WHEN nvl(ef.phone2, '0') <> '0' THEN 'тел.: ' || ef.phone2 ELSE ' ' END END END as SellerPhone, trim(d.number_) as ContractNumber, (SELECT max(p.paydate) AS Expr1 FROM Sogins.Payment p WHERE (ci.contractid = p.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (p.PayDate <= ci.canceldate)) as PayDate, (SELECT max(p.paydate) AS Expr1 FROM Sogins.Payment p WHERE (ci.contractid = p.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (p.PayDate <= ci.canceldate))+30 as XDate, CASE when nvl(io.transportmarkid,0)=0 then ' ' else 'для транспортного средства ' || nvl(tm.name,'') || ' ' || nvl(tmd.name,'') || ' ' end as MarkModel, ci.signdate As SignDate, ip.name as Product from sogins.contractins ci inner join sogins.document d on d.documentid=ci.contractid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face f on ci.insurerid=f.faceid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id  left join sogins.agent sa on sa.agentid = os.faceid  left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.employee se on se.employeeid=os.faceid left join sogins.face ef on ef.faceid=se.faceid left join sogins.faceperson efp on efp.faceid=ef.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid inner join sogins.address adr on adr.faceid=f.faceid left join sogins.insobject io on io.insobjectid=ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid=io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid=io.transportmodelid  where nvl(adr.index_,'0')<>'5'  And adr.addressid =(SELECT max(adr1.addressid) FROM sogins.address adr1 where adr1.faceid = f.faceid and adr1.adresstypeid in (1,2,3) and nvl(adr1.index_, '0') <> '0') and nvl(sa.status,0) IN ($SEL_AGENT_TYPE$) and ci.insproductid IN ($PRODUCT_SEL$) and ci.canceldate between  TRUNC(SYSDATE - $DAYS_LIMIT$, 'dd') AND sysdate and ci.breakreasonrsa IN ($REASON_ID$)	DiasoftConnectionString	ORACLE	1	NULL	0	4	40	0	99
6	-1	2	2	0	ПролонгацияПисьмо	27.02.2012 11:10:00	Письмо с предложением продлить договор	Ручная печать писем. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть почтовыый индекс.	0	True	prolongation.dotx	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, saleofficeid, insproductid, policyno_lv, enddate, validdate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and  seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, ci.contractid as id_ext, '№' || trim(d.number_) as ContractNumber, 0 AS SSB,0 AS external_sys_id, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, nvl(f.PhoneMobile,'0') as PhoneMobile, nvl(f.Email,'0') as Email, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText,f.faceid as idx_client,6 as id_ext_type,ci.contractid as idx_contract, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, CASE WHEN InStr(adr.address,adr.index_)=0 then adr.index_ || ', ' || adr.address ELSE adr.address END as Address,fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO, CASE nvl(fp.secondname, '') WHEN '' THEN '' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 1, 2))  WHEN 'ич' THEN 'Уважаемый' WHEN 'на' THEN 'Уважаемая' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 3, 4))  WHEN 'оглы' THEN 'Уважаемый' WHEN 'кызы' THEN 'Уважаемая' ELSE '' END END END  || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as reference, case os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') ELSE  CASE WHEN nvl(af.nameonprinter,'0')<>'0' THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.nameonprinter) ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.name) END END END ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(efp.lastname, '') || ' ' || nvl(efp.firstname, '') || ' ' ||  nvl(efp.secondname, '') END as Seller, CASE os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN CASE  WHEN nvl(af.phonemobile, '0') <> '0' THEN 'тел.: ' || af.phonemobile ELSE CASE WHEN nvl(af.phone2, '0') <> '0' THEN  'тел.: ' || af.phone2 ELSE ' ' END END ELSE  CASE WHEN nvl(af.phone1, '0') <> '0' THEN 'тел.: ' || af.phone1 ELSE ' ' END END END ELSE CASE  WHEN nvl(ef.phonemobile, '0') <> '0' THEN  'тел.: ' || ef.phonemobile ELSE CASE WHEN nvl(ef.phone2, '0') <> '0' THEN 'тел.: ' || ef.phone2 ELSE ' ' END END END as SellerPhone, CASE when nvl(io.transportmarkid,0)=0 then ' ' else 'на застрахованное Вами транспортное средство ' || nvl(tm.name,'') || ' ' end as MarkModel, CASE WHEN ci.insproductid IN (93,216,86,298) THEN 'auto.gif' ELSE CASE WHEN ci.insproductid IN (136,97,292,332,333) THEN 'property.gif' ELSE  CASE WHEN ci.insproductid IN (88,153) THEN 'dms.gif' ELSE 'default.gif' END END END as ProductIco, ci.validdate As ValidDate,ci.enddate as expiredDate, ip.name as Product, 0 AS ESB from ci inner join sogins.document d on d.documentid=ci.contractid left join sogins.osagosalesoffice oso on oso.saleofficeid=ci.saleofficeid  inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid=ftmp.faceid inner join sogins.face f on f.faceid= nvl(ftmp.mainfaceid,ftmp.faceid) inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id  left join sogins.agent sa on sa.agentid = os.faceid  left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.employee se on se.employeeid=os.faceid left join sogins.face ef on ef.faceid=se.faceid left join sogins.faceperson efp on efp.faceid=ef.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid inner join sogins.address adr on adr.faceid=f.faceid left join sogins.insobject io on io.insobjectid=ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid=io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid=io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and os.faceentityid NOT IN ($SKIP_FaceEntityid$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ and case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) And adr.addressid =(SELECT max(adr1.addressid) FROM sogins.address adr1 where adr1.faceid = f.faceid and adr1.adresstypeid in (1,2,3) and nvl(adr1.index_, '0') <> '0' and nvl(house,' ')<>' ' ) AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiaConnStrForPrinting	ORACLE	1	NULL	0	4	40	0	99
7	-1	3	3	2	Регистрация обращения в СК	10.04.2012 0:00:00	Сообщить Клиенту номер дела УУ		1	True	На основании Вашего обращения зарегистрировано событие №$НомерДела+НомерДелаМаксБД$. Список требуемых документов для урегулирования на  www.soglasie.ru/insurance/	select nvl(ic.number_,'') as LossNumber from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
8	-1	3	3	2	Решение: направление на Южнопортовой	10.04.2012 0:00:00	Сообщить Клиенту о возможности получить направление на ремонт	NULL	1	True	Добрый день, по делу №$НомерДела+НомерДелаМаксБД$ можно получить направление на СТОА 2-й Южнопортовый проезд, дом 18, строение 9, в ПН-ЧТ:9:00-18:00, ПТ:9:00-16:45. С уважением, СК Согласие	select nvl(ic.number_,'') as LossNumber,'$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
9	-1	3	1	2	Предоставить документы на email	10.04.2012 0:00:00	Сообщить Клиенту, что ему необходимо предоставить документы или информацию на почту	NULL	1	True	Для урегулирования Вашего события №$НомерДела+НомерДелаМаксБД$ необходимо предоставить в СК: $ПредоставитьДокументы$ на почту $Email+ДоменEmailБД$, в теме укажите номер дела! С уважением, СК Согласие	select nvl(ic.number_,'') as LossNumber, '$ДоменEmailText$' as DomenEmail from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
10	-1	1	1	1	ПлатежEmail	10.04.2012 0:00:00	Электронное письмо об очередном платеже по договору	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Есть email. Продавец1 штатный сотрудник или агент ФЛ. На основании суммы фактических и плановых платежей на дату	0	True	<table border=0 width=800px style=width:800px;><tr><td><p><b>$Обращение$,</b></p> <p>Благодарим Вас за то, что Вы выбрали страховую компанию «Согласие»!</p><p>$ДатаНачалаДействия$ Вы заключили договор №$НомерДоговораМаркаМодель$ </p><p>Обращаем Ваше внимание на то, что по договору наступает срок очередного платежа в размере $СуммаПлатежа$$ВалютаПлатежа$. Оплату необходимо произвести до $ДатаПлатежа$. </p><p>При появлении вопросов просим Вас связаться с Вашим страховым агентом либо обратиться за консультацией по телефону Компании +7 (495) 739-01-01, 8 (800) 755-00-01.</p><p>Надеемся на Ваше понимание и дальнейшее плодотворное сотрудничество!</p><p><b>С уважением,</br>ООО «СК «Согласие»</b></p><p>Ваш страховой агент</br><b>$Продавец$</b>$ТелефонПродавца$<p>Тел. контактного центра ООО «СК «Согласие»:<br/>8 (800) 755 0001<br/>8 (495) 739 0101</p><p><table border=0 cellpadding=5 width=100%><tr><td colspan=3><b><medium>Почему СК «Согласие» рекомендуют друзьям?</medium></b></td></tr><tr><td><b>Опыт.</b><br>Более 22 лет Страховая Компания «Согласие» стабильно развивается на страховом рынке и осуществляет страхование малого, среднего и крупного бизнеса, государственных учреждений и физических лиц. </td><td><b>Профессионализм.</b><br> СК «Согласие» входит в состав Всероссийского Союза Страховщиков, Российского Союза Автостраховщиков, Национального союза страховщиков ответственности, Национального Союза Агростраховщиков и других ведущих профессиональных и отраслевых объединений.</td><td rowspan=2 width=33% valign=top><img src=http://kupi.soglasie.ru/eportal/Services/css/logo_color.gif></br><b>СК «Согласие» в цифрах:</b><br><li>1993 год – дата основания<li>400 подразделений по всей России<li>31 млрд рублей – объем сборов за 2015 год <li>5,4 млрд рублей – размер уставного капитала<li>23,6 млрд рублей – размер страховых выплат за 2015 год</td></tr><tr><td><b>Надежность.</b></br>СК «Согласие» имеет признание на высоком уровне: рейтинг «А++» (исключительно высокий уровень надежности) агентства «Эксперт РА», а также долгосрочный кредитный рейтинг на уровне «BB-» и рейтинг по национальной шкале на уровне «rusAA-» международного агентства Standard & Poor’s. </td><td><b>Признание.</b></br>Компания является лауреатом Национальной премии в области бизнеса «Компания года» в номинации «Страховая компания», обладателем премии «Финансовая жемчужина России», «Финансовая Элита России» и «Золотая саламандра».</td></tr></table><p><table border=0 cellpadding=5 bgcolor=#dddddd><tr><td>Отзывы о качестве обслуживания ООО «СК «Согласие» и партнеров просим оставлять на сайте <a href=http://www.soglasie.ru target=blank>www.soglasie.ru</a> либо направлять в Отдел по работе с обращениями клиентов на адрес электронной почты <a href=mailto:claims@soglasie.ru>claims@soglasie.ru</a>.</td></tr></table></p></td></tr></table>	SELECT 'STARTSELECT' AS STARTSELECT, $SKIP_IF_MOBILE$ , 10 as id_ext_type, MIN((P.PaymentID)) as id_ext, ci.InsurerID as idx_client, P.ContractInsOID as idx_contract, nvl(f.PhoneMobile,'0') as PhoneMobile, nvl(f.Email,'0') as Email, d.number_ as ContractNumber,to_char(TRUNC(P.paydate,'dd'),'dd.mm.yy') as paydate, (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (P_MUST.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) AS Оплатить, (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) AND (P_IS.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) AS Оплачено FROM Sogins.Payment P INNER JOIN Sogins.ContractIns ci ON P.ContractInsOID = ci.ContractID LEFT JOIN Sogins.Document d ON ci.ContractID = d.DocumentId inner join sogins.osagosellers os on os.sellerid = ci.seller1id  left join sogins.agent sa on sa.agentid = os.faceid  left join sogins.face af on af.faceid = sa.faceid  left join sogins.faceperson afp on afp.faceid = af.faceid  left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.employee se on se.employeeid=os.faceid left join sogins.face ef on ef.faceid=se.faceid left join sogins.faceperson efp on efp.faceid=ef.faceid left join sogins.insobject io on io.insobjectid=ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid=io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid=io.transportmodelid  LEFT JOIN Sogins.Fund Fund ON ci.FundID = Fund.FundID INNER JOIN Sogins.Face f ON f.FaceID = ci.InsurerID INNER JOIN Sogins.FacePerson fp ON f.FaceID = fp.FaceID  WHERE (os.faceentityid=1079 or (os.faceentityid=1267 and sa.status=7)) AND REGEXP_LIKE(nvl(f.email,'0'), '^(([a-z0-9_\-]+\.)*[a-z0-9_\-]+@([a-z0-9][a-z0-9\-]*[a-z0-9]\.)+[a-z]{2,4}\;?)+' || CHR(36),'i') and (nvl(P.IsFact, 0) = 0) AND (P.PaymentCategoryID = 34) AND (P.PayDate BETWEEN TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) AND (ci.InsProductID IN ($PRODUCT_SEL$)) AND (ci.CancelDate IS NULL OR ci.CancelDate > sysdate) AND (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (P_MUST.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) - (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) > 100 and (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE  (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) > 0  GROUP BY P.ContractInsOID, d.Number_, ci.InsurerID, f.PhoneMobile, f.Email, Fund.Brief, P.PayDate, af.entityid, af.name, fp.secondname, fp.lastname, fp.firstname, os.faceentityid, afp.lastname, afp.secondname, afp.firstname,efp.lastname,efp.firstname,efp.secondname, afj.brief, os.sellercode, af.phone1, af.phone2, af.phonemobile,ef.phonemobile,ef.phone2, ci.validdate, tm.name, tmd.name, io.transportmarkid	DiasoftConnectionString	ORACLE	1	NULL	0	2	25	90	99
11	-1	2	1	0	ПлатежПисьмо	18.04.2012 14:43:00	Письмо об очередном платеже по договору	Ручная печать писем. Диасофт. ФЛ. Есть почтовый индекс. На основании суммы фактических и плановых платежей на дату	1	True	installment.dotx	SELECT 'STARTSELECT' AS STARTSELECT, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, 11 as id_ext_type, MIN((P.PaymentID)) as id_ext, ci.InsurerID as idx_client, P.ContractInsOID as idx_contract, nvl(f.PhoneMobile,'0') as PhoneMobile, nvl(f.Email,'0') as Email, Fund.Brief as curr, ci.validdate As ValidDate,d.number_ as ContractNumber, adr.address as Address, adr.address as Address1, trim(d.number_) || CASE when nvl(io.transportmarkid,0)=0 then '' else ' для транспортного средства - ' || nvl(tm.name,'') || ' ' || nvl(tmd.name,'') end || '.' as ContractNumberMarkModel, case os.faceentityid  WHEN 1267 THEN CASE af.entityid WHEN 1001 THEN case  WHEN nvl(af.phone1, '0') <> '0' THEN  'С уважением, ООО «СК «Согласие»' || chr(13) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') || chr(11) || af.phone1 || chr(11) || 'Call-center «СК «Согласие»: +7 (495) 739 01 01 / 8 800 200 01' ELSE case when nvl(af.phone2, '0') <> '0' then   'С уважением, ООО «СК «Согласие»' || chr(13) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') || chr(11) || af.phone2 || chr(11) || 'Call-center «СК «Согласие»: +7 (495) 739 01 01 / 8 800 200 01' else  case when nvl(af.phonemobile, '0') <> '0' then   'С уважением, ООО «СК «Согласие»' || chr(13) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') || chr(11) || af.phonemobile || chr(11) || 'Call-center «СК «Согласие»: +7 (495) 739 01 01 / 8 800 200 01' else  'С уважением, ООО «СК «Согласие»' || chr(13) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') || chr(11) || 'Call-center «СК «Согласие»: +7 (495) 739 01 01 / 8 800 200 01'  END END END ELSE case  WHEN nvl(af.phone1, '0') <> '0' THEN 'С уважением, ' || trim(af.name) || chr(11) || af.phone1 || chr(11) || 'Call-center «СК «Согласие»: +7 (495) 739 01 01 / 8 800 200 01'  ELSE case when nvl(af.phone2, '0') <> '0' then  'С уважением, ' || trim(af.name) || chr(11) || af.phone2 || chr(11) || 'Call-center «СК «Согласие»: +7 (495) 739 01 01 / 8 800 200 01' else  case when nvl(af.phonemobile, '0') <> '0' then  'С уважением, ' || trim(af.name) || chr(11) || af.phonemobile || chr(11) || 'Call-center «СК «Согласие»: +7 (495) 739 01 01 / 8 800 200 01' else  'С уважением, ' || trim(af.name) || chr(11) || 'Call-center «СК «Согласие»: +7 (495) 739 01 01 / 8 800 200 01'  END END END  END  ELSE 'С уважением, ООО «СК «Согласие»' || chr(11) || 'Call-center : +7 (495) 739 01 01 / 8 800 200 01'  END as SellerDetail, CASE nvl(fp.secondname, '') WHEN '' THEN 'Уважаемый(ая)' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 1, 2))  WHEN 'ич' THEN 'Уважаемый' WHEN 'на' THEN 'Уважаемая' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 3, 4))  WHEN 'оглы' THEN 'Уважаемый' WHEN 'кызы' THEN 'Уважаемая' ELSE 'Уважаемый(ая)' END END END  || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as reference, fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO, fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO1, to_char(TRUNC(P.paydate,'dd'),'dd.mm.yy') as paydate,MIN((P.PaymentID)) as PaymentID,   SUM(P.Ammount2) AS InstalmentSum, (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (P_MUST.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) AS Оплатить, (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) AND (P_IS.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) AS Оплачено FROM Sogins.Payment P INNER JOIN Sogins.ContractIns ci ON P.ContractInsOID = ci.ContractID LEFT JOIN Sogins.Document d ON ci.ContractID = d.DocumentId inner join sogins.osagosellers os on os.sellerid = ci.seller1id  left join sogins.agent sa on sa.agentid = os.faceid  left join sogins.face af on af.faceid = sa.faceid  left join sogins.faceperson afp on afp.faceid = af.faceid  left join sogins.facejuridical afj on afj.faceid = af.faceid  left join sogins.insobject io on io.insobjectid=ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid=io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid=io.transportmodelid  LEFT JOIN Sogins.Fund Fund ON ci.FundID = Fund.FundID INNER JOIN Sogins.Face f ON f.FaceID = ci.InsurerID INNER JOIN Sogins.FacePerson fp ON f.FaceID = fp.FaceID inner join sogins.address adr on adr.faceid=f.faceid WHERE nvl(adr.index_,'0')<>'0' AND (nvl(P.IsFact, 0) = 0) AND (P.PaymentCategoryID = 34) AND (P.PayDate BETWEEN TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) AND (ci.InsProductID NOT IN ($PRODUCT_EXCEPTION$)) AND (ci.CancelDate IS NULL OR ci.CancelDate > sysdate) AND (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (P_MUST.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) - (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) > 100 and (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE  (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) > 0 and adr.addressid = (SELECT max(adr1.addressid) from sogins.address adr1 where adr1.faceid=f.faceid and adr1.mainaddroftype=(SELECT max(adr2.mainaddroftype) FROM sogins.address adr2  where adr2.faceid=f.faceid)) GROUP BY P.ContractInsOID, d.Number_, ci.InsurerID, f.PhoneMobile, f.Email, Fund.Brief, P.PayDate, af.entityid, af.name, fp.secondname, fp.lastname, fp.firstname, os.faceentityid, afp.lastname, afp.secondname, afp.firstname, afj.brief, os.sellercode, af.phone1, af.phone2, af.phonemobile, ci.validdate, tm.name, tmd.name, adr.address, io.transportmarkid	DiasoftConnectionString	ORACLE	1	NULL	0	4	50	0	99
12	-1	1	2	1	ПролонгEmail	19.04.2012 9:08:00	Электронное письмо с предложением продлить договор	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть email.	0	True	<table border=0 width=800px style=width:800px;><tr><td><p><b>$Обращение$!</b></p><p>ООО «СК «Согласие» благодарит Вас за доверие нашей Компании и напоминает, что</p><table cellpadding=5><tr><td><img src=http://kupi.soglasie.ru/eportal/Services/ProductIco/$ImageURL$></td><td>$ДатаОкончания$ $МаркаМодель$ истекает срок действия договора $НомерДоговораПолностью$ $Продукт$.</td></tr></table></br>$НомераСвязанныхДоговоров$<p>Для продления договора страхования обратитесь к Вашему страховому агенту или позвоните в контактный центр нашей Компании. <br/>В случае если Вы оформляли договор страхования через партнера нашей Компании, для продления договора Вы так же можете обратиться в офис нашего партнера.</p><p><b>С уважением,</br>ООО «СК «Согласие»</b></p><p><b>$Продавец$</b>$ТелефонПродавца$<p>Тел. контактного центра ООО «СК «Согласие»:<br/>8 (800) 755 0001<br/>8 (495) 739 0101</p><p><b>В Вашей заботе нуждается не только автомобиль, но и Ваш дом, родные и близкие люди.Мы предлагаем Вам специальные программы страхования для обеспечения комплексной защиты:</b></p><table cellpadding=5><tr><td><img src=http://kupi.soglasie.ru/eportal/Services/ProductIco/default.gif></td><td><li>страхование квартир и загородной недвижимости;<li>добровольное медицинское страхование (ДМС);<li>страхование от несчастного случая;<li>страхование путешественников, выезжающих за рубеж и другие.</td></tr></table><p><table border=0 cellpadding=5 ><tr><td colspan=3><b><large>Почему СК «Согласие» рекомендуют друзьям?</large></b></td></tr><tr><td><b>Опыт.</b><br>Более 22 лет Страховая Компания «Согласие» стабильно развивается на страховом рынке и осуществляет страхование малого, среднего и крупного бизнеса, государственных учреждений и физических лиц. </td><td><b>Профессионализм.</b><br> СК «Согласие» входит в состав Всероссийского Союза Страховщиков, Российского Союза Автостраховщиков, Национального союза страховщиков ответственности, Национального Союза Агростраховщиков и других ведущих профессиональных и отраслевых объединений.</td><td rowspan=2 width=33% valign=top><img src=http://kupi.soglasie.ru/eportal/Services/css/logo_color.gif></br><b>СК «Согласие» в цифрах:</b><br><li>1993 год – дата основания<li>400 подразделений по всей России<li>31 млрд рублей – объем сборов за 2015 год<li>5,4 млрд рублей – размер уставного капитала<li>23,6 млрд рублей – размер страховых выплат за 2015 год</td></tr><tr><td><b>Надежность.</b></br>СК «Согласие» имеет признание на высоком уровне: рейтинг «А++» (исключительно высокий уровень надежности) агентства «Эксперт РА», а также долгосрочный кредитный рейтинг на уровне «BB-» и рейтинг по национальной шкале на уровне «rusAA-» международного агентства Standard & Poor’s. </td><td><b>Признание.</b></br>Компания является лауреатом Национальной премии в области бизнеса «Компания года» в номинации «Страховая компания», обладателем премии «Финансовая жемчужина России», «Финансовая Элита России» и «Золотая саламандра».</td></tr></table><p><table border=0 cellpadding=5 bgcolor=#dddddd ><tr><td>Отзывы о качестве обслуживания ООО «СК «Согласие» и партнеров просим оставлять на сайте <a href=http://www.soglasie.ru target=blank>www.soglasie.ru</a>, либо направлять в Отдел по работе с обращениями клиентов на адрес электронной почты <a href=mailto:claims@soglasie.ru>claims@soglasie.ru</a>.</td></tr></table></p></td></tr></table>	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText, (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid=sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid)) as ADExists, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 12 as id_ext_type, ci.contractid as idx_contract, f.PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join (select emm.employeeid, emm.dismissal, rank() over(partition by emm.employeeid order by emm.movedate desc) rnk from employeemove emm where emm.movedate < sysdate) emm on emm.employeeid = se.employeeid and emm.rnk = 1 left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND nvl(f.Email,'0')<>'0' AND case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiasoftConnectionString	ORACLE	1	NULL	0	2	25	90	99
13	-1	1	1	3	ПолисОМС	26.04.2012 9:46:00	СМС с информацией о готовности или отказе изготовления полиса ОМС	Автомат Job Neptune (crm_functions.vbs) 11-00. ОМС. На основании даты создания документа	1	True	Готов полис ОМС на фамилию $ФамлияИО$ Вы можете его получить в офисе подачи заявления. Контактный номер 8 495 730 2090	select 'STARTSELECT' AS STARTSELECT, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, to_char(d.datecreate, 'dd.mm.yyyy') as DateCreated, f.mobile_phone as PhoneMobile, 0 as idx_client, sto.statementid as id_ext, do.insuredid as external_sys_id from sogins.DOCUMENT d inner join sogins.OMS_DOCOMS  do on d.documentid=do.docomsid inner join sogins.oms_statement sto on sto.statementid=do.oms_statementid inner join sogins.oms_insured i on i.insuredid=do.insuredid inner join sogins.oms_insured_hist f on f.insuredid=do.insuredid left join sogins.FaceJuridical fj on fj.faceid = sto.сompany inner join sogins.oms_service_info sio on sio.statementid=sto.statementid where (CASE WHEN  to_char(sysdate,'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 AND nvl(fj.FLAGMFC, 0) = 0 and nvl(d.datereg,sysdate)=sysdate AND do.OMSDOCTYPE = (SELECT codo.CODIFICATIONID FROM sogins.OMS_CODIFICATION codo WHERE VALUE_C = 'Полис ОМС единого образца') and f.statedate=(SELECT MAX(ih1.statedate) from sogins.oms_insured_hist ih1 WHERE ih1.insuredid=do.insuredid) and d.datecreate between TRUNC(SYSDATE - $SHIFT_DAYS$ - $DAYS_MAX$, 'dd') and  TRUNC(SYSDATE - $SHIFT_DAYS$, 'dd')	DiasoftOMSConnectionString	ORACLE	1	NULL	1	5	20	90	14
14	-1	3	1	2	Запрос в банк	28.04.2012 15:59:00	Клиенту необходимо подъехать за запросом в БАНК	NULL	1	True	Для урегулирования Вашего события №$НомерДела+НомерДелаМаксБД$ необходимо получить в офисе СК "Согласие", где Вы подавали заявление, запрос в банк для предоставления подтверждения формы возмещения. С уважением, СК Согласие	select nvl(ic.number_,'') as LossNumber,'$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
15	-1	3	3	2	Запись на осмотр	28.04.2012 16:03:00	Подтверждение записи на эксперизу	NULL	1	True	По событию №$НомерДела+НомерДелаМаксБД$ Вы записаны к экспертам на осмотр ТС по адр. $Адрес+АдресаУУБД$ на $Дата+ДатаСегодняБД$ в $Время$. При себе необходимо иметь все справки из комп.органов, оригинал полиса КАСКО,паспорт,СТС и водит.права. С уважением, СК Согласие	select nvl(ic.number_,'') as LossNumber,'$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
22	-1	3	1	0	Тест	11.05.2012 10:47:00	Маска для эксперимента по заполнению полей	NULL	0	True	Пришлите документ на адрес $Телефон$ руб.	select nvl(ic.number_,'') as LossNumber, '$ДоменEmailText$' as DomenEmail, '$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	0	5	20	90	99
23	-1	3	1	2	Решение: направление согласовано	11.05.2012 16:28:00	Сообщение Клиенту о том, что направление согласовано	NULL	0	True	По Вашему делу согласовано направление на ремонт. Вы можете забрать направление в офисе, где Вы подавали заявление. С уважением, СК Согласие	SELECT 'шаблон для ручной отправки' as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
26	-1	1	1	3	ПолисОМСОтказ	21.05.2012 15:31:00	СМС с информацией о проблеме в процессе изготовления полиса	Автомат Job Neptune (crm_functions.vbs) 11-00. ОМС. На основании поля 'Текст ошибки второго уровня'	1	True	Регистрация полиса на фамилию $ФамлияИО$ приостановлена.Обратитесь к сотруднику Компании. Контактный номер 8 (495) 730 2090	select 'STARTSELECT' AS STARTSELECT, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL,sio.second_level_err as ErrorText,  f.mobile_phone as PhoneMobile, 0 as idx_client, sto.statementid as id_ext, do.insuredid as external_sys_id from sogins.DOCUMENT d inner join sogins.OMS_DOCOMS  do on d.documentid=do.docomsid inner join sogins.oms_statement sto on sto.statementid=do.oms_statementid inner join sogins.oms_insured i on i.insuredid=do.insuredid inner join sogins.oms_insured_hist f on f.insuredid=do.insuredid left join sogins.face fj on fj.faceid=sto.сompany inner join sogins.oms_service_info sio on sio.statementid=sto.statementid where (CASE WHEN  to_char(sysdate,'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 AND nvl(sto.сompany,0)=0 and nvl(sio.second_level_err, '-') <> '-'	DiasoftOMSConnectionString	ORACLE	1	NULL	1	5	20	90	14
27	-1	3	3	2	Документы из ГИБДД	30.05.2012 9:37:00	Информирование о документах, требуемых от ГИБДД	NULL	1	True	Сотрудник ГИБДД должен выдать СФ№154. Также для урегулирования необходимо предоставить протокол, или постановление, или определение о возбуждении или отказе в возбуждении дела. Подробнее см.www.soglasie.ru.	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
28	-1	3	3	2	Вызов АК	30.05.2012 11:24:00	Направляется вручную КЦ, если вызвали АК	NULL	1	True	На место происшествия по вашему обращению вызван Аварийный комиссар. Ориентировочное время прибытия $Время$. С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
29	-1	3	3	2	Документы из ОВД	01.06.2012 12:15:00	Информирование о документах, требуемых от ОВД	NULL	1	True	От ОВД необходимо получить СФ№3, протокол или постановление, или определение о возбуждении или отказе в возбуждении дела. Подробнее о списке требуемых документов см. www.soglasie.ru. 	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
30	-1	3	3	2	Документы от АК	01.06.2012 12:17:00	Информирование о получении документов от АК	NULL	1	True	Аварийный комиссар предоставил в компанию полученные от Вас документы для урегулирования события №$НомерДела$.  Ваше дело передано на рассмотрение. С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
31	-1	3	3	2	Предоставить документы в офис	01.06.2012 12:19:00	Информирование 	NULL	1	True	Для урегулирования Вашего события №$НомерДела+НомерДелаМаксБД$ необходимо предоставить: $ПредоставитьДокументы$ (в офис СК Согласие по адресу $Адрес+АдресаУУБД$. С уважением, СК Согласие 	select nvl(ic.number_,'') as LossNumber,'$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
32	-1	3	1	2	Дело на рассмотрении	01.06.2012 12:36:00	Промежуточное информирование о том, что дело рассматривается	NULL	1	True	Ваше событие №$НомерДела$ находится на рассмотрении. Уведомление о принятом решении Вам будет направлено дополнительно. С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
33	-1	3	1	2	Решение: направление по эл.почте	01.06.2012 12:39:00	Информирование об отправке направления на СТОА	NULL	1	True	По событию №$НомерДела$ отправлено направление на ремонт на $НазваниеСТОа$ по адресу $АдресСТОа$. Позвоните в сервис по телефону $Телефон$. С уважением, СК Согласие 	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
34	-1	3	3	2	Решение: перечислены средства на р/с	01.06.2012 12:58:00	Информирование о перечислении денег на р/с.	NULL	1	True	По Вашему событию $НомерДела$ $Дата$ перечислено страховое возмещение на сумму $Сумма$ $Валюта+СписокВалютБД$ Денежные средства будут зачислены на р/с в течение 5-и банковских дней. С уважением, СК Согласие	SELECT 'руб.;USD;EUR' as CurrBD from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
35	-1	3	3	0	Принято решение о КГ	01.06.2012 13:01:00	Информирование о принятии решения о КГ и о том, что с клиентом свяжутся для определения вариантов урегулирования	NULL	1	True	По Вашему событию №$НомерДела$ принято решение о конструктивной гибели ТС. С вами свяжутся в течение 5-ти дней для дальнейшего урегулирования дела. С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
36	-1	3	3	2	Запись на приём	01.06.2012 13:04:00	Информирование о записи клиента на определенное время на прием в определенный офис	NULL	1	True	По Вашему обращению №$НомерДела+НомерДелаМаксБД$ Вы записаны на прием в офис по адресу $Адрес+АдресаУУБД$  на $Дата$ в $Время$. С уважением, СК Согласие	select nvl(ic.number_,'') as LossNumber,'$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
37	-1	3	3	0	Решение: отказ	01.06.2012 13:11:00	Уведомление об отправке решения	NULL	0	True	По Вашему делу №$НомерДела$ принято решение, в Ваш адрес направлено письмо. С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
38	-1	3	3	2	Уточнить реквизиты	01.06.2012 13:14:00	Произошел возврат средств из бухгалтерии. Необходимо предоставить реквизиты.	NULL	0	True	По Вашему событию №$НомерДела$ произошел возврат денежных средств, просим предоставить уточненные реквизиты в офис либо на почту $СвободныйТекст$. С уважением, СК Согласие	select nvl(ic.number_,'') as LossNumber,'$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
39	-1	3	1	2	Регистрация заявления	01.06.2012 15:28:00	Направляется, когда клиент предоставил в компанию письменное заявление	NULL	1	True	Ваше заявление по событию №$НомерДела$ зарегистрировано $Дата$. Документы переданы на рассмотрение. С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
40	-1	3	1	0	Отправлено ГП	01.06.2012 16:22:00	Информирование о подготовке гарантийного письма	NULL	0	True	По вашему обращению "СК "Согласие" направило гарантийное письмо на оказание услуг в $СвободныйТекст$. За подробной информацией можете обратитсья в это лечебное учреждение. С уважением, СК "Согласие"	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	0	5	20	90	99
41	-1	1	1	2	СтрахСобытие	07.06.2012 0:00:00	Смс заявителю о регистрации страхового события	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт. Страховые события с непустой датой устного заявления	1	True	На основании Вашего обращения зарегистрировано событие №$НомерСобытия$. Список требуемых документов для урегулирования на www.soglasie.ru.	select 'STARTSELECT' AS STARTSELECT, 41 as id_ext_type, ic.number_ as LossNumber, replace(ic.declarantphone, ',', ';') AS PhoneMobile, '' as Email, nvl(ci.insurerid,0) as idx_client,ic.inscaseid as id_ext  from sogins.inscase ic left join sogins.contractins ci on ci.contractid=ic.contractinsid where ic.oraldeclarationdate is not null and (sysdate-ic.datecreate)*24*60 < $MINUTES_INT$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	1
42	-1	1	3	2	НапрСТО_Отправлено	07.06.2012 0:00:00	Смс заявителю о выдаче направления на ремонт	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. CRM. Выданные направления за интервал времени	0	True	Добрый день, по событию №$НомерДела$ $ЧтоСделано$ направление на ремонт на $СТО$ $АдресСто$. Позвоните в сервис по телефону $ТелефонСто$. С уважением, СК Согласие 	select 'STARTSELECT' AS STARTSELECT, 42 as id_ext_type, ic.number_ as LossNumber, replace(ic.declarantphone, ',', ';') AS PhoneMobile,  nvl(ci.insurerid,0) as idx_client, ro."idx_repair_order" as id_ext, l.lossid as idx_loss,  cto."CTO", cto."CTO_address", cto."CTO_phone" from dbo.Repair_orders@kp ro inner join dbo.CTOs@kp cto on cto."idx_CTO" = ro."id_CTO" inner join sogins.inscase ic on ic.number_=ro."LossNumber" left join sogins.contractins ci on ci.contractid=ic.contractinsid left join sogins.losso l on l.inscaseid=ic.inscaseid where ro."order_issue_type" IN (1,3) AND (sysdate-ro."order_date")*24*60 < $MINUTES_INT$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	1
43	-1	1	1	2	РегСтрахДело	09.06.2012 0:00:00	Смс заявителю о регистрации страхового дела	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт. Убытки с непустой датой письменного заявления.	1	True	Добрый день, Ваше заявление по событию №$НомерДела$ зарегистировано. Документы переданы на рассмотрение. Спасибо за доверие, СК Согласие	select 'STARTSELECT' AS STARTSELECT, 43 as id_ext_type, to_char(DeclarationDate,'dd.mm.yy') as Declare, l.detailednumber as LossNumber, replace(ic.declarantphone, ',', ';') AS PhoneMobile, nvl(ci.insurerid,0) as idx_client,l.lossid as id_ext  from sogins.losso l inner join sogins.inscase ic on ic.inscaseid=l.inscaseid left join sogins.contractins ci on ci.contractid=l.contractid where l.declarationdate is not null and (sysdate - l.createdate)<$DAY_INT$ and (0=$ONLY_NOT_TODAY$ OR to_char(l.createdate,'dd.mm.yy')<>to_char(DeclarationDate,'dd.mm.yy'))	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	1
44	-1	3	1	2	Выезд АК (СМС для АК)	19.06.2012 18:11:00	СМС для АК с адресом происшествия	NULL	1	True	СК Согласие: выезд АК по событию №$НомерДела$  $Дата$ в $Время$ $СвободныйТекстНеобяз$ по адресу $Адрес$. Тип события: $СвободныйТекст$. Контакт.лицо: $СвободныйТекст$, тел: $Телефон$, ТС: $СвободныйТекст$, г/н $ГРЗ$.	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
45	-1	3	2	1	Персональный менеджер	10.07.2012 12:51:00	Контакты продавца СК "Согласие"	NULL	1	True	Добрый день! Спасибо за Ваше обращение в СК Согласие. Ваш персональный  менеджер $СвободныйТекст$, тел. для связи (495)739-01-01 доб.$СвободныйТекст$, адрес эл.почты $Email$	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
46	-1	3	3	0	Запись на осмотр (Осаго)	11.07.2012 12:17:00	Запись на осмотр по ОСАГО и ПВУ	NULL	0	True	По событию №$НомерДела$ Вы записаны к экспертам на осмотр ТС по адр. $Адрес$ на $Дата$ в $Время$. При себе необходимо иметь все справки из комп.органов, паспорт,СТС и водит.права. С уважением, СК Согласие 	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
47	-1	3	2	1	Пролонгация: КАСКО, нет телефона	12.07.2012 17:24:00	Отправляется ДПС, если телефона клиента нет в БД	NULL	1	True	$СвободныйТекст$, действие Вашего страхового полиса КАСКО №$СвободныйТекст$ заканчивается $Дата$. Информация о продлении договора у Вашего финансового консультанта $СвободныйТекст$, тел. +7$Телефон$ или 8 495 7390101 доб.($СвободныйТекст$). С уважением, СК «Согласие»	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
48	-1	3	2	1	Пролонгация: ОСАГО, нет телефона	12.07.2012 17:24:00	Отправляется ДПС, если телефона клиента нет в БД	NULL	1	True	$СвободныйТекст$, действие Вашего страхового полиса ОСАГО №$СвободныйТекст$ заканчивается $Дата$. Информация о продлении договора у Вашего финансового консультанта $СвободныйТекст$, тел. +7$Телефон$ или 8 495 7390101 доб.($СвободныйТекст$). С уважением, СК «Согласие» 	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
49	-1	3	2	1	Пролонгация: смена агента	31.07.2012 11:37:00	Отправляется ДПС, если телефон клиента есть в БД и агент изменен по договору	NULL	1	True	$СвободныйТекст$, напоминаем, что информацию по продлению и сопровождению Вашего страхового полиса Вы можете уточнить у Вашего страхового агента $СвободныйТекст$, тел. +7$Телефон$ или 8 495 7390101 доб.($СвободныйТекст$). С уважением, СК «Согласие»	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
50	-1	3	2	3	Жалоба: регистрация	31.07.2012 13:17:00	Оповещение о регистрации жалобы	NULL	1	True	Добрый день. Ваша жалоба зарегистрирована под №$СвободныйТекст$ и обязательно будет рассмотрена. Узнать статус рассмотрения жалобы Вы можете в Отделе по работе с обращениями, позвонив по тел. 8 495 739 0101. С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
51	-1	3	2	0	Жалоба: уточнение номера полиса и убытка	31.07.2012 13:24:00	Направляется сотрудником Отдела по работе с обращениями	NULL	1	True	Добрый день, для рассмотрения жалобы №$СвободныйТекст$ просим Вас уточнить номер полиса и номер убытка. Просим направить эту информацию на claims@soglasie.ru (в теме указать номер убытка). С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
52	-1	3	2	0	Жалоба: уточнение данных	31.07.2012 13:27:00	Направляется сотрудником Отдела по работе с обращениями	NULL	1	True	Добрый день, для рассмотрения жалобы №$СвободныйТекст$ просим Вас уточнить $СвободныйТекстНеобяз$. Просим направить эту информацию на claims@soglasie.ru (в теме указать номер убытка). С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
53	-1	3	2	0	Жалоба: срок рассмотрения	31.07.2012 13:29:00	Ожидаемый срок рассмотрения жалоба	NULL	1	True	Добрый день, ожидаемый срок рассмотрения жалобы №$СвободныйТекст$ составляет $СвободныйТекст$ рабочих дней. По истечении указанного срока уточнить статус рассмотрения жалобы Вы можете в Отделе по работе с обращениями по телефону 8 495 739 0101. С уважением, СК Согласие	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
54	-1	1	3	2	НапрСТО_Подготовлено	31.07.2012 0:00:00	Смс заявителю что направление можно забрать	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. CRM. Выданные направления за интервал времени	0	True	Добрый день, по делу №$НомерДела$ можно получить направление на ремонт по адресу Графский пер. 12А стр.1 в ПН-ЧТ:9:00-18:00, ПТ:9:00-16:45. С уважением, СК Согласие	select 'STARTSELECT' AS STARTSELECT, 54 as id_ext_type, ic.number_ as LossNumber, replace(ic.declarantphone, ',', ';') AS PhoneMobile,  nvl(ci.insurerid,0) as idx_client, ro."idx_repair_order" as id_ext, l.lossid as idx_loss,  cto."CTO", cto."CTO_address", cto."CTO_phone" from dbo.Repair_orders@kp ro inner join dbo.CTOs@kp cto on cto."idx_CTO" = ro."id_CTO" inner join sogins.inscase ic on ic.number_=ro."LossNumber" left join sogins.contractins ci on ci.contractid=ic.contractinsid left join sogins.losso l on l.inscaseid=ic.inscaseid where ro."order_issue_type" IN (2) AND (sysdate-ro."order_date")*24*60 < $MINUTES_INT$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	1
55	-1	1	3	2	ЗапросДокументов	30.08.2012 9:48:00	Смс заявителю о необходимости предоставить недостающие документы	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Документы с датой запроса в интервале. Не суброгация. ТИП ПВУ не равен 1 ('по требованию других СК'). Телефон сначала заявитель, потом страхователь.	1	True	Для урегулирования Вашего события $НомерДела$ необходимо предоставить: $Документы$ (в офис СК "Согласие", где подавалось заявление). 	select 'STARTSELECT' AS STARTSELECT, 55 as id_ext_type, l.lossid AS idx_loss, ic.number_ as LossNumber, nvl(ci.insurerid,0) as idx_client, rdl.requesteddocslossid as id_ext, replace (ic.declarantphone,',',';') || ';' || replace(f.PhoneMobile, ',', ';') As PhoneMobile, rdl.RequestDate from sogins.losso l inner join sogins.inscase ic on ic.inscaseid=l.inscaseid inner join sogins.RequestedDocsLoss rdl on rdl.lossid=l.lossid inner join sogins.RequestedDocs rd on rdl.requesteddocsid=rd.requesteddocsid left join sogins.contractins ci on ci.contractid=l.contractid left join sogins.face f on f.faceid=ci.insurerid left join sogins.DamageCompensation dc on dc.inscaseid = ic.inscaseid where nvl(L.DIRECTSTLMNTTYPE,0)<>1 AND NOT EXISTS (Select 1  From sogins.SubrogationCasco subc Where subc.DamageCompensationID = dc.documentid) and rdl.RequestDate between  TRUNC(SYSDATE - $DAYS_MAX$, 'dd') AND SYSDATE 	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	1
56	-1	2	2	0	ПролонгацияФилиалы	11.09.2012 9:16:00	Письмо с предложением продлить договор	Ручная печать писем. 1C консолидация. ФЛ. Не расторгнут. Полностью оплачен. Есть почтовыый индекс.	1	True	prolongation.dotx	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(100);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempMSG';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, $SKIP_IF_MOBILE$ AS SKIP_IF_MOBILE, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode,CASE IsNull(ub.kol_ub,0) WHEN 0 THEN ''$NoLossText$'' ELSE ''$LossText$'' END as NoLossBlockText, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 56 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', CASE IsNull(kontr.Отчество, '''') WHEN '''' THEN '''' ELSE CASE SUBSTRING(kontr.Отчество, LEN(kontr.Отчество) - 1, 2) WHEN ''ич'' THEN ''Уважаемый'' WHEN ''на'' THEN ''Уважаемая'' ELSE CASE lower(SUBSTRING(kontr.Отчество, LEN(kontr.Отчество) - 3, 4)) WHEN ''оглы'' THEN ''Уважаемый'' WHEN ''кызы'' THEN ''Уважаемая'' ELSE '''' END END END + '' '' + CASE IsNull(kontr.Имя, '''') WHEN '''' THEN '''' ELSE Upper(Left(kontr.Имя,1)) + lower(SUBSTRING(rtrim(kontr.Имя),2,LEN(rtrim(kontr.Имя))-1)) END + '' '' + CASE IsNull(kontr.Отчество, '''') WHEN '''' THEN '''' ELSE IsNull(Upper(Left(kontr.Отчество,1)) + lower(SUBSTRING(rtrim(kontr.Отчество),2,LEN(rtrim(kontr.Отчество))-1)), '''') END AS reference, IsNull(kurator.Наименование, IsNull(ag_ist.Наименование, IsNull(br_ist.Наименование, ''''))) as Seller, IsNull(ag_ist.Телефоны,IsNull(br_ist.Телефоны,'''')) as SellerPhone, REPLACE(IsNull(kontr.Индекс, '''') + '','' + IsNull(kontr.ПочтовыйАдрес, ''''), '',,'', '', '') ''Address'', CASE WHEN vs.Код IN (1311, 501) THEN ''auto.gif'' ELSE CASE WHEN vs.Код IN (1101, 1112) THEN ''property.gif'' ELSE CASE WHEN vs.Код IN (101, 108, 201) THEN ''dms.gif'' ELSE ''default.gif'' END END END ''ProductIco'', ''№'' + RTRIM(ds.Наименование) ''ContractNumber'', ds.ДатаОкончания ''expiredDate'', CASE WHEN LEN(RTRIM(obj.Марка)) = 0 THEN '' '' ELSE ''на застрахованное Вами транспортное средство '' + RTRIM(obj.Марка) + '' '' + RTRIM(obj.Модель) + '' '' END AS MarkModel, RTRIM(vs.Наименование) ''Product'', kurator.Наименование ''Куратор/Сотрудник'', ag_ist.Наименование ''Агент'', ag_ist.Телефоны ''Телефоны аг.'', br_ist.Наименование ''Брокер'', br_ist.Телефоны ''Телефоны бр.'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ and case when LTRIM(RTRIM(kontr.ОПФ))=''0'' then ''ФЛ'' else ''ЮЛ'' END IN ($FACE_TYPE$) and ''d_rep_s''=''d_rep_s''  AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$ AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ПочтовыйАдрес, ''''))>10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	4	40	0	99
57	-1	3	3	2	Выезд АК по Ё-полис (СМС для АК)	13.09.2012 14:06:00	Выезд АК по Ё-полис (СМС для АК)	NULL	1	True	СК Согласие: выезд АК по событию № $НомерДела$ $Дата$ в $Время$ по адресу + тип события $Адрес$. Контактное лицо/ПМ: $СвободныйТекст$, тел: $Телефон$,    ТС: $СвободныйТекст$, г/н: $ГРЗ$.$СвободныйТекстНеобяз$	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
59	-1	1	2	1	ПролонгацияСрок2	19.10.2012 11:30:00	СМС с напоминанием об окончании договора. Срок 2.	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Телефон сначала заявитель по последнему убытку, где тип документа НЕ «Заявление на возмещение вреда» (ИД <> 55), потом страхователь.	0	True	$Обращение$, действие Вашего полиса №$НомерБСО$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ $КудаОращаться$. С уважением, СК Согласие,  8 (495) 739 0101	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, 0 as SKIP_IF_EMAIL, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 59 as id_ext_type, ci.contractid as idx_contract, replace (ic.declarantphone,',',';') || ';' || replace(f.PhoneMobile, ',', ';') AS PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid left join sogins.inscase ic on ic.contractinsid=ci.contractid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join (select emm.employeeid, emm.dismissal, rank() over(partition by emm.employeeid order by emm.movedate desc) rnk from employeemove emm where emm.movedate < sysdate) emm on emm.employeeid = se.employeeid and emm.rnk = 1 left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and (CASE WHEN to_char(sysdate, 'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 AND (ic.inscaseid=(SELECT MAX(ic1.inscaseid) from sogins.inscase ic1 inner join sogins.losso lo1 on lo1.inscaseid=ic1.inscaseid inner join sogins.damagecompensation dc on dc.documentid=lo1.damagecompensationid inner join sogins.document d1 on lo1.damagecompensationid=d1.documentid where  ic1.contractinsid = ci.contractid and d1.documentkindid<>55) or ic.inscaseid is null) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND (ic.declarantphone is not null OR f.PhoneMobile is not null) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 70 WHEN 86 THEN 50 ELSE 1 END DESC	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
60	-1	1	1	1	ПлатежСрок2	28.11.2012 0:00:00	СМС об очередном платеже по договору. Срок 2.	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Продавец1 штатный сотрудник или агент ФЛ. На основании суммы фактических и плановых платежей на дату	0	True	$Обращение$, напоминаем, что по Вашему полису №$НомерДоговораКратко$ необходимо внести очередной платеж в размере $СуммаПлатежа$$ВалютаПлатежа$ в срок до $ДатаПлатежа$. Внести платеж Вы можете в офисе СК Согласие. С уважением, СК Согласие	SELECT 'STARTSELECT' AS STARTSELECT, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL,60 as id_ext_type, MIN((P.PaymentID)) AS id_ext, ci.InsurerID as idx_client, MIN((P.PaymentID)) as PaymentID, P.ContractInsOID AS idx_contract, d.Number_ as Number_, ci.InsurerID as id_client,replace(f.PhoneMobile, ',', ';') AS PhoneMobile , f.Email, Fund.Brief as curr, SUM(P.Ammount2) AS "Очередной платеж", (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (P_MUST.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) AS Оплатить, (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE  (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) AND (P_IS.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) AS Оплачено FROM Sogins.Payment P INNER JOIN Sogins.ContractIns ci ON P.ContractInsOID = ci.ContractID left join sogins.inscase ic on ic.contractinsid=ci.contractid LEFT JOIN Sogins.Document d ON ci.ContractID = d.DocumentId LEFT JOIN Sogins.Fund Fund ON ci.FundID = Fund.FundID INNER JOIN Sogins.Face f ON f.FaceID = ci.InsurerID INNER JOIN Sogins.FacePerson fp ON f.FaceID = fp.FaceID inner join sogins.osagosellers os on os.sellerid=ci.seller1id left join sogins.agent sa on sa.agentid=os.faceid left join sogins.face af on af.faceid=sa.faceid WHERE (os.faceentityid=1079 or (os.faceentityid=1267 and sa.status=7)) AND (CASE WHEN  to_char(sysdate,'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 AND (nvl(P.IsFact, 0) = 0) AND (P.PaymentCategoryID = 34) AND (P.PayDate BETWEEN TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) AND (ci.InsProductID  IN ($PRODUCT_SEL$)) AND (ci.CancelDate IS NULL OR ci.CancelDate > sysdate) and (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 0) AND (PaymentCategoryID = 34) AND (P_MUST.PayDate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd')) GROUP BY ContractInsOID) - (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) > 100 and (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE  (ContractInsOID = P.ContractInsOID) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) > 0 GROUP BY P.ContractInsOID, d.Number_,ci.policyno_lv, ci.InsurerID, f.PhoneMobile, f.Email, Fund.Brief, P.PayDate, fp.secondname, fp.lastname, fp.firstname 	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
61	-1	1	2	1	Пролонгация Рег.Срок1	26.12.2012 13:01:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	False	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. (Тел Филиала) С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
62	-1	1	1	0	Пролонгация Филиалы Email	04.02.2013 17:44:00	Электронное письмо с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00. 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть email.	0	False	<table border=0 width=800px style=width:800px;><tr><td>	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(100);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$  AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$ and  ''d_rep_s''=''d_rep_s''  AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	0	2	25	90	99
63	-1	3	1	0	НоваяМаска	28.02.2013 17:34:00	Описание маски	NULL	0	True	 	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	0	5	20	90	99
64	-1	3	2	0	Пролонгация _ЦО	13.03.2013 13:34:00	оповещение клиента о том, что с ним свяжется персональный менеджер для пролонгации	NULL	1	True	$СвободныйТекст$, действие Вашего страхового полиса  $СвободныйТекст$ № $СвободныйТекст$ заканчивается $Дата$. Вашим персональным менеджером назначена $СвободныйТекст$, которая свяжется с Вами в ближайшее время, тел. 8 495 7390101 доб. $СвободныйТекст$. С уважением, СК «Согласие» 
	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
65	-1	3	1	0	НоваяМаска	25.03.2013 15:23:00	Описание маски	NULL	0	True	 	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	0	5	20	90	99
66	-1	1	2	1	Пролонгация Рег.Срок2	25.03.2013 16:57:00	СМС с напоминанием об окончании договора в филиалах. Срок 2	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	False	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ $КудаОращаться$ С уважением, СК Согласие, 8 800 755-00-01	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(100);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 62 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$  AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$ and  ''d_rep_s''=''d_rep_s''  AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
67	61	1	2	1	Абакан.Продл.Срок1	09.04.2013 15:19:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3902) 305-365 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
68	66	1	2	1	Абакан.Продл.Срок2	09.04.2013 15:19:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3902) 305-365 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
69	61	1	2	1	Архангельск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8182) 65-79-25 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
70	66	1	2	1	Архангельск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8182) 65-79-25 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
71	61	1	2	1	ИжевскПродл.Срок1 (быв. Астрахань)	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$. Информация о продлении у Вашего страхового агента или по тел. 8 (3412) 912-912 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
72	66	1	2	1	ИжевскПродл.Срок2 (быв. Астрахань)	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$. Информация о продлении у Вашего страхового агента или по тел. 8 (3412) 912-912 Спасибо за доверие, СК «Согласие». 	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
73	61	1	2	1	Барнаул.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3852) 72-07-20 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
74	66	1	2	1	Барнаул.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3852) 72-07-20 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
75	61	1	2	1	Белгород.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4722) 30-07-03 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
76	66	1	2	1	Белгород.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4722) 30-07-03 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
77	61	1	2	1	Благовещенск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4162) 77-07-80 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
78	66	1	2	1	Благовещенск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4162) 77-07-80 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
79	61	1	2	1	Брянск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4832) 62-16-84 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
80	66	1	2	1	Брянск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4832) 62-16-84 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
81	61	1	2	1	Великий новгород.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8162) 22-00-73 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
82	66	1	2	1	Великий новгород.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8162) 22-00-73 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
83	61	1	2	1	Владивосток.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (423) 245-01-42 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
84	66	1	2	1	Владивосток.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (423) 245-01-42 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
85	61	1	2	1	Владимир.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4922) 52-05-30 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
86	66	1	2	1	Владимир.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4922) 52-05-30 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
87	61	1	2	1	Волгоград.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8442) 23-98-58  С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
88	66	1	2	1	Волгоград.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8442) 23-98-58  С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
89	61	1	2	1	Воронеж.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (473) 255-53-89 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
90	66	1	2	1	Воронеж.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (473) 255-53-89 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
91	61	1	2	1	Екатеринбург.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (343) 287-11-00 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
92	66	1	2	1	Екатеринбург.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (343) 287-11-00 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
93	61	1	2	1	Иркутск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(3952)50-07-60 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
94	66	1	2	1	Иркутск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(3952)50-07-60 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
95	61	1	2	1	Йошкар-ола.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(8362)72-39-62 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
96	66	1	2	1	Йошкар-ола.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(8362)72-39-62 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
97	61	1	2	1	Казань.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (843) 238-73-87 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
98	66	1	2	1	Казань.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (843) 238-73-87 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
99	61	1	2	1	Калининград.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4012) 66-90-20 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
100	66	1	2	1	Калининград.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4012) 66-90-20 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
101	61	1	2	1	Калуга.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4842) 77-47-27 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
102	66	1	2	1	Калуга.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4842) 77-47-27 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
103	61	1	2	1	Киров.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8332) 51-24-41 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
104	66	1	2	1	Киров.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8332) 51-24-41 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
105	61	1	2	1	Курск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4712) 51-09-93 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
106	66	1	2	1	Курск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4712) 51-09-93 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
107	61	1	2	1	Курган.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3522) 46-69-60 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
108	66	1	2	1	Курган.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3522) 46-69-60 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
109	61	1	2	1	Кызыл.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (39422) 2-48-28 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
110	66	1	2	1	Кызыл.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (39422) 2-48-28 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
111	61	1	2	1	Липецк.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	1	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4742) 22-36-47. Спасибо за доверие, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
112	66	1	2	1	Липецк.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4742) 22-36-47 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
113	61	1	2	1	Магнитогорск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3519) 46-53-33 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
114	66	1	2	1	Магнитогорск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3519) 46-53-33 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
115	61	1	2	1	Майкоп.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8772) 52-04-04 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
116	66	1	2	1	Майкоп.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8772) 52-04-04 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
117	61	1	2	1	Махачкала.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8722)55-37-37 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
118	66	1	2	1	Махачкала.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8722)55-37-37 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
119	61	1	2	1	Нальчик.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8662) 40-46-39 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
120	66	1	2	1	Нальчик.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8662) 40-46-39 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
121	61	1	2	1	Новороссийск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8617) 67-19-67 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
122	66	1	2	1	Новороссийск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8617) 67-19-67 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
123	61	1	2	1	Новосибирск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (383) 209-14-14 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
124	66	1	2	1	Новосибирск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (383) 209-14-14 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
125	61	1	2	1	Норильск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3919) 42-98-18 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
126	66	1	2	1	Норильск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3919) 42-98-18 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
127	61	1	2	1	Омск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3812) 31-63-38 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
128	66	1	2	1	Омск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3812) 31-63-38 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
129	61	1	2	1	Оренбург.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3532) 99-53-41 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
130	66	1	2	1	Оренбург.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3532) 99-53-41 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
131	61	1	2	1	Орёл.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4862) 42-17-51 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
132	66	1	2	1	Орёл.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4862) 42-17-51 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
133	61	1	2	1	Пенза.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8412) 68-11-88 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
134	66	1	2	1	Пенза.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8412) 68-11-88 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
135	61	1	2	1	Петрозаводск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8142) 78-21-91 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
136	66	1	2	1	Петрозаводск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8142) 78-21-91 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
137	61	1	2	1	Петропавловск-камчатский.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4152) 25-25-53 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
138	66	1	2	1	Петропавловск-камчатский.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4152) 25-25-53 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
139	61	1	2	1	Псков.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8112)72-16-48 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
140	66	1	2	1	Псков.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8112)72-16-48 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
141	61	1	2	1	Ростов-на-дону.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (863)219-80-01 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
142	66	1	2	1	Ростов-на-дону.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (863)219-80-01 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
143	61	1	2	1	Рязань.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4912) 25-62-84 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
144	66	1	2	1	Рязань.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4912) 25-62-84 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
145	61	1	2	1	Саранск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8342) 24-31-55 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
146	66	1	2	1	Саранск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8342) 24-31-55 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
147	61	1	2	1	Саратов.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8452) 79-00-80 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
148	66	1	2	1	Саратов.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8452) 79-00-80 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
149	61	1	2	1	Северодвинск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8184) 56-08-00 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
150	66	1	2	1	Северодвинск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8184) 56-08-00 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
151	61	1	2	1	Смоленск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4812) 35-17-50 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
152	66	1	2	1	Смоленск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4812) 35-17-50 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
153	61	1	2	1	Ставрополь.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8652) 26-17-11 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
154	66	1	2	1	Ставрополь.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8652) 26-17-11 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
155	61	1	2	1	Сургут.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3462) 93-25-62 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
156	66	1	2	1	Сургут.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3462) 93-25-62 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
157	61	1	2	1	Сыктывкар.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8212) 30-26-60 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
158	66	1	2	1	Сыктывкар.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8212) 30-26-60 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
159	61	1	2	1	Тамбов.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4752) 72-10-13 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
160	66	1	2	1	Тамбов.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4752) 72-10-13 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
161	61	1	2	1	Тверь.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4822) 63-10-01 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
162	66	1	2	1	Тверь.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4822) 63-10-01 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
163	61	1	2	1	Темрюк.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (86148) 6-04-82 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
164	66	1	2	1	Темрюк.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (86148) 6-04-82 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
165	61	1	2	1	Томск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3822) 51-11-51 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
166	66	1	2	1	Томск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3822) 51-11-51 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
167	61	1	2	1	Тула.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4872) 703-700 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
168	66	1	2	1	Тула.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4872) 703-700 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
169	61	1	2	1	Тюмень.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3452) 50-00-51 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
170	66	1	2	1	Тюмень.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3452) 50-00-51 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
171	61	1	2	1	Улан-удэ.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3012) 35-38-08 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
172	66	1	2	1	Улан-удэ.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3012) 35-38-08 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
173	61	1	2	1	Ульяновск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8422) 67-60-61 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
174	66	1	2	1	Ульяновск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (8422) 67-60-61 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
175	61	1	2	1	Уфа.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (347) 241-61-58 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
176	66	1	2	1	Уфа.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (347) 241-61-58 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
177	61	1	2	1	Хабаровск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4212) 41-01-10 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
178	66	1	2	1	Хабаровск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4212) 41-01-10 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
179	61	1	2	1	Челябинск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (351) 211-43-10 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
180	66	1	2	1	Челябинск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (351) 211-43-10 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
181	61	1	2	1	Чита.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3022) 44-10-11 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
182	66	1	2	1	Чита.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (3022) 44-10-11 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
183	61	1	2	1	Якутск.Продл.Срок1	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4112) 43-50-78 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
184	66	1	2	1	Якутск.Продл.Срок2	09.04.2013 15:23:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4112) 43-50-78 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
185	-1	1	3	2	СообщениеДляАварком	15.04.2013 14:24:00	Смс аваркому с адресом выезда	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД.	1	True	$ТекстСообщения$	select 'STARTSELECT' AS STARTSELECT, 185 as id_ext_type, N_PHONE AS PhoneMobile,  0 as idx_client,id as external_sys_id, DOCUMENT_ID as id_ext, 0 as idx_loss from lib.sms_message@DIASOFT WHERE CRM_DISTRIBUTION_ID=185 AND (sysdate-D_CREATE)*24*60 < $MINUTES_INT$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	1
186	-1	1	3	2	НаправлениеИзСЭД	21.05.2013 11:18:00	Создано направление в СЭД	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД.	1	True	$ТекстСообщения$	select 'STARTSELECT' AS STARTSELECT, 186 as id_ext_type, N_PHONE AS PhoneMobile,  0 as idx_client,id as external_sys_id, DOCUMENT_ID as id_ext, 0 as idx_loss from lib.sms_message@DIASOFT WHERE CRM_DISTRIBUTION_ID=186 AND (sysdate-D_CREATE)*24*60 < $MINUTES_INT$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	1
190	61	1	2	1	Магадан.Продл.Срок1	17.07.2013 13:43:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(4132)62-13-00 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
191	66	1	2	1	Магадан.Продл.Срок2	17.07.2013 13:43:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(4132)62-13-00 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
192	61	1	2	1	Санкт-петербург.Продл.Срок1	17.07.2013 13:43:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(812)326-13-06 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
193	66	1	2	1	Санкт-петербург.Продл.Срок2	17.07.2013 13:43:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(812)326-13-06 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
194	61	1	2	1	Ярославль.Продл.Срок1	17.07.2013 13:43:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(4852)73-91-79 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
195	66	1	2	1	Ярославль.Продл.Срок2	17.07.2013 13:43:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8(4852)73-91-79 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
196	61	1	2	1	Краснодар.Продл.Срок1	19.08.2013 13:44:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (861) 299-01-54 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
197	66	1	2	1	Краснодар.Продл.Срок2	19.08.2013 13:44:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (861) 299-01-54 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
198	-1	1	1	3	ПолисОМСОтказПаспорт	09.10.2013 14:31:00	СМС с информацией о проблеме в процессе изготовления полиса	Автомат Job Neptune (crm_functions.vbs) 11-00. ОМС. На основании поля 'Текст ошибки второго уровня'	1	True	Выпуск полиса ОМС на фамилию $ФамлияИО$ не возможен: просрочен паспорт. Справки по тел.(495) 730-2090	select 'STARTSELECT' AS STARTSELECT, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, fle.err_text as ErrorText, f.mobile_phone as PhoneMobile, 0 as idx_client, sto.statementid as id_ext, do.insuredid as external_sys_id, sto.сompany, fle.insuredid from sogins.DOCUMENT d inner join sogins.OMS_DOCOMS do on d.documentid = do.docomsid inner join sogins.oms_statement sto on sto.statementid = do.oms_statementid inner join sogins.oms_insured i on i.insuredid = do.insuredid inner join sogins.oms_insured_hist f on f.insuredid = do.insuredid inner join sogins.firstlevelerr fle on fle.claimid = sto.statementid where (CASE WHEN to_char(sysdate, 'D') IN (1,2,3,4,5,6,7) THEN 1 else 0 END) = 1 and fle.err = 'L3'	DiasoftOMSConnectionString	ORACLE	1	NULL	1	5	20	90	14
199	-1	4	1	4	RuRU.Init.SOAP	06.12.2013 0:00:00	Серверный запрос Init к сервису RuRu (Инициализация транзакции)	Автомат Job Neptune (WS5min.vbs) каждые 5 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ser="http://ruru.ru/serviceprovider/">
<soapenv:Header/>
<soapenv:Body>
<ser:Init>
<ser:spTrnDate>$ДатаЗапроса$</ser:spTrnDate>
<ser:phone>$НомерТелефона$</ser:phone>
<ser:info> за страхование на 1 год квартиры на $Сумма$ т.р. по адресу: $Город$ $Улица$ д. $Дом$ кв $Квартира$. Условия: www.soglasie.ru/bee за год стоимость $ПремияИтог$ руб. в рублях в день </ser:info>
<ser:spAccount>$НомерТелефона$</ser:spAccount>
<ser:productId>30125</ser:productId>
<ser:amount>$ПремияКоп$</ser:amount>
<ser:spId>1367</ser:spId>
</ser:Init>
</soapenv:Body>
</soapenv:Envelope>
	select DISTINCT 'STARTSELECT' AS STARTSELECT, $NextStatusID$ as NextStatusID, do.docofferid as id_ext,  f.name, do.insurerid as idx_client from sogins.docoffer do inner join sogins.contractinsgeneral cg on cg.contractid=do.contractinsgeneralid inner join sogins.face f on f.faceid=do.insurerid inner join sogins.OfferObject oo on oo.docofferid=do.docofferid inner join sogins.insobject io on io.insobjectid=oo.insobjectid inner join sogins.address adr on adr.addressid=io.addressid left join  sogins.kladr k on (k.coderegion=adr.coderegion and k.codezone=adr.codezone and k.codecity=adr.codecity and k.codeplace=adr.codeplace and k.codeizm='00')  left join sogins.street s on s.code = SUBSTR(k.code,1,11) || adr.codestreet || '00' where do.statusid=$StatusID$ and cg.insproductid=$PRODUCT_SEL$ and (k.actualdate = (SELECT MAX(k1.actualdate) from sogins.kladr k1 where k1.coderegion=adr.coderegion and k1.codezone=adr.codezone and k1.codecity=adr.codecity and k1.codeplace=adr.codeplace and k1.codeizm='00') )	DiasoftConnectionString	ORACLE	2	http://ruru.ru/serviceprovider/ITransactionService/Init	1	7	20	90	1318
200	-1	5	1	5	RuRU.AutoPayment.SFTP	13.01.2014 0:00:00	Загрузка файла шаблона автоплатежа	Автомат Job Neptune (WS5min.vbs) каждые 5 мин. Диасофт	1	True	<?xml version="1.0" encoding="utf-8"?>
<AutoPaymentRequests>
  <Template>
    <OperatingAccount>$ИДТранзакции$</OperatingAccount>
<CorrespondentAccount>$ИДДоговора$</CorrespondentAccount>
    <Name>1367soglasie</Name>
    <CTN>$НомерТелефона$</CTN>
    <Reference>$Премия$</Reference>
    <scheduleType>Day</scheduleType>
    <schedule isactive="1">
      <startdate>$ДатаНачала$</startdate>
      <enddate>$ДатаОкончания$</enddate>
        <period periodtype="weekday">
                <el>1</el>
                <el>2</el>
                <el>3</el>
                <el>4</el>
                <el>5</el>
                <el>6</el>
                <el>7</el>
            </period>
            <sms isactive="0"></sms>
    </schedule>
  </Template>
</AutoPaymentRequests>
	select 'STARTSELECT' AS STARTSELECT, '$SFTPDir$ir_$SPID$_' || to_char(sysdate,'yyyymmddhh24mm') || '_' || do.docofferid || '.xml' as FileName, '$SFTPDir$' as SFTPDir, $NextStatusID$ as NextStatusID, do.docofferid as id_ext,  f.name, do.insurerid as idx_client from sogins.docoffer do inner join sogins.contractinsgeneral cg on cg.contractid=do.contractinsgeneralid inner join sogins.face f on f.faceid=do.insurerid where do.statusid=$StatusID$ and cg.insproductid=$PRODUCT_SEL$	DiasoftConnectionString	ORACLE	3	NULL	1	6	20	90	1318
202	-1	5	1	5	RuRU.CancelAutoPayment.SFTP	04.02.2014 15:10:00	Загрузка файла шаблона для отмены автоплатежа	Автомат Job Neptune (WS5min.vbs) каждые 5 мин. Диасофт	1	True	<?xml version="1.0" encoding="utf-8"?>
<AutoPaymentCancelRequests>
  <Template>
    <Name>1367soglasie</Name>
    <CTN>$НомерТелефона$</CTN>
  </Template>
</AutoPaymentCancelRequests>
	select 'STARTSELECT' AS STARTSELECT, '$SFTPDir$cr_$SPID$_' || to_char(sysdate,'yyyymmddhh24mm') || '_' || do.docofferid || '.xml' as FileName, $NextStatusID$ as NextStatusID, to_char(sysdate+1,'yyyy-mm-dd hh:mi:ss') as XDate, do.docofferid as id_ext,  f.name, do.insurerid as idx_client from sogins.docoffer do inner join sogins.contractinsgeneral cg on cg.contractid=do.contractinsgeneralid inner join sogins.face f on f.faceid=do.insurerid where do.statusid=$StatusID$ and cg.insproductid=$PRODUCT_SEL$	DiasoftConnectionString	ORACLE	3	NULL	1	6	20	90	1318
203	-1	5	1	5	RuRU.Report.SFTP	05.02.2014 14:38:00	Получение отчета по транзакциям RuRu	Автомат Job Neptune (RuRuReport.vbs) ежедневно. SFTP RuRu	1	True	Данный тип коммуникации не подразумевает текста сообщения	select 'STARTSELECT' AS STARTSELECT,'$SPID$rkh' || to_char(sysdate,'yyyy-mm-dd') || '.xml' as FileName, 0 as idx_client, '$SFTPDir$' as SFTPDir, '$WSURL$' as WSURL, '$WSMethod$' as WSMethod, '$TemplateID$' as TemplateID, '$ProviderLogin$' as ProviderLogin,'$ProviderPwd$' as ProviderPwd, '$LocalDir$' as LocalDir  from dual	DiasoftConnectionString	ORACLE	3	NULL	1	6	20	90	1318
204	-1	4	1	4	RuRu.RestartTransactions	14.02.2014 11:18:00	Возврат незавершенных транзакций на стадию Init (например, для случая временной недоступности нашего слушателя)	Автомат Job Neptune (WS5min.vbs) каждые 5 мин. Диасофт	1	True	DELETE FROM CommContent WHERE (id_event IN (SELECT idx_lossEvent FROM LossEventsInfo WHERE (DistrAsUsedID = 199))) AND (id_content = ''$ИДДоговора$'')	select 'STARTSELECT' AS STARTSELECT, $NextStatusID$ as NextStatusID, do.docofferid as id_ext,  f.name, do.insurerid as idx_client, do.transactionid, (sysdate-d.datecreate)*24*60 minu from sogins.docoffer do inner join sogins.contractinsgeneral cg on cg.contractid=do.contractinsgeneralid inner join document d on d.documentid=do.docofferid inner join sogins.face f on f.faceid=do.insurerid where do.statusid=$StatusID$ and cg.insproductid=$PRODUCT_SEL$ and (CASE WHEN do.transactionid is null then 0 else 1 END) <= (1 - $ONLY_NULL_TRANSACTION$) and (sysdate-d.datecreate)*24*60 between $MIN_MINUTE$ and  $MAX_MINUTE$	DiasoftConnectionString	ORACLE	1	NULL	1	8	20	90	1318
205	-1	1	1	3	СообщениеDIALIFE 	20.06.2014 15:55:00	Сообщение из БД DIALIFE	Автомат Job Neptune (crm_functions.vbs) 11-00. DIALIFE.	1	True	$ТекстСообщения$	select 'STARTSELECT' AS STARTSELECT, 205 as id_ext_type, 0 as idx_client, ot.outmessageid as external_sys_id, ot.outmessageid as id_ext,  ot.body TEXT, ot.receiver AS PhoneMobile, ot.senddate SENDDATE, ot.insertdatetime CREATEDATE, otk.name MESSAGEKIND from soglife.outmessage ot inner join soglife.outmessagekind otk on otk.outmessagekindid = ot.outmessagekindid where Otk.BRIEF <> 'ОтправкаПароля' and otk.sendchannel = 1 and (sysdate-ot.INSERTDATETIME) < $MINUTES_INT$	DiasoftLIFEConnectionString	ORACLE	1	NULL	1	5	20	90	1
206	-1	1	1	0	Рассторжение оферты	01.07.2014 12:17:00	Сообщение о прекращении действия оферты	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	0	True	Уважаемый клиент, договор страхования по программе «Мобильный полис» расторгнут, оплата прекращена.	select DISTINCT 'STARTSELECT' AS STARTSELECT, 206 as id_ext_type, do.policyno AS PhoneMobile, do.docofferid as id_ext, do.insurerid as idx_client, 0 as idx_loss  from sogins.docoffer do  inner join sogins.contractinsgeneral cg on cg.contractid = do.contractinsgeneralid where (sysdate - do.canceldate)< $DAY_INT$ and do.statusid = $StatusID$  and cg.insproductid = $PRODUCT_SEL$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
207	-1	1	1	0	АндерЗаявкаТестБД	05.08.2014 16:46:00	Уведомление о статусе заявки на согласование	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	0	True	По заявке $НомерЗаявки$ от $ДатаВремя$ вынесено решение: $Статус$	SELECT 'STARTSELECT' AS STARTSELECT, 207 as id_ext_type,  b.uwbidid as idx_client,  to_char(h.createdate, 'ddmmyyyyhh24miss') as id_ext, 0 as idx_loss, b.initiatormob as PhoneMobile, b.initiatoremail as Email FROM sogins.uwbid b JOIN sogins.uwbid_hist h ON b.uwbidid = h.uwbidid WHERE b.isactive = 0 AND CAST(XMLTYPE(h.snapshotdata).EXTRACT('//status/text()').getStringVal() as NUMBER(1)) <> 3 and (sysdate - h.createdate) * 24 <= $HOURS_INT$	DiasoftTestingConnectionString	ORACLE	1	NULL	1	5	20	90	99
208	-1	1	2	1	АндерЗаявкаEmailТестДБ	05.08.2014 16:46:00	Электронное письмо с информацией по заявке	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	0	True	По заявке $НомерЗаявки$ от $ДатаВремя$ вынесено решение: $Статус$ 
<br>
Комментарий согласующего:  $Комментарий$	SELECT 'STARTSELECT' AS STARTSELECT, 208 as id_ext_type, b.uwbidid as idx_client, to_char(b.sentdate,'ddmmyyyyhh24miss') as id_ext, 0 as idx_loss,  b.initiatormob as PhoneMobile, nvl(b.initiatoremail,'0') as Email  FROM sogins.uwbid b JOIN sogins.uwbid_hist h ON b.uwbidid = h.uwbidid WHERE b.isactive = 0 AND CAST(XMLTYPE(h.snapshotdata).EXTRACT('//status/text()').getStringVal() as NUMBER(1)) <> 3 and (sysdate - h.createdate) * 24 <= $HOURS_INT$ AND REGEXP_LIKE(nvl(b.initiatoremail,'0'), '^(([a-z0-9_\-]+\.)*[a-z0-9_\-]+@([a-z0-9][a-z0-9\-]*[a-z0-9]\.)+[a-z]{2,4}\;?)+' || CHR(36),'i')	DiasoftTestingConnectionString	ORACLE	1	NULL	1	2	25	90	99
210	6	2	2	0	ИмуществоПролонгПисьмо	24.09.2014 14:00:00	Письмо с предложением продлить договор	Ручная печать писем. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть почтовыый индекс.	0	True	mortgage_prolong.dotx	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, saleofficeid, insproductid, policyno_lv, enddate, validdate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, ci.contractid as id_ext, '№' || trim(d.number_) as ContractNumber, 0 AS SSB,0 AS external_sys_id, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, nvl(f.PhoneMobile,'0') as PhoneMobile, nvl(f.Email,'0') as Email, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText,f.faceid as idx_client,210 as id_ext_type,ci.contractid as idx_contract, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, CASE WHEN InStr(adr.address,adr.index_)=0 then adr.index_ || ', ' || adr.address ELSE adr.address END as Address,fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO, CASE nvl(fp.secondname, '') WHEN '' THEN '' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 1, 2))  WHEN 'ич' THEN 'Уважаемый' WHEN 'на' THEN 'Уважаемая' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 3, 4))  WHEN 'оглы' THEN 'Уважаемый' WHEN 'кызы' THEN 'Уважаемая' ELSE '' END END END  || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as reference, case os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') ELSE  CASE WHEN nvl(af.nameonprinter,'0')<>'0' THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.nameonprinter) ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.name) END END END ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(efp.lastname, '') || ' ' || nvl(efp.firstname, '') || ' ' ||  nvl(efp.secondname, '') END as Seller, CASE os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN CASE  WHEN nvl(af.phonemobile, '0') <> '0' THEN 'тел.: ' || af.phonemobile ELSE CASE WHEN nvl(af.phone2, '0') <> '0' THEN  'тел.: ' || af.phone2 ELSE ' ' END END ELSE  CASE WHEN nvl(af.phone1, '0') <> '0' THEN 'тел.: ' || af.phone1 ELSE ' ' END END END ELSE CASE  WHEN nvl(ef.phonemobile, '0') <> '0' THEN  'тел.: ' || ef.phonemobile ELSE CASE WHEN nvl(ef.phone2, '0') <> '0' THEN 'тел.: ' || ef.phone2 ELSE ' ' END END END as SellerPhone, CASE when nvl(io.transportmarkid,0)=0 then ' ' else 'на застрахованное Вами транспортное средство ' || nvl(tm.name,'') || ' ' end as MarkModel, CASE WHEN ci.insproductid IN (93,216,86,298) THEN 'auto.gif' ELSE CASE WHEN ci.insproductid IN (136,97,292,332,333) THEN 'property.gif' ELSE  CASE WHEN ci.insproductid IN (88,153) THEN 'dms.gif' ELSE 'default.gif' END END END as ProductIco, ci.validdate As ValidDate,ci.enddate as expiredDate, ip.name as Product, 0 AS ESB from ci inner join sogins.document d on d.documentid=ci.contractid left join sogins.osagosalesoffice oso on oso.saleofficeid=ci.saleofficeid  inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid=ftmp.faceid inner join sogins.face f on f.faceid= nvl(ftmp.mainfaceid,ftmp.faceid) inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id  left join sogins.agent sa on sa.agentid = os.faceid  left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.employee se on se.employeeid=os.faceid left join sogins.face ef on ef.faceid=se.faceid left join sogins.faceperson efp on efp.faceid=ef.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid inner join sogins.address adr on adr.faceid=f.faceid left join sogins.insobject io on io.insobjectid=ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid=io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid=io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) And adr.addressid =(SELECT max(adr1.addressid) FROM sogins.address adr1 where adr1.faceid = f.faceid and adr1.adresstypeid in (1,2,3) and nvl(adr1.index_, '0') <> '0' and nvl(house,' ')<>' ' ) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiaConnStrForPrinting	ORACLE	1	NULL	0	4	40	0	99
211	-1	1	1	0	АндерЗаявка	19.12.2014 9:42:00	СМС заявителю об изменении статуса заявки СОА	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	1	True	По заявке $НомерЗаявки$ от $ДатаВремя$ вынесено решение: $Статус$	SELECT 'STARTSELECT' AS STARTSELECT, 211 as id_ext_type, b.uwbidid as idx_client, to_char(h.createdate, 'ddmmyyyyhh24miss') as id_ext, 0 as idx_loss, b.initiatormob as PhoneMobile, '' as Email FROM sogins.uwbid b JOIN sogins.uwbid_hist h ON b.uwbidid = h.uwbidid WHERE B.ISREAD = 0 AND H.STATUS in (1,2,4,6,7) AND H.CREATEDATE=(select max(hm.CREATEDATE) from UWBID_HIST hm where hm.UWBIDID=H.UWBIDID and hm.STATUS in (1,2,4,6,7)) and B.INITIATORMOB is not null and (sysdate - h.createdate) * 24 <= $HOURS_INT$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
212	-1	1	2	1	АндерЗаявкаEmail	19.12.2014 9:44:00	Электронное письмо заявителю об изменении статуса заявки СОА	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	1	True	Текст сообщения:  По заявке $НомерЗаявки$ от $ДатаВремя$ вынесено решение: $Статус$.<br>Комментарий согласующего:  $Комментарий$	SELECT 'STARTSELECT' AS STARTSELECT, 212 AS id_ext_type, b.uwbidid AS idx_client, TO_CHAR (h.createdate, 'ddmmyyyyhh24miss') AS id_ext, 0 AS idx_loss, '' AS PhoneMobile, NVL (b.initiatoremail, '0') AS Email FROM sogins.uwbid b JOIN sogins.uwbid_hist h ON b.uwbidid = h.uwbidid WHERE B.ISREAD = 0 AND H.STATUS in (1,2,4,6,7) AND H.CREATEDATE=(select max(hm.CREATEDATE) from UWBID_HIST hm where hm.UWBIDID=H.UWBIDID and hm.STATUS in (1,2,4,6,7)) AND REGEXP_LIKE (NVL (b.initiatoremail, '0'), '^(([a-z0-9_\-]+\.)*[a-z0-9_\-]+@([a-z0-9][a-z0-9\-]*[a-z0-9]\.)+[a-z]{2,4}\;?)+' || CHR (36), 'i') and (sysdate - h.createdate) * 24 <= $HOURS_INT$ 	DiasoftConnectionString	ORACLE	1	NULL	1	2	25	90	99
214	205	1	1	3	СообщениеDIALIFEPsw	25.03.2015 9:51:00	Сообщение отправки пароля из БД DIALIFE	Автомат Job Neptune (Comm5min.vbs) каждые 3 мин. DIALIFE.	1	True	$ТекстСообщения$	select 'STARTSELECT' AS STARTSELECT, 214 as id_ext_type, 0 as idx_client, ot.outmessageid as external_sys_id, ot.outmessageid as id_ext,  ot.body TEXT, ot.receiver AS PhoneMobile, ot.senddate SENDDATE, ot.insertdatetime CREATEDATE, otk.name MESSAGEKIND from soglife.outmessage ot inner join soglife.outmessagekind otk on otk.outmessagekindid = ot.outmessagekindid where Otk.BRIEF = 'ОтправкаПароля' and otk.sendchannel = 1 and (sysdate-ot.INSERTDATETIME)*24*60 < $MINUTES_INT$	DiasoftLIFEConnectionString	ORACLE	1	NULL	1	5	20	90	1
215	2	1	2	1	ПролонгИмущ	16.04.2015 12:49:00	СМС с напоминанием об окончании договора. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен.	0	True	$Обращение$, действие Вашего полиса №$НомерБСО$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ $КудаОращаться$. С уважением, СК Согласие, 8 (495) 739 0101	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid))*NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, 0 as SKIP_IF_EMAIL, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 215 as id_ext_type, ci.contractid as idx_contract, replace(f.PhoneMobile, ',', ';') AS PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and (CASE WHEN to_char(sysdate, 'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND f.PhoneMobile is not null and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 70 WHEN 86 THEN 50 ELSE 1 END DESC 	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
216	59	1	2	1	ПролонгИмущСрок2	16.04.2015 12:50:00	СМС с напоминанием об окончании договора. Срок 2.	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Телефон сначала заявитель по последнему убытку, где тип документа НЕ «Заявление на возмещение вреда» (ИД <> 55), потом страхователь.	0	True	$Обращение$, действие Вашего полиса №$НомерБСО$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ $КудаОращаться$. С уважением, СК Согласие, 8 (495) 739 0101	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, 0 as SKIP_IF_EMAIL, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 216 as id_ext_type, ci.contractid as idx_contract, replace (ic.declarantphone,',',';') || ';' || replace(f.PhoneMobile, ',', ';') AS PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid left join sogins.inscase ic on ic.contractinsid=ci.contractid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and (CASE WHEN to_char(sysdate, 'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 AND (ic.inscaseid=(SELECT MAX(ic1.inscaseid) from sogins.inscase ic1 inner join sogins.losso lo1 on lo1.inscaseid=ic1.inscaseid inner join sogins.damagecompensation dc on dc.documentid=lo1.damagecompensationid inner join sogins.document d1 on lo1.damagecompensationid=d1.documentid where ic1.contractinsid = ci.contractid and d1.documentkindid<>55) or ic.inscaseid is null) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND (ic.declarantphone is not null OR f.PhoneMobile is not null) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 70 WHEN 86 THEN 50 ELSE 1 END DESC	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
217	217	1	1	0	АндерЗаявкаВход	23.04.2015 11:43:00	СМС андеррайтерам о поступлении новой заявки СОА	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	1	True	$ТекстСообщения$	SELECT 'STARTSELECT' AS STARTSELECT,(sysdate - b.sentdate) * 24 testDT,217 as id_ext_type,b.uwbidid as idx_client,to_char(b.sentdate, 'ddmmyyyyhh24miss') as id_ext,0 as idx_loss,s.mobilephone as PhoneMobile FROM sogins.uwbid b join uwbiddictsettings s on s.processtypeid = b.processtypeid WHERE b.status in (3) and s.instypeid = b.instypeid and s.insproductid = b.insproductid and s.approvaltypeid = b.approvaltypeid and s.mobilephone is not null and (sysdate - b.sentdate) * 24 <= $HOURS_INT$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
219	219	1	1	2	Регистрация убытка (КАСКО Филиал)	26.06.2015 10:00:00	СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя Сообщение отправляется 1 раз – контрольное поле idx_loss  Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего).	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	1	True	На основании Вашего обращения зарегистрировано событие №$НомерСобытия$. Список требуемых документов для урегулирования на www.soglasie.ru/insurance/	select 'STARTSELECT' AS STARTSELECT, 219 as id_ext_type, d2.object_id as idx_loss, d2.field_110 as LossNumber, nvl(ci.insurerid, 0) as idx_client, d2.object_id as id_Ext, replace(i.declarantphone, ',', ';') || ';' || replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2, d2.ins_phone), ',', ';') As PhoneMobile, so.d_create as RequestDate, 'UTC+'|| nvl(fil.timezone,3) as TZ5MIN from app_documents.sys_object so join app_documents.d2_vars d2 on d2.object_id=so.id left join sogins.contractins ci on ci.contractid=d2.contract_id left join sogins.inscase i on i.inscaseid=D2.id_inscase left join sogins.face f on f.faceid=ci.insurerid left join lib.filial fil on fil.id = d2.field_96 where so.d_create between SYSDATE-1/24/60/60*$SECOND_MAX$ and sysdate-1/24/60/60*$SECOND_MIN$ and nvl(d2.field_72, 0) in (5, 7, 68) and d2.field_2145<>2 and F.ENTITYID=1001 and (D2.OBJECT_ID in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
220	220	1	3	2	Уведомление о решении: выдано направление (КАСКО ГО)	26.06.2015 13:56:00	СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя Сообщение может отправляться отправляется несколько раз по одному убытку, контрольный параметр id_Ext  (не более 1 СМС по параметру) Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего).	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	1	True	По событию №$НомерСобытия$ выдано направление на ремонт на $СТОА$ $АдресСТОА$. Для записи на ремонт позвоните в сервис по телефону $ТелефонСТОА$. Спасибо за доверие, СК Согласие.	select 'STARTSELECT' AS STARTSELECT, 220 as id_ext_type, d2.object_id as idx_loss, d2.field_110 as LossNumber, nvl(ci.insurerid, 0) as idx_client, oe.id as id_Ext, replace(i.declarantphone, ',', ';') || ';' || replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2, d2.ins_phone), ',', ';') As PhoneMobile, oe.d_create as RequestDate from app_documents.d2_vars d2 join app_documents.object_events oe on oe.object_id=d2.object_id left join sogins.contractins ci on ci.contractid=d2.contract_id left join sogins.inscase i on i.inscaseid=D2.id_inscase left join sogins.face f on f.faceid=ci.insurerid left join lib.filial fil on fil.id = d2.field_96 left join (  select /* инфа СТОА по последнему выданному направлению */ sli1.n_loss as n_loss,  sli1.STO_NAME as STO_NAME,  sli1.cto_address as cto_address,  sli1.CTO_PHONE as CTO_PHONE,  sli1.d_order as d_order,  max(sli1.d_order) over (partition by sli1.n_loss) as max_d  from app_documents.stoa_and_loss_info sli1 ) sli on sli.n_loss=D2.field_110 and SLI.D_ORDER=sli.max_d where oe.d_create between SYSDATE-1/24/60/60*$SECONDS_MAX$ and SYSDATE-1/24/60/60*$SECONDS_MIN$ and oe.event_id in (13883, 12503, 1267) /* переходы с этапа "Выдача направления" на этап "Ожидание/регистрация счета" */ and nvl(d2.field_2145, 2) <> 2 /* убыток НЕ дополнительный */ and nvl(d2.field_72, 0) not in (5, 7, 68) /* точка входа НЕ Филиал (спецпрограммы), Филиал (убыток по договору филиала), Партнеры УУ с СЭД (Филиал) */ and nvl(OE.ID_COMMIT_TYPE, 0) <> 4 /* принятие перехода НЕ "отзыв" */ and F.ENTITYID=1001 and (D2.OBJECT_ID in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
221	221	1	3	2	Уведомление о решении: выдано направление (КАСКО Филиалы)	26.06.2015 14:31:00	СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя Сообщение может отправляться отправляется несколько раз по одному убытку, контрольный параметр id_Ext  (не более 1 СМС по параметру) Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего).	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	1	True	По событию №$НомерСобытия$ Вы можете получить направление на ремонт в офисе компании, где подавалось заявление. Спасибо за доверие, СК Согласие.	select 'STARTSELECT' AS STARTSELECT, 221 as id_ext_type, d2.object_id as idx_loss, d2.field_110 as LossNumber, nvl(ci.insurerid, 0) as idx_client, last_n.oid as id_Ext, replace(i.declarantphone, ',', ';') || ';' || replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2, d2.ins_phone), ',', ';') As PhoneMobile, oe.d_create as RequestDate, 'UTC+'|| nvl(fil.timezone,3) as TZ5MIN from app_documents.d2_vars d2 join app_documents.object_events oe on oe.object_id=d2.object_id left join sogins.contractins ci on ci.contractid=d2.contract_id left join sogins.inscase i on i.inscaseid=D2.id_inscase left join sogins.face f on f.faceid=ci.insurerid left join lib.filial fil on fil.id = d2.field_96 join (select /* ищем последнюю задачу "Выдача направления (Рег. сеть)" для данного убытка */ d29.object_id oid, D29.PARENT_ID pid, max(d29.object_id) over (partition by d29.PARENT_ID) as max_obj from app_documents.d29_vars d29 where d29.field_2416=51 /* тип задачи "Выдача направления (Рег. сеть)" */) last_n on last_n.pid = d2.object_id and last_n.oid = last_n.max_obj /* либо по максимальной дате, как всегда, либо чем-то еще привязать */ where oe.event_id in (15096, 15077, 14694, 14690, 14689, 14688) /* переходы на этап "Ожидание документов из рег. сети" */ and oe.d_create between SYSDATE-1/24/60/60*$SECONDS_MAX$ and SYSDATE-1/24/60/60*$SECONDS_MIN$ and nvl(d2.field_2145, 0) <> 2 /* убыток НЕ дополнительный */ and nvl(d2.field_72, 0) in (5, 7, 68) /* точка входа Филиал (спецпрограммы), Филиал (убыток по договору филиала), Партнеры УУ с СЭД (Филиал) */ and F.ENTITYID=1001 and (D2.OBJECT_ID in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
222	222	1	3	2	Запрос доп. документов (КАСКО ГО)	26.06.2015 14:52:00	1. СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя 2. Сообщение может отправляться отправляется несколько раз по одному убытку, контрольный параметр id_Ext  состоит из нескольких номеров заявок, разделенных «;». Перед отправкой необходимо проверять 100% вхождение отобранного набора номеров в уже наборы по уже отправленным СМС.   Пример: отправили СМС по убытку №123 с id_Ext = 111; 222; 333, в следующий раз запрос вернул по тому же убытку id_Ext = 111; 222 (документ по запросу 333 был получен) – СМС не отправляется. Если запрос вернул id_Ext = 111; 222; 444 – добавили новый документ, СМС отправляется. 3. Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего).	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	0	True	Для урегулирования Вашего события $НомерСобытия$ необходимо предоставить: $Документы$ (в офис СК "Согласие", где подавалось заявление). С уважением, СК Согласие.	select 'STARTSELECT' AS STARTSELECT, 222 as id_ext_type, d2.object_id as idx_loss, d2.field_110 as LossNumber, nvl(ci.insurerid, 0) as idx_client, sp.objs as id_Ext, replace(i.declarantphone, ',', ';') || ';' || replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2, d2.ins_phone), ',', ';') As PhoneMobile, sp.dcr as RequestDate from app_documents.d2_vars d2 left join sogins.contractins ci on ci.contractid=d2.contract_id left join sogins.inscase i on i.inscaseid=D2.id_inscase left join sogins.face f on f.faceid=ci.insurerid left join lib.filial fil on fil.id = d2.field_96 join ( select /* получаем список документов */ d15.parent_id pd, listagg(d15.object_ID, '; ') within group(order by null) objs /* список ID услуг СЭД */, listagg(f1099.title, ', ') within group(order by null) docs /* Список документов */, max(so.d_create) as dcr /*максимальная дата создания */ from app_documents.d15_vars d15 join app_documents.sys_object so on so.id = D15.OBJECT_ID join app_django.df_lib_field_1099 f1099 on f1099.id=d15.field_1099 where so.d_create between SYSDATE-1/24/60/60*$SECONDS_MAX$ and SYSDATE-1/24/60/60*$SECONDS_MIN$ and d15.field_1090 = 1 /* Категория запросов "Документы по делу" */ and d15.field_1091 = 1 /* Справочник типов "Клиент (документы по ущербу ТС) */ and d15.field_1106 is null /* если не проставлена дата получения док-та */ group by d15.parent_id ) sp on sp.pd=d2.object_id where nvl(d2.field_72, 0) not in (5, 7, 68) /* точка входа НЕ Филиал (спецпрограммы), Филиал (убыток по договору филиала), Партнеры УУ с СЭД (Филиал) */ and F.ENTITYID=1001 and (D2.OBJECT_ID in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
223	223	1	3	2	Информирование о получении док-в от АК (КАСКО ГО)	29.06.2015 15:10:00	СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя Сообщение может отправляется 1 раз по одному убытку, контрольный параметр idx_loss (ID убытка в СЭД) Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего).	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	1	True	Аварийный комиссар предоставил в компанию полученные от Вас документы для урегулирования события $НомерСобытия$. Ваше дело передано на рассмотрение. Спасибо за доверие, СК Согласие.	select 'STARTSELECT' AS STARTSELECT, 223 as id_ext_type, d2.object_id as idx_loss, d2.field_110 as LossNumber, nvl(ci.insurerid, 0) as idx_client, d2.object_id as id_Ext, replace(i.declarantphone, ',', ';') || ';' || /* телефон Заявителя */ replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2, d2.ins_phone), ',', ';') As PhoneMobile /* пытаемся достать телефон Страхователя откуда-нибудь */, ppd.d_create as RequestDate from app_documents.d2_vars d2 left join sogins.contractins ci on ci.contractid=d2.contract_id left join sogins.inscase i on i.inscaseid=D2.id_inscase left join sogins.face f on f.faceid=ci.insurerid left join lib.filial fil on fil.id = d2.field_96 join ( select /* ищем первый переход на этап "Проверка полноты данных" */ OE.OBJECT_ID as oid, OE.EVENT_ID as eid, oe.d_create as d_create, min(oe.d_create) over (partition by OE.OBJECT_ID) as min_d from app_documents.object_events oe join app_documents.Lib_events le on LE.ID = oe.event_id join app_documents.sys_status ss on SS.ID = LE.STATUS_ID_TO where ss.id=265 ) ppd on ppd.oid=D2.OBJECT_ID and ppd.d_create=ppd.min_d and ppd.d_create between SYSDATE-1/24/60/60*$SECONDS_MAX$ and SYSDATE-1/24/60/60*$SECONDS_MIN$ where d2.field_72 = 4 /* Точка входа - "Аварком" проверка ГО не нужна - все аваркомы ГО */ and d2.field_2145<>2 /* убыток НЕ дополнительный */ and F.ENTITYID=1001 and (D2.OBJECT_ID in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
224	-1	3	3	2	Уведомление клиента о контактах ПМ	30.06.2015 9:32:00	Уведомление клиента о контактах Персонального менеджера в рамках сервисной программы Привилегия		1	True	В рамках сервисной программы Привилегия, информацию о ходе урегулирования убытка Вы можете получить у Персонального менеджера по тел. (495)739-0101, доб. $Телефон$. С уважением, СК Согласие.	select nvl(ic.number_,'') as LossNumber,'$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
225	-1	3	3	2	Выдано направление (ГО)	30.06.2015 9:32:00	Уведомление о выдаче направления на СТОА в ГО		1	True	По событию №$НомерДела+НомерДелаМаксБД$  выдано направление на ремонт на $НазваниеСТОа$ $АдресСТОа$. Для записи на ремонт позвоните в сервис по телефону $Телефон$. С уважением, СК Согласие.	select nvl(ic.number_,'') as LossNumber,'$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
226	-1	3	3	2	Запрос доп. документов (Филиал)	30.06.2015 10:56:00	Описание маски		1	True	Для урегулирования Вашего события №$НомерДела+НомерДелаМаксБД$ необходимо предоставить: $ПредоставитьДокументы$ (в офис СК "Согласие", где подавалось заявление). С уважением, СК Согласие.	select nvl(ic.number_,'') as LossNumber,'$AddressYYList$' as AddressYY, to_char(sysdate,'dd.mm.yy') AS  Today from sogins.inscase ic where ic.inscaseid=( select max(ic1.inscaseid) from sogins.InsCase ic1 inner join sogins.contractins ci on ci.contractid=ic1.contractinsid where ci.insurerid=<ID_CLIENT>)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
227	-1	1	3	2	ПеречислениеОсаго	23.07.2015 15:43:00	1. СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя 2. Сообщение отправляется 1 раз – контрольное поле id_Ext 3. Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего). 4. !!! Обратите внимание, переменные с датами отбора встречаются дважды	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	0	True	Ваше дело №$НомерДела$ передано на оплату. Денежные средства будут зачислены на  р/с в течение 5-и банковских дней. С уважением, СК Согласие.	select 'STARTSELECT' AS STARTSELECT, 227 as id_ext_type, d1.object_id as idx_loss, d1.n_loss as LossNumber, nvl(IAM.FACEID , 0) as idx_client, ff.id as id_Ext, /*ID привязки скана Платежного поручения*/ TRIM(';' FROM replace(i.declarantphone, ',', ';') || ';' || replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2), ',', ';')) as PhoneMobile, ff.d_create as RequestDate, /* дата привязки ПП*/ 'UTC+'|| nvl(fil.timezone,3) as TZ5MIN /* сдвиг филиала*/ from app_documents.d1_vars d1 /*К карточке убытка не менее 20 минут и не более 3-х суток назад прикреплен документ с типом "Платежное поручение".*/ join (select ff.document_id, max(ff.id) keep (dense_rank last order by ff.d_create) as id, max(ff.d_create) as d_create from app_django.filetyping_files ff join sogins.scannedimagetype sc on SC.SCANNEDIMAGETYPEID = ff.file_type_id join app_documents.d1_vars d1 on ff.document_id = d1.object_id where 1 = 1 and ff.file_type_id = 252 and ff.d_create between SYSDATE-1/24/60*$MINUTES_MAX$ and SYSDATE-1/24/60*$MINUTES_MIN$ group by ff.document_id ) ff on ff.document_id = d1.object_id left join sogins.contractins ci on ci.contractid = d1.contract_id left join sogins.inscase i on i.inscaseid = D1.id_inscase left join sogins.document d on D.NUMBER_= d1.n_loss and D.ENTITYID in (1863,1864) left join sogins.damagecompensation dc on dc.INSCASEID = I.INSCASEID  and DC.documentid=D.documentid left join sogins.insaccidentmember iam on IAM.INSACCIDENTMEMBERID = DC.DECLARANTID left join sogins.face f on f.faceid = IAM.FACEID left join lib.filial fil on fil.id = d1.field_2065 where 1 = 1 and nvl(d1.field_3134, 0) <> 2 /* убыток НЕ дополнительный */ and d1.id_loss_type = 1 /* 1 ОСАГО классическое*/ and f.entityid = 1001 /* В течение последних 3-х суток осуществлен переход с этапа "Подготовка пл. документа" на этап "Ожидание оплаты" */ and exists (select null from app_documents.object_events oe join app_documents.lib_events le on le.class_id = oe.class_id and le.id = oe.event_id where 1 = 1 and oe.class_id = 1 and nvl(oe.id_commit_type, 1) in (1, 2) and le.status_id_from = 374 /* Подготовка пл. поручения*/ and le.status_id_to = 375 /* Ожидание оплаты*/ and oe.d_create between SYSDATE-1/24/60*$MINUTES_MAX$ and SYSDATE-1/24/60*$MINUTES_MIN$ and oe.object_id = d1.object_id ) and (d1.object_id in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
228	-1	1	3	2	ПеречислениеОсагоПВУ	23.07.2015 16:03:00	1. СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя 2. Сообщение отправляется 1 раз – контрольное поле id_Ext 3. Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего). 4. !!! Обратите внимание, переменные с датами отбора встречаются дважды	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	0	True	Ваше дело №$НомерДела$ передано на оплату. Денежные средства будут зачислены на  р/с в течение 5-и банковских дней. С уважением, СК Согласие.	select 'STARTSELECT' AS STARTSELECT, 228 as id_ext_type, d1.object_id as idx_loss, d1.n_loss as LossNumber, nvl(ci.insurerid, 0) as idx_client, ff.id as id_Ext, /*ID привязки скана Платежного поручения*/ TRIM(';' FROM replace(i.declarantphone, ',', ';') || ';' || replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2), ',', ';')) as PhoneMobile, ff.d_create as RequestDate, /* дата привязки ПП*/ 'UTC+'|| nvl(fil.timezone,3) as TZ5MIN /* сдвиг филиала*/ from app_documents.d1_vars d1 /*К карточке убытка не менее 20 минут и не более 3-х суток назад прикреплен документ с типом "Платежное поручение".*/ join (select ff.document_id, max(ff.id) keep (dense_rank last order by ff.d_create) as id, max(ff.d_create) as d_create from app_django.filetyping_files ff join sogins.scannedimagetype sc on SC.SCANNEDIMAGETYPEID = ff.file_type_id join app_documents.d1_vars d1 on ff.document_id = d1.object_id where 1 = 1 and ff.file_type_id = 252 and ff.d_create between SYSDATE-1/24/60*$MINUTES_MAX$ and SYSDATE-1/24/60*$MINUTES_MIN$ group by ff.document_id ) ff on ff.document_id = d1.object_id left join sogins.contractins ci on ci.contractid = d1.contract_id left join sogins.inscase i on i.inscaseid = D1.id_inscase left join sogins.document d on D.NUMBER_= d1.n_loss and D.ENTITYID in (1863,1864) left join sogins.damagecompensation dc on dc.INSCASEID = I.INSCASEID  and DC.documentid=D.documentid left join sogins.insaccidentmember iam on IAM.INSACCIDENTMEMBERID = DC.DECLARANTID left join sogins.face f on f.faceid = ci.insurerid left join lib.filial fil on fil.id = d1.field_2065 where 1 = 1 and nvl(d1.field_3134, 0) <> 2 /* убыток НЕ дополнительный*/ and d1.id_loss_type = 2 /* 2 ПВУ*/ and f.entityid = 1001 /* В течение последних 3-х суток осуществлен переход с этапа "Подготовка пл. документа" на этап "Ожидание оплаты" */ and exists (select null from app_documents.object_events oe join app_documents.lib_events le on le.class_id = oe.class_id and le.id = oe.event_id where 1 = 1 and oe.class_id = 1 and nvl(oe.id_commit_type, 1) in (1, 2) and le.status_id_from = 374 /* Подготовка пл. поручения*/ and le.status_id_to = 375 /* Ожидание оплаты*/ and oe.d_create between SYSDATE-1/24/60*$MINUTES_MAX$ and SYSDATE-1/24/60*$MINUTES_MIN$ and oe.object_id = d1.object_id ) and (d1.object_id in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
229	-1	1	3	2	ПеречислениеКАСКО	24.07.2015 11:22:00	1. СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя 2. Сообщение отправляется 1 раз по контрольным полям  idx_client и id_Ext 3. Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего). 4. !!! Обратите внимание, переменные с датами отбора встречаются дважды  	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	0	True	Ваше дело №$НомерДела$ передано на оплату. Денежные средства будут зачислены на  р/с в течение 5-и банковских дней. С уважением, СК Согласие.	select 'STARTSELECT' AS STARTSELECT, 229 as id_ext_type, d2.object_id as idx_loss, d2.field_110 as LossNumber, nvl(ci.insurerid, 0) as idx_client, ff.id as id_Ext, /*ID привязки скана Платежного поручения */ TRIM(';' FROM replace(i.declarantphone, ',', ';') || ';' || replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2, d2.ins_phone), ',', ';')) As PhoneMobile, ff.d_create as RequestDate, /*Дата (со временем) прикрепления скана Платежного поручения*/ 'UTC+'|| nvl(fil.timezone,3) as TZ5MIN /*Часовой пояс*/ from app_documents.d2_vars d2 /*К карточке убытка не менее 20 минут и не более 3-х суток назад прикреплен документ с типом "Платежное поручение".*/ join (select ff.document_id, max(ff.id) keep (dense_rank last order by ff.d_create) as id, max(ff.d_create) as d_create from app_django.filetyping_files ff where 1 = 1 and ff.file_type_id = 183 and ff.d_create between SYSDATE-1/24/60*$MINUTES_MAX$ and SYSDATE-1/24/60*$MINUTES_MIN$ group by ff.document_id ) ff on ff.document_id = d2.object_id left join sogins.contractins ci on ci.contractid=d2.contract_id left join sogins.inscase i on i.inscaseid=D2.id_inscase left join sogins.face f on f.faceid=ci.insurerid left join lib.filial fil on fil.id = d2.field_96 where 1 = 1 and nvl(d2.field_2145, 0) <> 2 /* убыток НЕ дополнительный*/ and f.entityid = 1001 /* В течение последних 3-х суток осуществлен переход с этапа "Подготовка пл. документа" на этап "Ожидание оплаты" */ and exists (select null from app_documents.object_events oe join app_documents.lib_events le on le.class_id = oe.class_id and le.id = oe.event_id where 1 = 1 and oe.class_id = 2 and nvl(oe.id_commit_type, 1) in (1, 2) and le.status_id_from = 380 /* Подготовка пл. документа*/ and le.status_id_to = 378 /* Ожидание оплаты*/ and oe.d_create between SYSDATE-1/24/60*$MINUTES_MAX$ and SYSDATE-1/24/60*$MINUTES_MIN$ and oe.object_id = d2.object_id ) and (d2.object_id in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
230	-1	1	3	2	РегУбыткаОСАГО	24.07.2015 14:30:00	1. СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя 2. Сообщение отправляется 1 раз – контрольное поле idx_loss 3. Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего).	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	0	True	Ваше заявление по событию №$НомерДела$ зарегистрировано $ДатаРегистрации$. Документы переданы на рассмотрение. С уважением, СК  Согласие.	select 'STARTSELECT' AS STARTSELECT, 230 as id_ext_type, d1.object_id as idx_loss, d1.n_loss as LossNumber, nvl(IAM.FACEID, 0) as idx_client, f.fullname, 0 as id_Ext, replace(i.declarantphone, ',', ';') || ';' || replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2), ',', ';') As PhoneMobile, pd.d_create as RequestDate, 'UTC+'|| nvl(fil.timezone,3) as TZ5MIN from app_documents.sys_object so join app_documents.d1_vars d1 on D1.OBJECT_ID=so.id left join sogins.contractins ci on ci.contractid=d1.contract_id left join sogins.inscase i on i.inscaseid=D1.id_inscase left join sogins.document d on D.NUMBER_= d1.n_loss and D.ENTITYID in (1863,1864) left join sogins.damagecompensation dc on dc.INSCASEID = I.INSCASEID and DC.documentid=D.documentid left join sogins.insaccidentmember iam on IAM.INSACCIDENTMEMBERID = DC.DECLARANTID left join sogins.face f on f.faceid=IAM.FACEID left join lib.filial fil on fil.id = d1.field_2065 join (select row_number() over (partition by OBJECT_ID order by oe.d_create) as rn, OE.OBJECT_ID as oid, OE.EVENT_ID as eid, oe.d_create as d_create from app_documents.object_events oe where OE.EVENT_ID in (15324, 15322, 14317, 13813, 13730, 13264, 13044, 15274, 13092) /* список этапов, по которым должны отправлять СМС */ ) pd on pd.oid=d1.object_id and pd.rn=1 where nvl(D1.ID_LOSS_TYPE, 0) = 1 /*ОСАГО классическое */ and nvl(d1.field_3134, 0) <>2 /* убыток НЕ дополнительный*/ and nvl(F.ENTITYID, 0) = 1001 /*Потерпевший физ-лицо*/ and pd.d_create between SYSDATE-1/24/60*$MINUTES_MAX$ and SYSDATE-1/24/60*$MINUTES_MIN$ and (d1.object_id in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0) 	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
231	-1	1	3	2	РегУбыткаОСАГОПву	24.07.2015 14:31:00	1. СМС отправляется на номер телефона Заявителя. При отсутствии телефона Заявителя смс направляется на номер телефона Страхователя 2. Сообщение отправляется 1 раз – контрольное поле idx_loss 3. Если время отправки с учетом часового пояса Филиала TZ попадает во временной промежуток с 21:00 до 10:00, время отправки должно сдвигаться на 10:00 ближайшего дня (сегодняшнего или завтрашнего).	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. СЭД	0	True	Ваше заявление по событию №$НомерДела$ зарегистрировано $ДатаРегистрации$. Документы переданы на рассмотрение. С уважением, СК  Согласие.	select 'STARTSELECT' AS STARTSELECT, 231 as id_ext_type, d1.object_id as idx_loss, d1.n_loss as LossNumber, nvl(ci.insurerid, 0) as idx_client, 0 as id_Ext, replace(i.declarantphone, ',', ';') || ';' || replace(coalesce(F.PHONEMOBILE, F.phone1, f.phone2), ',', ';') As PhoneMobile, pd.d_create as RequestDate, 'UTC+'|| nvl(fil.timezone,3) as TZ5MIN from app_documents.d1_vars d1 left join sogins.contractins ci on ci.contractid=d1.contract_id left join sogins.inscase i on i.inscaseid=D1.id_inscase left join sogins.face f on f.faceid=ci.insurerid left join lib.filial fil on fil.id = d1.field_2065 join (select row_number() over (partition by OE.OBJECT_ID order by d_create) rn, OE.OBJECT_ID as oid, OE.EVENT_ID as eid, oe.d_create as d_create from app_documents.object_events oe where OE.EVENT_ID in (15324, 15322, 14317, 13813, 13730, 13264, 13044, 15274, 13092) ) pd on pd.oid=d1.object_id and pd.rn=1 where nvl(D1.ID_LOSS_TYPE, 0) = 2 /*ОСАГО ПВУ*/ and nvl(d1.field_3134, 0) <>2 /* убыток НЕ дополнительный*/ and nvl(F.ENTITYID, 0) = 1001 /*Страхователь физ-лицо*/ and pd.d_create between SYSDATE-1/24/60*$MINUTES_MAX$ and SYSDATE-1/24/60*$MINUTES_MIN$ and (d1.object_id in ($OBJECTS_FOR_TEST$) or $USE_TEST_OBJECTS$=0) 	DiasoftConnectionString	ORACLE	1	NULL	0	5	20	90	99
232	-1	4	1	6	eOSAGO.loadDriver	25.08.2015 9:05:00	WS проверка водителя в рамках проекта электронного ОСАГО. Диасофт	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
   <soapenv:Header/>
   <soapenv:Body>
      <eos:loadDriver>
         <request>
             <DriverRequestValue>
                 <DriverInfoRequest>
                     <PersonNameBirthHash>### $DRIVER_NAME$ $DRIVER_DOB$</PersonNameBirthHash>
                      <DriverDocument>
                          <Serial>$LICENSE_SERIE$</Serial>
                           <Number>$LICENSE_NUMBER$</Number>
                  </DriverDocument>
                         <CategoriesDriverLicense>
                             <CatDriverLicense>$DOC_TYPE$</CatDriverLicense>
                  </CategoriesDriverLicense>
                           <DriverDocDate>$LICENSE_DATE$</DriverDocDate>
               </DriverInfoRequest>
                         <DateRequest>$DATE_REQUEST$</DateRequest>
            </DriverRequestValue>
         </request>
      </eos:loadDriver>
   </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 232 as id_ext_type, $IsAssynchron$ as IsAssynchron, df.faceid as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID, $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss, pspt.passportser, pspt.passportnum, pspt.passportdate, df.name, dfp.firstname, dfp.secondname, to_char(dfp.birthdate, 'dd-mm-yyyy') from driver drv inner join sogins.EOSAGOOBJECTS eo  on eo.objectid=drv.driverid  inner join face df on df.faceid = drv.facepersonid inner join faceperson dfp on dfp.faceid = df.faceid  inner join PASSPORTFACE pspt on pspt.passportfaceid=drv.drivercertifid_lv inner join PASSPORTTYPE pt_drv on pt_drv.passporttypeid = pspt.passporttypeid where eo.eosagoobjentityid=$ObjEntityID$ and eo.eosagoobjstatusid = $StatusID$	DiasoftTestingConnectionString	ORACLE	4	loadDriver	1	9	20	90	86
233	-1	4	1	6	eOSAGO.getDriverStatus	25.08.2015 16:02:00	WS плучение статуса проверки водителя в рамках проекта электронного ОСАГО	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
   <soapenv:Header/>
   <soapenv:Body>
      <eos:getDriverStatus>
         <request>
            <IDCheckDriver>$IDCHECK$</IDCheckDriver>
         </request>
      </eos:getDriverStatus>
   </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 233 as id_ext_type, '$TagFailedFields$' as TagFailedFields, $IsAssynchron$ as IsAssynchron, 0 as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID , $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss from sogins.EOSAGOOBJECTS eo where eo.eosagoobjentityid=$ObjEntityID$ and eo.eosagoobjstatusid=$StatusID$	DiasoftTestingConnectionString	ORACLE	4	getDriverStatus	1	9	20	90	86
237	-1	4	1	0	eOSAGO.Registration	26.08.2015 11:27:00	Регистрация объектов электронного полиса ОСАГО для загруженного проекта	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	eOSAGOPkg.eosagoobjectsregister|"contractinsid",20,1,0,$contractid$	select 'STARTSELECT' AS STARTSELECT, 237 as id_ext_type, ci.contractid as id_ext, ci.contractid as objid, 0 as idx_client, -1 as NextStatusID, -1 as NextProgress, 'Nothing' as TagError, 'Nothing' as TagDescription, 'Nothing' as TagIDCheck, 'Nothing' as TagChecked from sogins.contractins ci inner join document d on d.documentid = ci.contractid inner join MV_ContractByDKBM_1 mv on mv.ContractID = ci.contractid where not EXISTS (SELECT * FROM EOSAGOOBJECTS eo WHERE eo.contractinsid = ci.contractid) and (($USE_TEST_OBJECTS$ = 1 AND ci.contractid IN($OBJECTS_FOR_TEST$)) or ($USE_TEST_OBJECTS$ = 0  and /* отбросим старые договора по дате начала действия */ ci.validdate >= sysdate - 2  AND /* далее критерий предложенный для определения того, что договор электронный -Кашин */ D.Documentkindid = (SELECT OK.OBJECTKINDID FROM Objectkind OK WHERE OK.Brief = 'ДогСтрахЕОСАГО') and mv.StatusID in(20) and mv.SignDate >= to_Date('20130101', 'yyyymmdd')))	DiasoftTestingConnectionString	ORACLE	4	NULL	1	11	20	90	86
238	-1	4	1	0	eOSAGO.IsAnyFault	27.08.2015 13:21:00	При наличии хоть одного отказа в проверках объектов по проекту, переводит проект в статус отклонено	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	eOSAGOPkg.eOSAGOObjectsUpdate|"pOBJECTID",20,1,0,$objectid$;"pProgress",20,1,0,0;"pStatus",20,1,0,11;"pCheckID",20,1,0,-1;"pSerialKey",203,1,200,empty;"pNumberKey",203,1,200,empty;"pDescription",203,1,200,$ErrDescription$	select 'STARTSELECT' AS STARTSELECT, 238 as id_ext_type,  eo.contractinsid || 'v' || eo.ver as id_ext, eo.contractinsid as objid,  0 as idx_client, $StatusID$ as NextStatusID , 0 as NextProgress, 'Nothing' as TagError, 'Nothing' as TagDescription, 'Nothing' as TagIDCheck, 'Nothing' as TagChecked from sogins.EOSAGOOBJECTS eo where eo.eosagoobjstatusid<>$StatusID$ and eo.eosagoobjentityid= $ObjEntityID$ and eo.contractinsid IN (SELECT distinct eo1.contractinsid from EOSAGOOBJECTS eo1 where  eo1.eosagoobjstatusid=$StatusID$)	DiasoftTestingConnectionString	ORACLE	4	NULL	1	11	20	90	86
239	-1	4	1	6	eOSAGO.loadVehicle	27.08.2015 15:05:00	WS проверка ТС в рамках проекта электронного ОСАГО. Диасофт	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
   <soapenv:Header/>
   <soapenv:Body>
      <eos:loadVehicle>
         <request>
            <TSRequestValue>
               <TSInfoRequest>
                  <CountryCar>1</CountryCar>
                  <CarIdent>
                     <LicensePlate/>
                     <VIN>$VIN$</VIN>
                     <BodyNumber/>
                     <ChassisNumber/>
                  </CarIdent>
                  <MarkModelCarRSACode>$CODE$</MarkModelCarRSACode>
                  <YearIssue>$YearBuild$</YearIssue>
                  <TypeCar>$TypeTS$</TypeCar>
                  <CatCar>$Category$</CatCar>
                  <DocumentCar>$DOC_TYPE$</DocumentCar>
                  <DocCarSerial>$DOC_SERIE$</DocCarSerial>
                  <DocCarNumber>$DOC_NUMBER$</DocCarNumber>
                  <DocumentCarDate>$DOC_DATE$</DocumentCarDate>
                  <EngCap>$Power$</EngCap>
                  <MaxMass>$MaxMass$</MaxMass>
               </TSInfoRequest>
               <DateRequest>$DATE_REQUEST$</DateRequest>
            </TSRequestValue>
         </request>
      </eos:loadVehicle>
   </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 239 as id_ext_type, $IsAssynchron$ as IsAssynchron, 0 as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID, $NextStatusIDFailure$ as NextStatusIDFailure, $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss from sogins.EOSAGOOBJECTS eo inner join contractins ci on eo.contractinsid=ci.contractid inner join insobject io on eo.objectid=io.insobjectid inner join INSOBJECT_HIST ioh On ioh.INSOBJECTID = io.INSOBJECTID  left join ADDITIONALINSAGREEMENT aa On aa.CONTRACTID = ci.CONTRACTID inner join address adr_own on adr_own.addressid=io.owneraddressid_lv inner join TRANSPORTMODEL tm on tm.transportmodelid=io.transportmodelid inner join TRANSPORTMODELRSA tmrsa on tmrsa.transportmodelrsaid=tm.transportmodelrsaid inner join TSPASSPORTTYPE tspt on tspt.tspassporttypeid=io.regcertiftypedocid_lv inner join transporttype tt on tt.transporttypeid=io.transporttypeid where eo.eosagoobjentityid=$ObjEntityID$ and eo.eosagoobjstatusid = $StatusID$ and ioh.StateDate = (Select Max(StateDate) Column1 From INSOBJECT_HIST Where INSOBJECTID = io.INSOBJECTID and StateDate <= Nvl(aa.STARTDATE, ci.VALIDDATE))	DiasoftTestingConnectionString	ORACLE	4	loadVehicle	1	9	20	90	86
240	-1	4	1	6	eOSAGO.getVehicleStatus	27.08.2015 16:50:00	WS плучение статуса проверки ТС в рамках проекта электронного ОСАГО	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
   <soapenv:Header/>
   <soapenv:Body>
      <eos:getVehicleStatus>
         <request>
            <IDCheckTS>$IDCHECK$</IDCheckTS>
         </request>
      </eos:getVehicleStatus>
   </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 240 as id_ext_type, '$TagFailedFields$' as TagFailedFields,  $IsAssynchron$ as IsAssynchron, 0 as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID , $NextStatusIDFailure$ as NextStatusIDFailure, $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss from sogins.EOSAGOOBJECTS eo where eo.eosagoobjentityid=$ObjEntityID$ and eo.eosagoobjstatusid=$StatusID$	DiasoftTestingConnectionString	ORACLE	4	getVehicleStatus	1	9	20	90	86
241	-1	4	1	6	eOSAGO.loadInsurerOwner	28.08.2015 10:04:00	WS проверка страхователя / собственника для ФЛ в рамках проекта электронного ОСАГО. Диасофт	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
   <soapenv:Header/>
   <soapenv:Body>
      <eos:loadInsurerOwner>
         <request>
            <InsurerOwnerRequestValue>
$StartPerson$
               <PhysicalPersonInfoRequest>
                  <Country>$Country$</Country>
                  <PersonNameBirthHash>### $FACE_NAME$ $FACE_DOB$</PersonNameBirthHash>
                  <PersonDocument>
                     <DocPerson>$DOC_TYPE$</DocPerson>
                     <Serial>$DOC_SERIE$</Serial>
                     <Number>$DOC_NUMBER$</Number>
                  </PersonDocument>
                  <AddressRSACode>$FACE_ADDRESS$</AddressRSACode>
               </PhysicalPersonInfoRequest>
$EndPerson$
$StartJuridical$
               <JuridicalPersonInfoRequest>
                  <OrgID>
                     <Resident>$Resident$</Resident>
                     <INN>$INN$</INN>
                     <OrgName><![CDATA[$JFName$]]></OrgName>
                  </OrgID>
                  <AddressRSACode>$FACE_ADDRESS$</AddressRSACode>
               </JuridicalPersonInfoRequest>
$EndJuridical$
               <DateRequest>$DATE_REQUEST$</DateRequest>
            </InsurerOwnerRequestValue>
         </request>
      </eos:loadInsurerOwner>
   </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 241 as id_ext_type, $IsAssynchron$ as IsAssynchron, f.faceid as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID, $NextStatusIDFailure$ as NextStatusIDFailure, $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss, f.name, fp.firstname, fp.secondname, to_char(fp.birthdate, 'dd-mm-yyyy')  from sogins.EOSAGOOBJECTS  eo inner join contractins ci on ci.contractid=eo.contractinsid inner join insobject io on io.insobjectid=ci.insobjectid inner join face f on f.faceid = eo.objectid left join faceperson fp on fp.faceid = f.faceid  inner join address adr_ins on adr_ins.addressid=ci.INSURERADDRESSID_LV inner join address adr_own on adr_own.addressid=io.owneraddressid_lv left join PASSPORTFACE pspt_ins ON pspt_ins.passportfaceid=ci.INSURERCERTIFICATEID_LV  left join PASSPORTFACE pspt_own ON pspt_own.passportfaceid=io.ownercertificateid_lv left join PASSPORTTYPE pt_ins on pt_ins.passporttypeid=pspt_ins.passporttypeid left join PASSPORTTYPE pt_own on pt_own.passporttypeid=pspt_own.passporttypeid where eo.eosagoobjentityid=$ObjEntityID$ and eo.eosagoobjstatusid = $StatusID$	DiasoftTestingConnectionString	ORACLE	4	loadInsurerOwner	1	9	20	90	86
242	-1	4	1	6	eOSAGO.getInsurerOwnerStatus	28.08.2015 10:05:00	WS плучение статуса проверки страхователя / собственника в рамках проекта электронного ОСАГО	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
   <soapenv:Header/>
   <soapenv:Body>
      <eos:getInsurerOwnerStatus>
         <request>
            <IDCheckInsurerOwner>$IDCHECK$</IDCheckInsurerOwner>
         </request>
      </eos:getInsurerOwnerStatus>
   </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 242 as id_ext_type,  '$TagFailedFields$' as TagFailedFields, $IsAssynchron$ as IsAssynchron, 0 as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID , $NextStatusIDFailure$ as NextStatusIDFailure, $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss from sogins.EOSAGOOBJECTS eo where eo.eosagoobjentityid=$ObjEntityID$ and eo.eosagoobjstatusid=$StatusID$	DiasoftTestingConnectionString	ORACLE	4	getInsurerOwnerStatus	1	9	20	90	86
243	-1	4	1	6	eOSAGO.loadPolicy	28.08.2015 14:19:00	Загрузка проекта договора электронного полиса ОСАГО	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
 <soapenv:Header/>
 <soapenv:Body>
 <eos:loadPolicy>
 <request>
 <PolicyTitle>
 <TripNumber>$TripNumber$</TripNumber>
 <TripTm>$TripTm$</TripTm>
 </PolicyTitle>
 <DraftPolicyRequest>
 <DraftPolicyID>$DraftPolicyID$</DraftPolicyID>
 <DateRevision>$DateRevision$</DateRevision>
 <DateActionBeg>$DateActionBeg$</DateActionBeg>
 <DateActionEnd>$DateActionEnd$</DateActionEnd>
 <Period1Beg>$Period1Beg$</Period1Beg>
 <Period1End>$Period1End$</Period1End>
 <Period2Beg>$Period2Beg$</Period2Beg>
 <Period2End>$Period2End$</Period2End>
 <Period3Beg>$Period3Beg$</Period3Beg>
 <Period3End>$Period3End$</Period3End>
 <DriversRestriction>$DriverRestriction$</DriversRestriction>
 <PolicyKBM>$PolicyKBM$</PolicyKBM>
 <!-- <PolicyKBMRsaId>$PolicyKBMRSAId$</PolicyKBMRsaId> -->
 <InsurancePremium>$InsurencePremium$</InsurancePremium>
 <IsTransCar>$IsTransCar$</IsTransCar>
 <IsTrailerAllowed>$IsTralerAllowed$</IsTrailerAllowed>
 <CarPart>
 <IDCheckTS>$IdCheckTS$</IDCheckTS>
 <CountryCar>1</CountryCar>
 <CarIdent>
 <VIN>$VIN$</VIN>
 <BodyNumber>$BodyNumber$</BodyNumber>
 <ChassisNumber>$ChassisNumber$</ChassisNumber>
 </CarIdent>
 <LicensePlate>$LicensePlate$</LicensePlate>
 <MarkModelCarRSACode>$MarkModelCarRSACode$</MarkModelCarRSACode>
 <OtherMarkModel>?</OtherMarkModel>
 <YearIssue>$YearIssue$</YearIssue>
 <TypeCar>$TypeCar$</TypeCar>
 <CatCar>$CatCar$</CatCar>
 <DocumentCar>$DocumentCar$</DocumentCar>
 <DocCarSerial>$DocCarSerial$</DocCarSerial>
 <DocCarNumber>$DocCarNumber$</DocCarNumber>
 <DocumentCarDate>$DocumentCarDate$</DocumentCarDate>
 <TicketCar>$TicketCar$</TicketCar>
 <TicketCarSerial>$TicketCarSerial$</TicketCarSerial>
 <TicketCarNumber>$TicketCarNumber$</TicketCarNumber>
 <TicketCarYear>$TicketCarYear$</TicketCarYear>
 <TicketCarMonth>$TicketCarMonth$</TicketCarMonth>
 <TicketDiagnosticDate>$TicketDiagnosticDate$</TicketDiagnosticDate>
 <EngCap>$EngCap$</EngCap>
 <MaxMass>$MaxMass$</MaxMass>
 <UnladenMass>$UnladenMass$</UnladenMass>
 <IsTaxi>$IsTaxi$</IsTaxi>
 <PasQuant>$PasQuant$</PasQuant>
 </CarPart>
 <PolicyOwner>
$StartPersonI$
 <PhysicalPerson>
 <IDCheckInsurerOwner>$IdCheckInsurer$</IDCheckInsurerOwner>
 <Country>$CountryI$</Country>
 <PersonDocument>
 <DocPerson>$DocPersonI$</DocPerson>
 <Serial>$SerialI$</Serial>
 <Number>$NumberI$</Number>
 </PersonDocument>
 <PersonNameBirthHash>### $PersonNameBirthI$</PersonNameBirthHash>
 <Address>$AddressI$</Address>
 <AddressRSACode>$AddressRSACodeI$</AddressRSACode>
 <Email>$Email$</Email>
 </PhysicalPerson>
$EndPersonI$
$StartJuridicalI$
                  <JuridicalPerson>
                     <IDCheckInsurerOwner>$IdCheckInsurer$</IDCheckInsurerOwner>
                     <OrgID>
                        <Resident>$ResidentI$</Resident>
                        <INN>$innI$</INN>
                        <OrgName><![CDATA[$JFNameI$]]></OrgName>
                     </OrgID>
                     <Address>$AddressI$</Address>
                     <AddressRSACode>$AddressRSACodeI$</AddressRSACode>
                  </JuridicalPerson>
$EndJuridicalI$
 </PolicyOwner>
 <CarOwner>
$StartPersonO$
 <PhysicalPerson>
 <IDCheckInsurerOwner>$IdCheckOwner$</IDCheckInsurerOwner>
 <Country>$CountryO$</Country>
 <PersonDocument>
 <DocPerson>$DocPersonO$</DocPerson>
 <Serial>$SerialO$</Serial>
 <Number>$NumberO$</Number>
 </PersonDocument>
 <PersonNameBirthHash>### $PersonNameBirthO$</PersonNameBirthHash>
 <Address>$AddressO$</Address>
 <AddressRSACode>$AddressRSACodeO$</AddressRSACode>
 <OwnerKBM>$OwnerKBM$</OwnerKBM>
 <AreaKLADR>$AreaKLADR$</AreaKLADR>
 </PhysicalPerson>
$EndPersonO$
$StartJuridicalO$
                  <JuridicalPerson>
                     <IDCheckInsurerOwner>$IdCheckOwner$</IDCheckInsurerOwner>
                     <OrgID>
                        <Resident>$ResidentO$</Resident>
                        <INN>$innO$</INN>
                        <OrgName><![CDATA[$JFNameO$]]></OrgName>
                     </OrgID>
                     <Address>$AddressO$</Address>
                     <AddressRSACode>$AddressRSACodeO$</AddressRSACode>
                     <OwnerKBM>$OwnerKBM$</OwnerKBM>
                     <AreaKLADR>$AreaKLADR$</AreaKLADR>
                  </JuridicalPerson>
$EndJuridicalO$
 </CarOwner>
$StartDrivers$
 <DriversPart>
 $DriversPart$
 </DriversPart>
$EndDrivers$
 </DraftPolicyRequest>
 </request>
 </eos:loadPolicy>
 </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 243 as id_ext_type, $IsAssynchron$ as IsAssynchron, 0 as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID, $NextStatusIDFailure$ as NextStatusIDFailure, $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss  from sogins.EOSAGOOBJECTS eo inner join contractins ci on ci.contractid = eo.objectid inner join contractins_hist cih on cih.contractid = ci.contractid inner join insobject io on io.insobjectid = ci.insobjectid  inner join INSOBJECT_HIST ioh On ioh.INSOBJECTID = io.INSOBJECTID left join ADDITIONALINSAGREEMENT aa On aa.CONTRACTID = ci.CONTRACTID inner join TRANSPORTMODEL tm on tm.transportmodelid = io.transportmodelid inner join TRANSPORTMODELRSA tmrsa on tmrsa.transportmodelrsaid = tm.transportmodelrsaid inner join transporttype tt on tt.transporttypeid = io.transporttypeid inner join TSPASSPORTTYPE tspt on tspt.tspassporttypeid = io.regcertiftypedocid_lv inner join DOCTS dts on dts.doctsid = io.docts inner join TSPASSPORTTYPE tsts on tsts.tspassporttypeid = dts.viddocts inner join face fi on fi.faceid = ci.insurerid left join faceperson fip on fip.faceid = fi.faceid inner join face fo on fo.faceid = io.ownerid_lv left join faceperson fop on fop.faceid = fo.faceid inner join address adr_ins on adr_ins.addressid = ci.INSURERADDRESSID_LV inner join address adr_own on adr_own.addressid = io.owneraddressid_lv left join PASSPORTFACE pspt_ins ON pspt_ins.passportfaceid = ci.INSURERCERTIFICATEID_LV left join PASSPORTFACE pspt_own ON pspt_own.passportfaceid = io.ownercertificateid_lv left join PASSPORTTYPE pt_ins on pt_ins.passporttypeid = pspt_ins.passporttypeid left join PASSPORTTYPE pt_own on pt_own.passporttypeid = pspt_own.passporttypeid where eo.eosagoobjentityid = $ObjEntityID$ and eo.eosagoobjstatusid = $StatusID$ and (SELECT sum(eo1.eosagoobjstatusid) from EOSAGOOBJECTS eo1 where eo1.contractinsid = eo.contractinsid and eo1.eosagoobjentityid <> $ObjEntityID$) = 0 and cih.statedate = (Select Max(StateDate) Column1 From CONTRACTINS_HIST Where CONTRACTID = ci.CONTRACTID and StateDate <= Nvl(aa.STARTDATE, ci.VALIDDATE)) and ioh.StateDate = (Select Max(StateDate) Column1 From INSOBJECT_HIST Where INSOBJECTID = io.INSOBJECTID and StateDate <= Nvl(aa.STARTDATE, ci.VALIDDATE))	DiasoftTestingConnectionString	ORACLE	4	loadPolicy	1	9	20	90	86
244	-1	1	2	1	ОценкаПродавца	09.09.2015 13:40:00	СМС с предложение оценить продавца	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	1	True	Спасибо, что воспользовались услугами СК "Согласие". Помогите повысить нам уровень сервиса, оценив качество работы продавца на странице https://b2b.soglasie.ru/r/%23/$MINI_STR$	SELECT 'STARTSELECT' AS STARTSELECT, 244 as id_ext_type, ci.insurerid as idx_client, to_char(sysdate, 'yyyymmdd') as id_ext, ci.CONTRACTID, seller1id, rcfd.respfincenterid "ЦФО ИД", cfo.brief "ЦФО", replace(f.PhoneMobile, ',', ';') AS PhoneMobile from contractins ci inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join RELRFCDEPARMENT rcfd on rcfd.departmentid = ci.departid inner join RESPFINCENTER cfo on cfo.respfincenterid = rcfd.respfincenterid where ((SELECT min(log1.logdate) FROM b2b_universal_log log1 where log1.objectid = ci.contractid and log1.entityid = 1917) between sysdate - 1 / 24 / 60 * $MINUTES_MAX$ and sysdate - 1 / 24 / 60 * $MINUTES_MIN$) and to_number(to_char(sysdate, 'hh24')) between $HOUR_START$ and $HOUR_END$ and rcfd.respfincenterid in ($CFO_SELECTED$) and ci.insproductid in ($PRODUCT_SEL$) 	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
245	6	2	2	0	ИпотекаБанкПролонгПисьмо	21.09.2015 13:15:00	Письмо с предложением продлить договор	Ручная печать писем. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть почтовыый индекс.	0	True	prolongationBank.dotx	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, saleofficeid, insproductid, policyno_lv, enddate, validdate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, ci.contractid as id_ext, '№' || trim(d.number_) as ContractNumber, 0 AS SSB,0 AS external_sys_id, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, nvl(f.PhoneMobile,'0') as PhoneMobile, nvl(f.Email,'0') as Email, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText,f.faceid as idx_client,6 as id_ext_type,ci.contractid as idx_contract, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, CASE WHEN InStr(adr.address,adr.index_)=0 then adr.index_ || ', ' || adr.address ELSE adr.address END as Address,fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO, CASE nvl(fp.secondname, '') WHEN '' THEN '' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 1, 2))  WHEN 'ич' THEN 'Уважаемый' WHEN 'на' THEN 'Уважаемая' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 3, 4))  WHEN 'оглы' THEN 'Уважаемый' WHEN 'кызы' THEN 'Уважаемая' ELSE '' END END END  || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as reference, case os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') ELSE  CASE WHEN nvl(af.nameonprinter,'0')<>'0' THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.nameonprinter) ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.name) END END END ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(efp.lastname, '') || ' ' || nvl(efp.firstname, '') || ' ' ||  nvl(efp.secondname, '') END as Seller, CASE os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN CASE  WHEN nvl(af.phonemobile, '0') <> '0' THEN 'тел.: ' || af.phonemobile ELSE CASE WHEN nvl(af.phone2, '0') <> '0' THEN  'тел.: ' || af.phone2 ELSE ' ' END END ELSE  CASE WHEN nvl(af.phone1, '0') <> '0' THEN 'тел.: ' || af.phone1 ELSE ' ' END END END ELSE CASE  WHEN nvl(ef.phonemobile, '0') <> '0' THEN  'тел.: ' || ef.phonemobile ELSE CASE WHEN nvl(ef.phone2, '0') <> '0' THEN 'тел.: ' || ef.phone2 ELSE ' ' END END END as SellerPhone, CASE when nvl(io.transportmarkid,0)=0 then ' ' else 'на застрахованное Вами транспортное средство ' || nvl(tm.name,'') || ' ' end as MarkModel, CASE WHEN ci.insproductid IN (93,216,86,298) THEN 'auto.gif' ELSE CASE WHEN ci.insproductid IN (136,97,292,332,333) THEN 'property.gif' ELSE  CASE WHEN ci.insproductid IN (88,153) THEN 'dms.gif' ELSE 'default.gif' END END END as ProductIco, ci.validdate As ValidDate,ci.enddate as expiredDate, ip.name as Product, 0 AS ESB from ci inner join sogins.document d on d.documentid=ci.contractid left join sogins.osagosalesoffice oso on oso.saleofficeid=ci.saleofficeid  inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid=ftmp.faceid inner join sogins.face f on f.faceid= nvl(ftmp.mainfaceid,ftmp.faceid) inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id  left join sogins.agent sa on sa.agentid = os.faceid  left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.employee se on se.employeeid=os.faceid left join sogins.face ef on ef.faceid=se.faceid left join sogins.faceperson efp on efp.faceid=ef.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid inner join sogins.address adr on adr.faceid=f.faceid left join sogins.insobject io on io.insobjectid=ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid=io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid=io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ and case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) And adr.addressid =(SELECT max(adr1.addressid) FROM sogins.address adr1 where adr1.faceid = f.faceid and adr1.adresstypeid in (1,2,3) and nvl(adr1.index_, '0') <> '0' and nvl(house,' ')<>' ' ) /* ПРОВЕРКА УБРАНА 20.05.2016 Кузнецов В. AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) */ and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiaConnStrForPrinting	ORACLE	1	NULL	0	4	40	0	99
246	2	1	2	1	ПролонгацияИпБанк	21.09.2015 15:39:00	СМС с напоминанием об окончании договора. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен.	0	True	$Обращение$, действие Вашего полиса №$НомерБСО$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$. Для продления обратитесь в офис нашей компании по тел. 8 (495) 739 0101 доб. 75445 или 75858 С уважением, СК Согласие.	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid))*NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, 0 as SKIP_IF_EMAIL, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 246 as id_ext_type, ci.contractid as idx_contract, replace(f.PhoneMobile, ',', ';') AS PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and (CASE WHEN to_char(sysdate, 'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND f.PhoneMobile is not null and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 70 WHEN 86 THEN 50 ELSE 1 END DESC	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
247	59	1	2	1	ПролонгацияИпБанкСрок2	21.09.2015 15:39:00	СМС с напоминанием об окончании договора. Срок 2.	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Телефон сначала заявитель по последнему убытку, где тип документа НЕ «Заявление на возмещение вреда» (ИД <> 55), потом страхователь.	0	True	$Обращение$, действие Вашего полиса №$НомерБСО$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$. Для продления обратитесь в офис нашей компании по тел. 8 (495) 739 0101 доб. 75445 или 75858 С уважением, СК Согласие.	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, 0 as SKIP_IF_EMAIL, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 247 as id_ext_type, ci.contractid as idx_contract, replace (ic.declarantphone,',',';') || ';' || replace(f.PhoneMobile, ',', ';') AS PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid left join sogins.inscase ic on ic.contractinsid=ci.contractid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and (CASE WHEN to_char(sysdate, 'D') IN ($WEEKDAYS_ONLY$) THEN 1 else 0 END) = 1 AND (ic.inscaseid=(SELECT MAX(ic1.inscaseid) from sogins.inscase ic1 inner join sogins.losso lo1 on lo1.inscaseid=ic1.inscaseid inner join sogins.damagecompensation dc on dc.documentid=lo1.damagecompensationid inner join sogins.document d1 on lo1.damagecompensationid=d1.documentid where ic1.contractinsid = ci.contractid and d1.documentkindid<>55) or ic.inscaseid is null) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND (ic.declarantphone is not null OR f.PhoneMobile is not null) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 70 WHEN 86 THEN 50 ELSE 1 END DESC	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
248	61	1	2	1	Тула.Продл.Ипотека.Срок1	02.10.2015 9:49:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4872) 703-700 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
249	66	1	2	1	Тула.Продл.Ипотека.Срок2	02.10.2015 9:49:00	СМС с напоминанием об окончании договора в филиалах. Срок 1	Автомат Job Neptune (crm_functions.vbs) 11-00 (Выравнивает время отправки с МСК исходя из часового пояса филиала). 1С. ФЛ. Не расторгнут. Полностью оплачен. Есть мобильный телефон.	0	True	$Обращение$, действие Вашего полиса №$НомерДоговораПолностью$ заканчивается $ДатаОкончанияДоговора$.$НомераСвязанныхДоговоров$ Информация о продлении по тел. 8 (4872) 703-700 С уважением, СК «Согласие».	DECLARE @RC int;DECLARE @ГруппировкаФилиалБаза nvarchar(4000);DECLARE @КатегорияБаз nvarchar(20);DECLARE @ТекстЗапроса nvarchar(max);DECLARE @ИмяТбл nvarchar(128);DECLARE @СписокОшибок varchar(2000);set @ИмяТбл = 'tempSMS';set @ГруппировкаФилиалБаза = '$ORGNAME$';set @КатегорияБаз = 'рабочая';set @ТекстЗапроса = 'DECLARE @dayz varchar(8); DECLARE @ag_id varchar(8); DECLARE @br_id varchar(8); SET @dayz = CONVERT(varchar(8), GETDATE(), 112); SET @ag_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Агент''); SET @br_id = (SELECT [ИДМД] FROM [dbo].[Метаданные] WHERE [ПолноеИмя] = ''Справочник.ДоговораСтрахования.Брокер''); SELECT 0 AS MARKER, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, CAST(''@КодФилиала'' AS VARCHAR(100)) AS orgsubcode, replace(kontr.ТелефонМобильный, '','', '';'') AS PhoneMobile, kontr.Email,ds.ДатаОкончания as expiredDate,RTRIM(ds.Наименование) AS ContractNumber, $DATE_SHIFT$ as date_shift, ''$PRODUCT_SEL_SHIFT$'' as PRODUCT_SEL_SHIFT, LTRIM(RTRIM(ds.Ссылка)) ''id_ext'', 61 ''id_ext_type'', 0 ''idx_client'', LTRIM(RTRIM(kontr.Ссылка)) ''external_sys_id'', kontr.Наименование ''FIO'', [dbo].[ПолучитьКонстанту] (''Константа.ЧасовойПояс'', CONVERT(VARCHAR(8), GETDATE(), 112)) ''TZ'' FROM [dbo].[Справочник.Контрагенты] kontr LEFT JOIN [dbo].[Справочник.ДоговораСтрахования] ds ON ds.Страхователь = kontr.Ссылка LEFT JOIN [dbo].[Справочник.ОбъектыСтрахования] obj ON ds.Ссылка = obj.Владелец LEFT JOIN [dbo].[Справочник.ВидыСтрахования] vs ON ds.ВидСтрахования = vs.Ссылка LEFT JOIN [dbo].[Справочник.Контрагенты] kurator ON ds.Сотрудник = kurator.Ссылка LEFT JOIN (SELECT zayav_ub.Договор, sum(1) kol_ub FROM [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_ub GROUP BY zayav_ub.Договор) ub ON ub.Договор = ds.Ссылка LEFT JOIN (SELECT temp.ds_id ds_po_ub, sum(sum_ub) sum_ub FROM (SELECT zayav_na_vypl.Договор ds_id, sum_ sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеУбыточностиСтрах] zayav_na_vypl ON zayav_na_vypl.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 1. 1. '', '' 22. 1. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '') UNION ALL SELECT zayav_na_vozv.Договор ds_id, (sum_ * (- 1)) sum_ub FROM [dbo].[_1SENTRY] pr LEFT JOIN [dbo].[Документ.ЗаявлениеНаВозврат] zayav_na_vozv ON zayav_na_vozv.Ссылка = pr.DTSC2 LEFT JOIN [dbo].[_1SACCS] dt ON pr.ACCDTID = dt.ID LEFT JOIN [dbo].[_1SACCS] kt ON pr.ACCKTID = kt.ID WHERE dt.SCHKOD IN ('' 22. 5. 1. '', '' 22. 5. 2. '') AND kt.SCHKOD IN ('' 50. 1.'', '' 51. '')) temp GROUP BY temp.ds_id) sum_ub ON sum_ub.ds_po_ub = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, ag.Наименование Наименование, ag.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] ag WHERE period_rekv.value = ag.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @ag_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @ag_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) ag_ist ON ag_ist.ident = ds.Ссылка LEFT JOIN (SELECT ds.Ссылка ident, br.Наименование Наименование, br.Телефоны Телефоны FROM [dbo].[_1SCONST] period_rekv, [dbo].[Справочник.ДоговораСтрахования] ds, [dbo].[Справочник.Агенты_Брокеры] br WHERE period_rekv.value = br.Ссылка AND period_rekv.objid = ds.Ссылка AND period_rekv.id = @br_id AND period_rekv.row_id = (SELECT TOP 1 period_rekv.row_id FROM [dbo].[_1SCONST] period_rekv WHERE period_rekv.objid = ds.Ссылка AND period_rekv.date <= @dayz AND period_rekv.id = @br_id ORDER BY period_rekv.date DESC, period_rekv.time DESC, period_rekv.row_id DESC)) br_ist ON br_ist.ident = ds.Ссылка WHERE ds.ПометкаУдаления = 0 and DATEDIFF ( d, ds.ДатаНач, ds.ДатаОкончания) >=$MIN_PERIOD$ AND ds.ДатаОкончания >= GETDATE()+ $INFORM_FOR_DAYS_MIN$  and ''d_rep_s''=''d_rep_s'' AND ds.ДатаОкончания <= GETDATE()+ $INFORM_FOR_DAYS_MAX$ and ''d_rep_e''=''d_rep_e'' AND ds.ДатаДосроч = ''17530101'' and ''p_rep_s''=''p_rep_s'' AND vs.Код IN ($PRODUCT_SEL$) AND (ds.СтраховаяПремия = 0 OR ds.СтраховаяПремия >= $MIN_PREMIUM$) AND (vs.Код=1311 OR IsNull(ub.kol_ub,0) < $NLOSS_LIMIT$ OR IsNull(sum_ub.sum_ub,0)/(IsNull(ds.СтраховаяПремия,0)+1) <= CONVERT(float,''$KUB_LIMIT$'') ) and LEN(IsNull(kontr.ТелефонМобильный, ''''))>=10 and ''p_rep_e''=''p_rep_e'' ORDER BY CASE vs.Код WHEN 501 THEN 100 WHEN 201 THEN 70 WHEN  1311 THEN 50 ELSE 1 END DESC'; DECLARE @ISTBL int; SET @ISTBL =( SELECT CASE WHEN EXISTS  (SELECT   *  FROM  INFORMATION_SCHEMA.TABLES WHERE (TABLE_NAME = @ИмяТбл)) THEN 1  ELSE 0 END); if @ISTBL=1 begin EXECUTE('DROP TABLE ' + @ИмяТбл +';') END;EXECUTE @RC = [consolid].[dbo].[ВыполнитьЗапросВоВсехБазах] @ГруппировкаФилиалБаза  ,@КатегорияБаз  ,@ТекстЗапроса  ,@ИмяТбл  ,@СписокОшибок OUTPUT	_1CConnectionString	MSSQL	1	NULL	1	5	20	90	99
250	-1	1	1	1	ТФМ-СсылкаОплатаEmail	28.10.2015 15:06:00	Электронное письмо со ссылкой на оплату договора на сайте ( с привязкой карты)	Автомат Job Neptune (Comm5min.vbs)). Диасофт.  Есть email.	1	True	<style>td {font-size:16px;font-family:arial;color:#77787b;} span {font-family:arial;} table {width:700px;margin:0 auto;border-collapse:collapse;} </style><table cellpadding=0; cellspacing=0; style="background:#fff5f0;" ><tr><td style="width:700px;height:250px;"><img src="http://www.soglasie.ru/upload/mail/ny/head_photo.png" style="width:700px;height:250px;display:block;"></td></tr><tr><td><table cellpadding=0; cellspacing=0; ><tr><td style="padding:0 45px;"><table style="width: 609px;"><tr><td style="text-align: center;font-size: 24px;line-height: 26px; padding:20px 0 0 0;">$Обращение$!</td></tr><tr><td style="line-height:1.7;padding:15px 0;">Стоимость страхования по договору <a href="" style="pointer-events:none;text-decoration:none;cursor:nw-resize;">#каско_рассрочка</a> - <span style="font-weight: bold;">$Премия$ руб.</span>,<br>срок действия с <span style="font-weight: bold;">$ДатаНачала$ г.</span> по <span style="font-weight: bold;">$ДатаОкончания$ г.</span></td></tr><tr><td style="line-height:1.7;padding:0 0 15px 0;">Для оплаты полиса банковской картой, пожалуйста, перейдите по <a href="http://www.soglasie.ru/p/?q=$КодОплатыШифр$" style="color:#f5822b;" target="_blank">ссылке</a>.<br> После оплаты на Вашу электронную почту будет направлен страховой полис.</td></tr><tr><td style="line-height:26pх;">Внимание! Ссылка действительна в течение 1 суток с момента направления!</td></tr></table></td><tr style="display: block; "><td style="display: block;width: 610px;padding: 17px 45px 25px 45px;"><table style="width:610px;height: 106px;background-color:#f5822b;border-collapse:collapse;"><tr><td style="vertical-align: middle;padding:15px 27px 15px 37px;"><img src="http://www.soglasie.ru/upload/mail/ny/icon_house.png" style="display:block;"></td><td style="vertical-align: middle;padding:0 30px 0 0;"><span style="font-size:16px;line-height:26px;color:#fff;margin:0;">Узнайте, как застраховать имущество за 500 руб. в месяц по телефону 8 800 755 0001 или оставьте заявку на <a href="http://www.soglasie.ru" style="font-size:16px;line-height:26px;color:#fff;margin:0;text-decoration:none;border-bottom: 2px solid #fff;" target="_blank">сайте</a>.</span></td></tr></table></td></tr><tr><td style="padding: 0 45px;line-height:1.7;text-align:right;">С уважением,</td></tr><tr><td style="padding:0 45px 20px 45px;line-height:1.7;text-align:right;">Страховая компания «Согласие»</td></tr><tr style="text-align:center;height: 1px;"><td style="width:610px;height:1px;background-margin:auto;display:block;"></td></tr><tr><td style="padding:25px 0 25px 0;"><table style="width:700px;"><tr><td style="text-align: left;padding:0 0 0 45px;"><span style="font-size:28px;line-height: 26px;">8-800-755-00-01</span><br><a href="http://www.soglasie.ru" style="font-size:18px;line-height: 26px;color:#F76A1C;" target="_blank">www.soglasie.ru</a></td><td style="width: 300px;text-align: right;padding:0 45px 0 0;font-size:12px;line-height: 1;">ООО «Страховая компания «Согласие»<br>Центральный офис: г. Москва, ул. Гиляровского, 42<br>Лицензия ЦБ РФ от 25.05.2015 СИ № 1307, СЛ №1307, ОС №1307-03, ОС №1307-04, ОС №1307-05</td></tr></table></td></tr><tr ><td style="padding:0 45px 30px 45px;width:610px;font-size:13px;text-align: right;"><a href="https://www.facebook.com/soglasie.sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/fb.png" style="padding-right:15px;" ></a><a href="http://vk.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/vk.png" style="padding-right:15px;" ></a><a href="https://twitter.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/tw.png"></a></td></tr></table></td></tr></table>	select DISTINCT 'STARTSELECT' AS STARTSELECT, 250 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.startdate_lv , ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile,f.Email, $ActionID$ as LogActionID, $EntityID$ as LogEntityID from sogins.contractins ci  inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid  where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=1 /*Договор первичный*/ and ci.signdate > sysdate - $DayMin$ /* чтобы не отбирать лишних договоров, отбираем только с датой подписания*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	NULL	0	2	25	90	99
251	-1	1	1	1	ТФМ-СсылкаОплата	28.10.2015 16:03:00	СМС со ссылкой на оплату договора на сайте ( с привязкой карты)	Автомат Job Neptune (Comm5min.vbs)). Диасофт. 	1	True	Уважаемый клиент! Стоимость страхования по договору %23каско_рассрочка - $Премия$ руб, срок действия с $ДатаНачала$ по $ДатаОкончания$.  Оплатите полис банковской картой по ссылке http://www.soglasie.ru/p/?q=$КодОплатыШифр$ Ссылка действительна в течение 1 суток. Спасибо за доверие, СК Согласие.	select DISTINCT 'STARTSELECT' AS STARTSELECT, 251 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, 'id=9000000' || '-1843-' || ci.contractid as PayCode, f.Email, $ActionID$ as LogActionID, $EntityID$ as LogEntityID from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid  where ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=1 /*Договор первичный*/ and f.PhoneMobile is not null and ci.signdate > sysdate - $DayMin$ /* чтобы не отбирать лишних договоров, отбираем только с датой подписания*/	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
252	-1	1	1	1	ТФМ-ИнфоОтправленаПФ	30.10.2015 14:00:00	СМС информирование, что на email клиента отправлена ПФ договора КАСКО на месяц	Автомат Job Neptune (Comm5min.vbs)). Диасофт. 	1	True	Уважаемый клиент! На указанный вами адрес электронной почты, направлен Ваш договор %23каско_рассрочка	select DISTINCT 'STARTSELECT' AS STARTSELECT, 252 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid  where ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and f.PhoneMobile is not null and ci.signdate >= trunc(sysdate) - $DayMin$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
253	-1	1	1	1	СсылкаОплатаСайт	03.11.2015 12:25:00	СМС со ссылкой на оплату договора на сайте	Автомат Job Neptune (Comm5min.vbs)). Диасофт. 	1	True	Уважаемый клиент! Для оплаты страхового договора №$НомерДоговораПолностью$ банковской картой перейдите по ссылке: http://www.soglasie.ru/order/payment/soglasie/?q=$КодОплатыШифр$. Спасибо за доверие, СК Согласие.	select DISTINCT 'STARTSELECT' AS STARTSELECT, 253 as id_ext_type, cl.contrlistfromagentid contrlistfromagentid, cast(ext.data.EXTRACT ('//payment_phone/text()').getStringVal() AS VARCHAR2(20)) PhoneMobile, cast(ext.data.EXTRACT ('//payment_mail/text()').getStringVal() AS VARCHAR2(1000)) Email,  cast(ext.data.EXTRACT ('//type_pay/text()').getStringVal() AS NUMBER(4)) type_pay, cl.contrlistfromagentid || '|' || cast(ext.data.EXTRACT ('//payment_phone/text()').getStringVal() AS VARCHAR2(20)) || cast(ext.data.EXTRACT ('//payment_mail/text()').getStringVal() AS VARCHAR2(1000)) || cast(ext.data.EXTRACT ('//payment_version/text()').getStringVal() AS NUMBER(4)) as id_ext, ci.insurerid as idx_client, ci.contractid as idx_contract , $ActionID$ as LogActionID, $EntityID$ as LogEntityID from contractins ci inner join document d on d.documentid=ci.contractid join b2b_extended_data ext on ext.objectid = ci.contractid and ext.tableid = 1351 left join additionalinsagreement a on a.contractid = ci.contractid left join document ad on ad.documentid = a.documentid join contrlistfromagent cl on cl.contrid = ci.contractid and cl.contrtypeid <> 21 /* тип записи ЖРА не равен очередной платеж */ and ext.data.EXTRACT ('//payment_version/text()').getStringVal() is not null and ext.data.EXTRACT ('//type_pay/text()').getStringVal() = 8 /* тип оплаты - оплата на сайте */ and ( ad.documentid is null or (ad.documentid is not null and cl.dopcontractnumber = ad.number_ and cl.contrtypeid = 2) /* запись ЖРА по ДС */ ) where ci.statusid <> 52 and ( a.documentid is null or a.startdate = ( select max(asd.startdate) from additionalinsagreement asd where asd.contractid = ci.contractid  and a.statusid <> 52 /* ДС в статусе отличном от предварительный */ ) ) and ci.signdate > sysdate - $DayMin$ and  (ci.signdate > sysdate - $DayMin$ or a.signdate > sysdate - $DayMin$)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
254	-1	1	1	1	СсылкаОплатаСайтEmail	03.11.2015 12:25:00	СМС со ссылкой на оплату договора на сайте	Автомат Job Neptune (Comm5min.vbs)). Диасофт. 	1	True	<table border=0 width=800px style=width:800px;><tr><td><p><b>Уважаемый клиент!</b></p><p>Стоимость страхования по договору $НомерДоговораПолностью$ составляет $Премия$ руб. <p> Для оплаты полиса банковской картой, пожалуйста, перейдите по ссылке: <a href="http://www.soglasie.ru/order/payment/soglasie/?q=$КодОплатыШифр$">http://www.soglasie.ru/order/payment/soglasie/?q=$КодОплатыШифр$</a> </p></td></tr></table>	select DISTINCT 'STARTSELECT' AS STARTSELECT, 254 as id_ext_type, cl.contrlistfromagentid contrlistfromagentid, cast(ext.data.EXTRACT ('//payment_phone/text()').getStringVal() AS VARCHAR2(20)) PhoneMobile, cast(ext.data.EXTRACT ('//payment_mail/text()').getStringVal() AS VARCHAR2(1000)) Email,  cast(ext.data.EXTRACT ('//type_pay/text()').getStringVal() AS NUMBER(4)) type_pay, cl.contrlistfromagentid || '|' || cast(ext.data.EXTRACT ('//payment_phone/text()').getStringVal() AS VARCHAR2(20)) || cast(ext.data.EXTRACT ('//payment_mail/text()').getStringVal() AS VARCHAR2(1000)) || cast(ext.data.EXTRACT ('//payment_version/text()').getStringVal() AS NUMBER(4)) as id_ext, ci.insurerid as idx_client, ci.contractid as idx_contract from contractins ci inner join document d on d.documentid=ci.contractid join b2b_extended_data ext on ext.objectid = ci.contractid and ext.tableid = 1351 left join additionalinsagreement a on a.contractid = ci.contractid left join document ad on ad.documentid = a.documentid join contrlistfromagent cl on cl.contrid = ci.contractid and cl.contrtypeid <> 21 /* тип записи ЖРА не равен очередной платеж */ and ext.data.EXTRACT ('//payment_version/text()').getStringVal() is not null and ext.data.EXTRACT ('//type_pay/text()').getStringVal() = 8 /* тип оплаты - оплата на сайте */ and cast(ext.data.EXTRACT('//payment_mail/text()').getStringVal() AS VARCHAR2(1000)) is not null and ( ad.documentid is null or (ad.documentid is not null and cl.dopcontractnumber = ad.number_ and cl.contrtypeid = 2) /* запись ЖРА по ДС */ ) where ci.statusid <> 52 and ( a.documentid is null or a.startdate = ( select max(asd.startdate) from additionalinsagreement asd where asd.contractid = ci.contractid  and a.statusid <> 52 /* ДС в статусе отличном от предварительный */ ) ) and ci.signdate > sysdate - $DayMin$ and  (ci.signdate > sysdate - $DayMin$ or a.signdate > sysdate - $DayMin$)	DiasoftConnectionString	ORACLE	1	NULL	1	2	25	90	99
255	-1	1	2	1	АндерЗаявкаВходEmail	10.11.2015 0:00:00	Электронное письмо андеррайтерам о поступлении новой заявки СОА	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	1	True	СОА: Поступила первичная заявка № $НомерЗаявки$. $ТипСогласования$. $Филиал$.	SELECT 'STARTSELECT' AS STARTSELECT, 255 as id_ext_type, b.uwbidid as idx_client, to_char(b.sentdate, 'ddmmyyyyhh24miss') as id_ext, 0 as idx_loss, s.mobilephone as PhoneMobile, s.email FROM sogins.uwbid b join sogins.uwbiddictsettings s on s.processtypeid = b.processtypeid and s.instypeid = b.instypeid and s.insproductid = b.insproductid and s.approvaltypeid = b.approvaltypeid WHERE b.status = 3 and b.isactive = 1 and b.acceptorid is null and (sysdate - b.sentdate) * 24 <= $HOURS_INT$ and s.email is not null	DiasoftConnectionString	ORACLE	1	NULL	1	2	25	90	99
257	-1	1	1	1	ТФМ-ПФEmail	17.11.2015 15:00:00	На email клиента отправляется ПФ договора КАСКО.Автопл@теж	Автомат Job Neptune (KASKOMonth.vbs) 11-00. Диасофт. Договор не первичный и подписан. Внимание! Получение ПФ из сервиса печати hardcode в скрипте KASKOMonth.vbs! Не включать рассылку в стандартные job-ы!	1	True	<style>p, td, ol, li {font-family:Futuris Light Cyrillic, Arial;font-size:14px;}</style>
<table width=80%><tr></td>
<p><b>$Обращение$!</b><br>Спасибо, что выбрали страховую компанию «Согласие»!<br>В прикрепленных файлах к данному письму находится договор #каско_рассрочка , а также правила страхования и инструкция по просмотру электронно-цифровой подписи.
<p>
<b>Вы оформили инновационный страховой продукт #каско_рассрочка, который позволит:</b>
<ol><li>Автоматически оплачивать страхование небольшими платежами без посещения офиса страховой компании
Ежемесячно за 5 дней до даты списания средств с банковской карты Вам будет приходить смс с указанием размера платежа. Вам только необходимо убедится, что на банковской карте достаточно средств. 
Если на момент списания на банковской карте будет недостаточно средств, Вы получите смс со ссылкой, перейдя по которой сможете привязать новую карту.</li>
<li>Ежемесячно снижать стоимость страховки
Если Вы безубыточный клиент, ежемесячно стоимость договора будет снижаться на 1% от предыдущего платежа. </li>
<li>Самостоятельно выбирать срок страхования  Вашего автомобиля 
Максимальный период страхования ограничен только сроком эксплуатации Вашего автомобиля (для автомобилей иностранного производства не более 9 лет, для отечественного - не более 7 лет).</li>
<li>Получать договор страхования на электронную почту и не заботиться о сохранении полиса в бумажном виде
После списания средств на Ваш адрес электронной почты будет приходить договор страхования, который  также будет храниться в электронном виде в Вашем личном кабинете.</li>
<li>Прекратить страхование в любой момент</li>
</ol>
</p>
<p>
 Если Вы хотите отказаться от страховой защиты, то Вы также сможете сделать это дистанционно. Для этого нужно позвонить в колл-центр (указать номер), оставить заявку и договор страхования не будет пролонгирован на следующий период.  
- Подробнее с условиями страхования по продукту #каско_рассрочка Вы сможете ознакомиться на сайте СК «Согласие» 
<br>__________________________________________________________________________________________
<br>
Желаем удачи на дорогах!
Благодарим за Ваш выбор! 
</td></tr></table>
	select DISTINCT 'STARTSELECT' AS STARTSELECT, 257 as id_ext_type, ci.contractid as id_ext, ci.startdate_lv, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.Email, '\\fs-scandoc\StationScan_02' || CHR(36) || '\ЖРА\' || (select org.subcode from orgstructure org where org.orgstructureid = (select doc.endivision_orgstructureid from document doc where doc.documentid=d.documentid)) || '_СтрахИВ_КСД_' || REPLACE(d.Number_,'/','~') || '.pdf' FileName FROM sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and ci.startdate_lv >= trunc(sysdate) /*договор еще не просрочен - это достаточное условие временное условие */ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный*/ /* and f.PhoneMobile is not null 18.03.2016 - сбой оплаты - нет телефона */ and REGEXP_LIKE(nvl(f.email,'0'), '^(([a-z0-9_\-]+\.)*[a-z0-9_\-]+@([a-z0-9][a-z0-9\-]*[a-z0-9]\.)+[a-z]{2,4}\;?)+' || CHR(36),'i')) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1)	DiasoftConnectionString	ORACLE	1	https://b2b.soglasie.ru/upload/services/report	1	2	25	90	99
258	-1	4	1	1	ТФМ-Sign	18.11.2015 10:14:00	Переводит проект договора в статус подписан с помощью метода sign пакета пролонгации	Автомат Job Neptune (KASKOMonth.vbs) 11-00. Диасофт. Договор не первичный в проекте с полной оплатой. Внимание! Вызов метода подписания hardcode в скрипте KASKOMonth.vbs! Не включать рассылку в стандартные job-ы!	1	True	$REST_JSON$	select DISTINCT 'STARTSELECT' AS STARTSELECT, 258 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.Email, ci.premium_lv, (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid) as paysum from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and ci.startdate_lv < sysdate + $DayMin$ and ci.startdate_lv >= trunc(sysdate) /*договор еще не просрочен*/ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный*/ /* and f.PhoneMobile is not null 18.03.2016 - сбой оплаты - нет телефона */ and ci.premium_lv<>0 /*Премия не может быть равна 0, поскольку это означает, что договор рассторгнут*/ and ci.premium_lv = (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.isproject=0) /*Договор полностью оплачен (таблица эквайринга)*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	https://b2b.soglasie.ru/sogins/rest/prolongation/sign	1	7	20	90	2437
259	-1	4	1	1	ТФМ-Payment	18.11.2015 16:07:00	Оплачивает договор по связке кредитной карты (три последовательных метода: регистрация заказа, оплата по связке и проверка статуса заказа). Записывает информацию об оплате в таблицу эквайринга. В случае неудачи, записывается сумма оплаты по транзакции равная нулю, что является ключем для отбора коммуникаций для сообщений на пополнение/перепривязку карты	Автомат Job Neptune (KASKOMonth.vbs) 11-00. Диасофт. Договор не первичный, в проекте, без оплаты. Внимание! Уникального контекста для операции оплаты нет! Сколько раз будет вызвана коммуникация для НЕОПЛАЧЕННОГО договора, столько раз и будет выполняться оплата! Контекст записывается, как номер заказа платежной системы - БСО+Время. Внимание! Вызов метода оплаты и записи транзакции hardcode в скрипте KASKOMonth.vbs! Не включать рассылку в стандартные job-ы!	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:mer="http://engine.paymentgate.ru/webservices/merchant">
<soapenv:Body><mer:registerOrder>
<order merchantOrderNumber="$ИДЗаказаБанк$" amount="$СуммаОплаты$" currency="810" language="RU" description="$НомерДоговораПолностью$">
<returnUrl>https://b2b.soglasie.ru/CCMC/search.jsp</returnUrl>
<failUrl>https://b2b.soglasie.ru/CCMC/search.jsp</failUrl>
<clientId>$ИДКлиента$</clientId>
</order></mer:registerOrder>
</soapenv:Body>
</soapenv:Envelope>
###
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:mer="http://engine.paymentgate.ru/webservices/merchant">
   <soapenv:Body>
      <mer:paymentOrderBinding>
         <order mdOrder="???" bindingId="$ИДСвязкиКарты$" language="RU">
         </order>
      </mer:paymentOrderBinding>
   </soapenv:Body>
</soapenv:Envelope>
###
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:mer="http://engine.paymentgate.ru/webservices/merchant">
<soapenv:Body>      
<mer:getOrderStatusExtended>
         <order  language="RU">
            <merchantOrderNumber>$ИДЗаказаБанк$</merchantOrderNumber>
         </order>
      </mer:getOrderStatusExtended>
</soapenv:Body>
</soapenv:Envelope>
###
CRM.CRM_INSERT_Acquiring_payment|"vpaysum"#131#1#0#$СуммаОплатыРуб$; vEntityID#20#1#0#$ИДСущности$;vObjectID#20#1#0#$ИДДоговора$; vtransactionid#203#1#2000#???;vuserid#20#1#0#59224; vOrderId#203#1#2000#$ИДЗаказаБанк$
###
CRM.CRM_INSERT_Acquiring_payment|"vpaysum"#131#1#0#0; vEntityID#20#1#0#$ИДСущности$;vObjectID#20#1#0#$ИДДоговора$; vtransactionid#203#1#2000#???;vuserid#20#1#0#59224; vOrderId#203#1#2000#$ИДЗаказаБанк$
	select DISTINCT 'STARTSELECT' AS STARTSELECT, 259 as id_ext_type, REGEXP_SUBSTR (ci.policyno_lv, '-(\d{1,12})/', 1, 1, NULL, 1) || '-' || to_char(sysdate,'YYYYMMDDHH24MISS') as id_ext /*Внимание! Уникального контекста для операции оплаты нет! Сколько раз будет вызвана коммуникация для НЕОПЛАЧЕННОГО договора, столько раз и будет выполняться оплата! Контекст записывается, как номер заказа платежной системы - БСО+Время*/, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, d.number_ as DocMumber , f.PhoneMobile, f.Email, to_char(ci.enddate_lv, 'YYYY-MM-DD HH:MI:SS') as ExpDate, (ci.premium_lv - (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid))*100 as SumToPay /*сумма платежа должна быть в копейках*/, nvl((select pb.bindingid /*выбираем самую позднюю связку*/ from RELPAYBINDING rpb inner join paybinding pb on pb.paybindingid=rpb.paybindingid where rpb.bindingentityid=f.entityid and rpb.ACTUALOBJECTID=f.faceid and pb.createdate=(select max(pb1.createdate) from RELPAYBINDING rpb1 inner join paybinding pb1 on pb1.paybindingid=rpb1.paybindingid where rpb1.bindingentityid=f.entityid and rpb1.ACTUALOBJECTID=f.faceid)), 'nodata') as bindingid, ci.entityid as entityid, $UserID$ as UserID, (select ci1.CANCELDATE1 from sogins.contractins ci1 where ci.CONTRACTINSPARENT=ci1.contractid) IsActive  from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and ci.startdate_lv < sysdate + $DayMin$ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный*/ /* and f.PhoneMobile is not null 18.03.2016 - сбой оплаты - нет телефона */ and ci.startdate_lv >= trunc(sysdate) /*договор еще не просрочен*/ and (select ci1.CANCELDATE1 from sogins.contractins ci1 where ci.CONTRACTINSPARENT=ci1.contractid) is null /*предыдущий договор не расторгнут*/ and ci.CANCELDATE1 is null /* на всякий случай проверям флаг прекращения пролонгации и на проекте*/ and ci.premium_lv > (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.isproject=0) /*Договор не оплачен (таблица эквайринга). Кроме того! Иметь ввиду, что премия 0 - означает запрет к пролонгации*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	http://b2b.soglasie.ru:81/partners/paymentgate/soglasie_auto-api/merchant-ws	1	7	20	90	2437
260	-1	1	1	1	ТФМ-ПлатежНеПрошел	19.11.2015 15:07:00	Для транзакций по которым не прошел эквайринг платеж посылает смс сообщение с предложением пополнить или перепривязать карту	Автомат Job Neptune (KASKOMonth.vbs) 11-00. Диасофт. Договор не первичный в проекте без полной оплаты и самая последняя транзакция имеет сумму платежа 0 (т.е. последний платеж не прошел)	1	True	Уважаемый клиент! Не удалось списать с банковской карты $MaskPan$ платеж по договору %23каско_рассрочка. Проверьте баланс, срок действия карты или укажите данные другой  карты  по ссылке http://www.soglasie.ru/p/?q=$КодОплатыШифр$ При отсутствии платежа до $ДатаНачала$ договор не будет  пролонгирован. 	select DISTINCT 'STARTSELECT' AS STARTSELECT, 260 as id_ext_type, nvl((select aq.transactionid from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.paydate=(SELECT max(paydate) from sogins.acquiring aq1 where aq1.payentityid=ci.entityid and aq1.payobjectid=ci.contractid)),'nopayments') as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.Email, ci.premium_lv - (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid) as SumToPay, nvl((select aq.paysum from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.paydate=(SELECT max(paydate) from sogins.acquiring aq1 where aq1.payentityid=ci.entityid and aq1.payobjectid=ci.contractid)),-1) as LastPayment, ci.entityid as entityid, $UserID$ as UserID from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and ci.startdate_lv >= trunc(sysdate) /*Договор не просрочен*/ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный*/ and f.PhoneMobile is not null and ci.premium_lv > (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid) /*Договор не оплачен (таблица эквайринга)*/ and nvl((select aq.paysum from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.paydate=(SELECT max(paydate) from sogins.acquiring aq1 where aq1.payentityid=ci.entityid and aq1.payobjectid=ci.contractid and aq.isproject=0)),-1)=0 /*Последняя транзакция содержит 0 в сумме оплаты, что означает, что платеж по карте не прошел*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
261	-1	1	1	1	ТФМ-ПлатежНеПрошелEmail	19.11.2015 15:07:00	Для транзакций по которым не прошел эквайринг платеж посылает email с предложением пополнить или перепривязать карту	Автомат Job Neptune (KASKOMonth.vbs) 11-00. Диасофт. Договор не первичный в проекте без полной оплаты и самая последняя транзакция имеет сумму платежа 0 (т.е. последний платеж не прошел)	1	True	<style>td {font-size:16px;font-family:arial;color:#77787b;} span {font-family:arial;} table {width:700px;margin:0 auto;border-collapse:collapse;} </style> <table cellpadding=0; cellspacing=0; style="background:#fff5f0;" > <tr> <td style="width:700px;height:250px;"> <img src="http://www.soglasie.ru/upload/mail/ny/head_photo.png" style="width:700px;height:250px;display:block;"> </td> </tr> <tr> <td> <table cellpadding=0; cellspacing=0; > <tr> <td style="padding:0 45px;"> <table style="width: 609px;"> <tr> <td style="text-align: center;font-size: 24px;line-height: 26px; padding:20px 0 15px 0;">$Обращение$!</td> </tr> <tr> <td style="line-height:1.7;padding:0 0 15px 0;">К сожалению, не удалось списать с банковской карты $MaskPan$ платеж за следующий месяц страхования по договору <a href="" style="pointer-events:none;text-decoration:none;cursor:nw-resize;">#каско_рассрочка</a></td> </tr> <tr> <td style="line-height:1.7;padding:0 0 15px 0;">Пожалуйста, проверьте баланс карты, срок ее действия или укажите данные другой карты, перейдя по <a href="http://www.soglasie.ru/p/?q=$КодОплатыШифр$" style="color:#f5822b;" target="_blank">ссылке</a>.</td> </tr> <tr> <td style="line-height:1.7;padding:0 0 15px 0;">При отсутствии платежа до $ДатаНачала$ договор не будет пролонгирован. Для возобновления страхования потребуется повторное предоставление необходимого комплекта документов и проведение предстрахового осмотра.</td> </tr> </table> </td> <tr style="display: block; "> <td style="display: block;width: 610px;padding: 17px 45px 25px 45px;"> <table style="width:610px;height: 106px;background-color:#f5822b;border-collapse:collapse;"> <tr> <td style="vertical-align: middle;padding:15px 27px 15px 37px;"><img src="http://www.soglasie.ru/upload/mail/ny/icon_house.png" style="display:block;"></td> <td style="vertical-align: middle;padding:0 30px 0 0;"> <span style="line-height:26px;color:#fff;margin:0;">Узнайте, как застраховать имущество за 500 руб. в месяц по телефону 8 800 755 0001 или оставьте заявку на <a href="http://www.soglasie.ru" style="line-height:26px;color:#fff;margin:0;text-decoration:none;border-bottom: 2px solid #fff;" target="_blank">сайте</a>.</span> </td> </tr> </table> </td> </tr> <tr> <td style="padding: 0 45px;line-height:1.7;text-align:right;">С уважением,</td> </tr> <tr> <td style="padding:0 45px 20px 45px;line-height:1.7;text-align:right;">Страховая компания «Согласие»</td> </tr> <tr style="text-align:center;height: 1px;"> <td style="width:610px;height:1px;background-margin:auto;display:block;"></td> </tr> <tr> <td style="padding:25px 0 25px 0;"> <table style="width:700px;"> <tr> <td style="text-align: left;padding:0 0 0 45px;"> <span style="font-size:28px;line-height: 26px;">8-800-755-00-01</span><br> <a href="http://www.soglasie.ru" style="font-size:18px;line-height: 26px;color:#F76A1C;" target="_blank">www.soglasie.ru</a> </td> <td style="width: 300px;text-align: right;padding:0 45px 0 0;font-size:12px;line-height: 1;"> ООО «Страховая компания «Согласие»<br>Центральный офис: г. Москва, ул. Гиляровского, 42<br>Лицензия ЦБ РФ от 25.05.2015 СИ № 1307, СЛ №1307, ОС №1307-03, ОС №1307-04, ОС №1307-05 </td> </tr> </table> </td> </tr> <tr > <td style="padding:0 45px 30px 45px;width:610px;font-size:13px;text-align: right;"> <a href="https://www.facebook.com/soglasie.sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/fb.png" style="padding-right:15px;" ></a> <a href="http://vk.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/vk.png" style="padding-right:15px;" ></a> <a href="https://twitter.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/tw.png" style="" ></a> </td> </tr> </table> </td> </tr> </table>	select DISTINCT 'STARTSELECT' AS STARTSELECT, 261 as id_ext_type, nvl((select aq.transactionid from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.paydate=(SELECT max(paydate) from sogins.acquiring aq1 where aq1.payentityid=ci.entityid and aq1.payobjectid=ci.contractid)),'nopayments') as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.Email, ci.premium_lv - (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid) as SumToPay, nvl((select aq.paysum from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.paydate=(SELECT max(paydate) from sogins.acquiring aq1 where aq1.payentityid=ci.entityid and aq1.payobjectid=ci.contractid)),-1) as LastPayment, ci.entityid as entityid, $UserID$ as UserID from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and ci.startdate_lv >= trunc(sysdate) /*Договор не просрочен*/ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный*/ and f.PhoneMobile is not null and ci.premium_lv > (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid) /*Договор не оплачен (таблица эквайринга)*/ and nvl((select aq.paysum from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.paydate=(SELECT max(paydate) from sogins.acquiring aq1 where aq1.payentityid=ci.entityid and aq1.payobjectid=ci.contractid and aq.isproject=0)),-1)=0 /*Последняя транзакция содержит 0 в сумме оплаты, что означает, что платеж по карте не прошел*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	NULL	1	2	25	90	99
262	-1	1	1	1	ТФМ-ИнфоПролонгация	20.11.2015 9:48:00	СМС информирование, что будет снята сумма для очередной пролонгации ТФМ	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Договор в проекте (пролонгация роботом Диасофт). До даты начала 10 дней.	1	True	Уважаемый клиент! $ДатаСписания$ с банковской карты $MaskPan$ будет списан платеж $Премия$ руб. по договору %23каско_рассрочка за период с $ДатаНачала$ по $ДатаОкончания$. 	select DISTINCT 'STARTSELECT' AS STARTSELECT, 262 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.email from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid  where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and trunc(sysdate) between trunc(startdate_lv) - $INFORM_FOR_DAYS_MAX$ AND trunc(startdate_lv) - $INFORM_FOR_DAYS_MIN$ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный (пролонгация роботом)*/ and f.PhoneMobile is not null and ci.startdate_lv >= sysdate /*договор еще не просрочен*/ and ci.CANCELDATE1 is null /* на всякий случай проверям флаг прекращения пролонгации и на проекте*/ and (select ci1.CANCELDATE1 from sogins.contractins ci1 where ci.CONTRACTINSPARENT=ci1.contractid) is null /*предыдущий договор не расторгнут*/ and ci.premium_lv > (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.isproject=0) /*Договор не оплачен (таблица эквайринга). Кроме того! Иметь ввиду, что премия 0 - означает запрет к пролонгации*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
263	-1	1	1	1	ТФМ-ИнфоПролонгацияEmail	20.11.2015 11:10:00	Email информирование, что будет снята сумма для очередной пролонгации ТФМ	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Договор в проекте (пролонгация роботом Диасофт). До даты начала 10 дней.	1	True	<style>td {font-size:16px;font-family:arial;color:#77787b;} span {font-family:arial;} table {width:700px;margin:0 auto;border-collapse:collapse;} </style> <table cellpadding=0; cellspacing=0; style="background:#fff5f0;" > <tr> <td style="width:700px;height:250px;"> <img src="http://www.soglasie.ru/upload/mail/ny/head_photo.png" style="width:700px;height:250px;display:block;"> </td> </tr> <tr> <td> <table cellpadding=0; cellspacing=0; > <tr> <td style="padding:0 45px;"> <table style="width: 609px;"> <tr> <td style="text-align: center;font-size: 24px;line-height: 26px; padding:20px 0 15px 0;">$Обращение$!</td> </tr> <tr> <td style="line-height:1.7;padding:0 0 15px 0;"><span style="font-weight: bold;">$ДатаСписания$</span> с банковской карты <span style="font-weight: bold;">$MaskPan$</span> будет списан платеж <br>в размере <span style="font-weight: bold;">$Премия$ руб.</span> по договору <a href="" style="pointer-events:none;text-decoration:none;cursor:nw-resize;">#каско_рассрочка</a> за период страхования с <span style="font-weight: bold;">$ДатаНачала$ г.</span> по <span style="font-weight: bold;">$ДатаОкончания$ г.</span></td> </tr> </table> </td> <tr> <td style="padding: 0 45px;line-height:1.7;text-align:right;">С уважением,</td> </tr> <tr> <td style="padding:0 45px 20px 45px;line-height:1.7;text-align:right;">Страховая компания «Согласие»</td> </tr> <tr style="text-align:center;height: 1px;"> <td style="width:610px;height:1px;background-margin:auto;display:block;"></td> </tr> <tr> <td style="padding:25px 0 25px 0;"> <table style="width:700px;"> <tr> <td style="text-align: left;padding:0 0 0 45px;"> <span style="font-size:28px;line-height: 26px;">8-800-755-00-01</span><br> <a href="http://www.soglasie.ru" style="font-size:18px;line-height: 26px;color:#F76A1C;" target="_blank">www.soglasie.ru</a> </td> <td style="width: 300px;text-align: right;padding:0 45px 0 0;font-size:12px;line-height: 1;"> ООО «Страховая компания «Согласие»<br>Центральный офис: г. Москва, ул. Гиляровского, 42<br>Лицензия ЦБ РФ от 25.05.2015 СИ № 1307, СЛ №1307, ОС №1307-03, ОС №1307-04, ОС №1307-05 </td> </tr> </table> </td> </tr> <tr > <td style="padding:0 45px 30px 45px;width:610px;font-size:13px;text-align: right;"> <a href="https://www.facebook.com/soglasie.sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/fb.png" style="padding-right:15px;" ></a> <a href="http://vk.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/vk.png" style="padding-right:15px;" ></a> <a href="https://twitter.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/tw.png" style="" ></a> </td> </tr> </table> </td> </tr> </table></body></html>	select DISTINCT 'STARTSELECT' AS STARTSELECT, 263 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.email from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid  where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and trunc(sysdate) between trunc(startdate_lv) - $INFORM_FOR_DAYS_MAX$ AND trunc(startdate_lv) - $INFORM_FOR_DAYS_MIN$ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный (пролонгация роботом)*/ and f.PhoneMobile is not null and ci.startdate_lv >= sysdate /*договор еще не просрочен*/ and ci.CANCELDATE1 is null /* на всякий случай проверям флаг прекращения пролонгации и на проекте*/ and (select ci1.CANCELDATE1 from sogins.contractins ci1 where ci.CONTRACTINSPARENT=ci1.contractid) is null /*предыдущий договор не расторгнут*/ and ci.premium_lv > (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.isproject=0) /*Договор не оплачен (таблица эквайринга). Кроме того! Иметь ввиду, что премия 0 - означает запрет к пролонгации*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	NULL	1	2	25	90	99
265	-1	1	1	1	ТФМ-НеОплачено	20.11.2015 14:45:00	СМС информирование, что оплата не получена и пролонгация отменена	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Договор в проекте (пролонгация роботом Диасофт). Дата начала просрочена договор так и не оплачен.	1	True	Уважаемый клиент! Страхование по %23каско_рассрочка прекращено в связи с отсутствием оплаты. Подробности уточняйте в колл-центре СК «Согласие» или у Вашего агента.	select DISTINCT 'STARTSELECT' AS STARTSELECT, 265 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.Email,  ci.entityid as entityid from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный*/ and f.PhoneMobile is not null and ci.premium_lv > (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.isproject=0) /*Договор не оплачен (таблица эквайринга)*/ and ci.startdate_lv < trunc(sysdate) /*договор просрочен*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
266	-1	1	1	1	ТФМ-НеОплаченоEmail	20.11.2015 16:23:00	Email информирование, что оплата не получена и пролонгация отменена	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Договор в проекте (пролонгация роботом Диасофт). Дата начала просрочена договор так и не оплачен.	1	True	<style>td {font-size:16px;font-family:arial;color:#77787b;} span {font-family:arial;} table {width:700px;margin:0 auto;border-collapse:collapse;} </style> <table cellpadding=0; cellspacing=0; style="background:#fff5f0;" > <tr> <td style="width:700px;height:250px;"> <img src="http://www.soglasie.ru/upload/mail/ny/head_photo.png" style="width:700px;height:250px;display:block;"> </td> </tr> <tr> <td> <table cellpadding=0; cellspacing=0; > <tr> <td style="padding:0 45px;"> <table style="width: 609px;"> <tr> <td style="text-align: center;font-size: 24px;line-height: 26px; padding:20px 0 15px 0;">$Обращение$!</td> </tr> <tr> <td style="line-height:1.7;padding:0 0 15px 0;"> Страхование по продукту <a href="" style="pointer-events:none;text-decoration:none;cursor:nw-resize;">#каско_рассрочка</a> прекращено в связи с отсутствием оплаты. Чтобы возобновить договор страхования или уточнить подробности обратитесь, пожалуйста,  в колл-центр ООО СК «Согласие» по телефону 8 800 755 00 01 или к Вашему страховому агенту. </td> </tr> </table> </td> <tr> <td style="padding: 0 45px;line-height:1.7;text-align:right;">С уважением,</td> </tr> <tr> <td style="padding:0 45px 20px 45px;line-height:1.7;text-align:right;">Страховая компания «Согласие»</td> </tr> <tr style="text-align:center;height: 1px;"> <td style="width:610px;height:1px;background-margin:auto;display:block;"></td> </tr> <tr> <td style="padding:25px 0 25px 0;"> <table style="width:700px;"> <tr> <td style="text-align: left;padding:0 0 0 45px;"> <span style="font-size:28px;line-height: 26px;">8-800-755-00-01</span><br> <a href="http://www.soglasie.ru" style="font-size:18px;line-height: 26px;color:#F76A1C;" target="_blank">www.soglasie.ru</a> </td> <td style="width: 300px;text-align: right;padding:0 45px 0 0;font-size:12px;line-height: 1;"> ООО «Страховая компания «Согласие»<br>Центральный офис: г. Москва, ул. Гиляровского, 42<br>Лицензия ЦБ РФ от 25.05.2015 СИ № 1307, СЛ №1307, ОС №1307-03, ОС №1307-04, ОС №1307-05 </td> </tr> </table> </td> </tr> <tr > <td style="padding:0 45px 30px 45px;width:610px;font-size:13px;text-align: right;"> <a href="https://www.facebook.com/soglasie.sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/fb.png" style="padding-right:15px;" ></a> <a href="http://vk.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/vk.png" style="padding-right:15px;" ></a> <a href="https://twitter.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/tw.png" style="" ></a> </td> </tr> </table> </td> </tr> </table></body></html>	select DISTINCT 'STARTSELECT' AS STARTSELECT, 266 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.Email,  ci.entityid as entityid from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный*/ and f.PhoneMobile is not null and ci.premium_lv > (select nvl(sum(aq.paysum),0) from sogins.acquiring aq where aq.payentityid=ci.entityid and aq.payobjectid=ci.contractid and aq.isproject=0) /*Договор не оплачен (таблица эквайринга)*/ and ci.startdate_lv < trunc(sysdate) /*договор просрочен*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	NULL	0	2	25	90	99
268	-1	1	1	1	ТФМ-ЗапретПролонгации	23.11.2015 14:45:00	СМС информирование, что дальнейшая пролонгация невозможна (убытки или достигнут предел)	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Договор в проекте (пролонгация роботом Диасофт). Дата начала не просрочена. Премия равно 0 (запрет пролонгации)	1	True	Уважаемый клиент! Дальнейшее страхование по %23каско_рассрочка невозможно. Подробности уточняйте в колл-центре СК «Согласие» или у Вашего агента.	select DISTINCT 'STARTSELECT' AS STARTSELECT, 268 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.Email,  ci.entityid as entityid from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный*/ and f.PhoneMobile is not null and ci.premium_lv = 0 /*Премия 0 - запрет пролонгации*/ and sysdate  >= ci.startdate_lv - $DayMin$ /* Отправлять не ранее 10 дней, чтобы успеть выявить ошибки пролонгации */ and ci.startdate_lv >= sysdate /*договор не просрочен*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
270	-1	1	1	1	ТФМ-ЗапретПролонгацииEmail	23.10.2015 14:45:00	Email информирование, что дальнейшая пролонгация невозможна (убытки или достигнут предел)	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. Договор в проекте (пролонгация роботом Диасофт). Дата начала не просрочена. Премия равно 0 (запрет пролонгации)	1	True	<style>td {font-size:16px;font-family:arial;color:#77787b;} span {font-family:arial;} table {width:700px;margin:0 auto;border-collapse:collapse;} </style> <table cellpadding=0; cellspacing=0; style="background:#fff5f0;" > <tr> <td style="width:700px;height:250px;"> <img src="http://www.soglasie.ru/upload/mail/ny/head_photo.png" style="width:700px;height:250px;display:block;"> </td> </tr> <tr> <td> <table cellpadding=0; cellspacing=0; > <tr> <td style="padding:0 45px;"> <table style="width: 609px;"> <tr> <td style="text-align: center;font-size: 24px;line-height: 26px; padding:20px 0 15px 0;">$Обращение$!</td> </tr> <tr> <td style="line-height:1.7;padding:0 0 15px 0;"> Дальнейшее страхование по продукту <a href="" style="pointer-events:none;text-decoration:none;cursor:nw-resize;">#каско_рассрочка</a> невозможно. Подробную информацию Вы можете получить  в колл-центр ООО СК «Согласие» по телефону 8 800 755 00 01 или у Вашего страхового агента. </td> </tr> </table> </td> <tr> <td style="padding: 0 45px;line-height:1.7;text-align:right;">С уважением,</td> </tr> <tr> <td style="padding:0 45px 20px 45px;line-height:1.7;text-align:right;">Страховая компания «Согласие»</td> </tr> <tr style="text-align:center;height: 1px;"> <td style="width:610px;height:1px;background-margin:auto;display:block;"></td> </tr> <tr> <td style="padding:25px 0 25px 0;"> <table style="width:700px;"> <tr> <td style="text-align: left;padding:0 0 0 45px;"> <span style="font-size:28px;line-height: 26px;">8-800-755-00-01</span><br> <a href="http://www.soglasie.ru" style="font-size:18px;line-height: 26px;color:#F76A1C;" target="_blank">www.soglasie.ru</a> </td> <td style="width: 300px;text-align: right;padding:0 45px 0 0;font-size:12px;line-height: 1;"> ООО «Страховая компания «Согласие»<br>Центральный офис: г. Москва, ул. Гиляровского, 42<br>Лицензия ЦБ РФ от 25.05.2015 СИ № 1307, СЛ №1307, ОС №1307-03, ОС №1307-04, ОС №1307-05 </td> </tr> </table> </td> </tr> <tr > <td style="padding:0 45px 30px 45px;width:610px;font-size:13px;text-align: right;"> <a href="https://www.facebook.com/soglasie.sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/fb.png" style="padding-right:15px;" ></a> <a href="http://vk.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/vk.png" style="padding-right:15px;" ></a> <a href="https://twitter.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/tw.png" style="" ></a> </td> </tr> </table> </td> </tr> </table></body></html>	select DISTINCT 'STARTSELECT' AS STARTSELECT, 270 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile, f.Email,  ci.entityid as entityid from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid where (ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and (case when ci.CONTRACTINSPARENT is null then 1 else case when (SELECT ci1.insproductid from sogins.contractins ci1 where ci1.contractid=ci.CONTRACTINSPARENT)=ci.insproductid then 0 else 1 end end)=0 /*Договор не первичный*/ and f.PhoneMobile is not null and ci.premium_lv = 0 /*Премия 0 - запрет пролонгации*/ and sysdate  >= ci.startdate_lv - $DayMin$ /* Отправлять не ранее 10 дней, чтобы успеть выявить ошибки пролонгации */ and ci.startdate_lv >= sysdate /*договор не просрочен*/) or (ci.contractid in ($OBJECTS_FOR_TEST$) and $USE_TEST_OBJECTS$=1 /*Опция для тестирования*/)	DiasoftConnectionString	ORACLE	1	NULL	0	2	25	90	99
272	-1	1	1	1	ПолученаОплатаСайтДоговор	01.12.2015 12:15:00	СМС с подтверждением получения оплаты банковской картой с сайта. Объект платежа Договор.	Автомат Job Neptune (Comm5min.vbs)). Диасофт. По записям созданным в таблице acquiring. Только для договоров (1843)	1	True	Уважаемый клиент! СК «Согласие» благодарит Вас за доверие и сообщает, что договор «$Продукт$»  № $НомерДоговораПолностью$ успешно оплачен, сумма полученного платежа $Сумма$ руб. 	select DISTINCT 'STARTSELECT' AS STARTSELECT, 272 as id_ext_type, aq.acquiringid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile from sogins.acquiring aq inner join sogins.contractins ci on (ci.contractid=aq.payobjectid and aq.payentityid=1843) inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.insproduct ip on ip.insproductid = ci.insproductid inner join sogins.document d on d.documentid = ci.contractid where aq.paysum >0 /*нельзя отбирать нулевые - они означают неудачное списание*/ and aq.isproject=0 /*оплата не проект*/ and ci.insproductid NOT IN ($PRODUCT_SEL$) and f.PhoneMobile is not null and aq.paydate > sysdate - $DayMin$ /* чтобы не отбирать лишних записей, отбираем только с датой получения*/	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
273	-1	1	1	1	ПолученаОплатаСайтЖРА	01.12.2015 14:38:00	СМС с подтверждением получения оплаты банковской картой с сайта. Объект платежа ЖРА.	Автомат Job Neptune (Comm5min.vbs)). Диасофт. По записям созданным в таблице acquiring. Только для ЖРА (1917)	1	True	Уважаемый клиент! СК «Согласие» благодарит Вас за доверие и сообщает, что договор «$Продукт$»  № $НомерДоговораПолностью$ успешно оплачен, сумма полученного платежа $Сумма$ руб. Спасибо за доверие!	select DISTINCT 'STARTSELECT' AS STARTSELECT, 273 as id_ext_type, aq.acquiringid as id_ext, cl.insurerid as idx_client, cl.contrlistfromagentid as idx_contract, cl.contractnumber, f.PhoneMobile from sogins.acquiring aq inner join sogins.contrlistfromagent cl on (cl.contrlistfromagentid = aq.payobjectid and aq.payentityid = 1917) inner join sogins.face f on f.faceid = cl.insurerid inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.insproduct ip on ip.insproductid = cl.inshurprodid where aq.paysum > 0 /*нельзя отбирать нулевые - они означают неудачное списание*/ and aq.isproject=0 /*оплата не проект*/ and cl.inshurprodid NOT IN ($PRODUCT_SEL$) and f.PhoneMobile is not null and aq.paydate > sysdate - $DayMin$ /* чтобы не отбирать лишних записей, отбираем только с датой получения*/	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
274	-1	1	1	1	ТФМ-Расторжение	07.12.2015 14:30:00	СМС информирование, что договор КАСКО на месяц рассторгнут.	Автомат Job Neptune (Comm5min.vbs)). Диасофт. 	1	True	Уважаемый клиент! В связи с отказом от пролонгации, списание платежей  с банковской карты по договору $НомерДоговораПолностью$ %23каско_рассрочка  прекращено.	select DISTINCT 'STARTSELECT' AS STARTSELECT, 274 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid  where ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and f.PhoneMobile is not null and nvl(ci.CANCELDATE1, sysdate-1000)  >= trunc(sysdate) - $DayMin$	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
275	-1	1	1	1	ТФМ-РасторжениеEmail	07.12.2015 14:30:00	Email информирование, что договор КАСКО на месяц рассторгнут.	Автомат Job Neptune (Comm5min.vbs)). Диасофт. 	0	True	<style>td {font-size:16px;font-family:arial;color:#77787b;} span {font-family:arial;} table {width:700px;margin:0 auto;border-collapse:collapse;} </style> <table cellpadding=0; cellspacing=0; style="background:#fff5f0;" > <tr> <td style="width:700px;height:250px;"> <img src="http://www.soglasie.ru/upload/mail/ny/head_photo.png" style="width:700px;height:250px;display:block;"> </td> </tr> <tr> <td> <table cellpadding=0; cellspacing=0; > <tr> <td style="padding:0 45px;"> <table style="width: 609px;"> <tr> <td style="text-align: center;font-size: 24px;line-height: 26px; padding:20px 0 15px 0;">$Обращение$!</td> </tr> <tr> <td style="line-height:1.7;padding:0 0 15px 0;"> В связи с отказом от пролонгации, списание платежей с банковской карты по продукту <a href="" style="pointer-events:none;text-decoration:none;cursor:nw-resize;">#каско_рассрочка</a> прекращено. </td> </tr> </table> </td> <tr> <td style="padding: 0 45px;line-height:1.7;text-align:right;">С уважением,</td> </tr> <tr> <td style="padding:0 45px 20px 45px;line-height:1.7;text-align:right;">Страховая компания «Согласие»</td> </tr> <tr style="text-align:center;height: 1px;"> <td style="width:610px;height:1px;background-margin:auto;display:block;"></td> </tr> <tr> <td style="padding:25px 0 25px 0;"> <table style="width:700px;"> <tr> <td style="text-align: left;padding:0 0 0 45px;"> <span style="font-size:28px;line-height: 26px;">8-800-755-00-01</span><br> <a href="http://www.soglasie.ru" style="font-size:18px;line-height: 26px;color:#F76A1C;" target="_blank">www.soglasie.ru</a> </td> <td style="width: 300px;text-align: right;padding:0 45px 0 0;font-size:12px;line-height: 1;"> ООО «Страховая компания «Согласие»<br>Центральный офис: г. Москва, ул. Гиляровского, 42<br>Лицензия ЦБ РФ от 25.05.2015 СИ № 1307, СЛ №1307, ОС №1307-03, ОС №1307-04, ОС №1307-05 </td> </tr> </table> </td> </tr> <tr > <td style="padding:0 45px 30px 45px;width:610px;font-size:13px;text-align: right;"> <a href="https://www.facebook.com/soglasie.sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/fb.png" style="padding-right:15px;" ></a> <a href="http://vk.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/vk.png" style="padding-right:15px;" ></a> <a href="https://twitter.com/soglasie_sk" target="_blank"><img src="http://www.soglasie.ru/upload/mail/ny/tw.png" style="" ></a> </td> </tr> </table> </td> </tr> </table></body></html>	select DISTINCT 'STARTSELECT' AS STARTSELECT, 275 as id_ext_type, ci.contractid as id_ext, ci.statusid, ci.insurerid as idx_client, ci.contractid as idx_contract, f.PhoneMobile from sogins.contractins ci inner join sogins.face f on f.faceid = ci.insurerid inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.document d on d.documentid=ci.contractid  where ci.insproductid IN ($PRODUCT_SEL$) and ci.statusid=$StatusID$ and f.PhoneMobile is not null and nvl(ci.CANCELDATE1, sysdate-1000)  >= trunc(sysdate) - $DayMin$	DiasoftConnectionString	ORACLE	1	NULL	1	2	20	90	99
276	6	2	2	0	Пролонг Агенты "Штатные"	13.01.2016 17:50:00	Письмо с предложением продлить договор	Ручная печать писем. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть почтовыый индекс.	1	True	prolongation_good.dotx	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, saleofficeid, insproductid, policyno_lv, enddate, validdate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, ci.contractid as id_ext, '№' || trim(d.number_) as ContractNumber, 0 AS SSB,0 AS external_sys_id, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, nvl(f.PhoneMobile,'0') as PhoneMobile, nvl(f.Email,'0') as Email, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText,f.faceid as idx_client,6 as id_ext_type,ci.contractid as idx_contract, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, CASE WHEN InStr(adr.address,adr.index_)=0 then adr.index_ || ', ' || adr.address ELSE adr.address END as Address,fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO, CASE nvl(fp.secondname, '') WHEN '' THEN '' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 1, 2))  WHEN 'ич' THEN 'Уважаемый' WHEN 'на' THEN 'Уважаемая' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 3, 4))  WHEN 'оглы' THEN 'Уважаемый' WHEN 'кызы' THEN 'Уважаемая' ELSE '' END END END  || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as reference, case os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') ELSE  CASE WHEN nvl(af.nameonprinter,'0')<>'0' THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.nameonprinter) ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.name) END END END ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(efp.lastname, '') || ' ' || nvl(efp.firstname, '') || ' ' ||  nvl(efp.secondname, '') END as Seller, CASE os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN CASE  WHEN nvl(af.phonemobile, '0') <> '0' THEN 'тел.: ' || af.phonemobile ELSE CASE WHEN nvl(af.phone2, '0') <> '0' THEN  'тел.: ' || af.phone2 ELSE ' ' END END ELSE  CASE WHEN nvl(af.phone1, '0') <> '0' THEN 'тел.: ' || af.phone1 ELSE ' ' END END END ELSE CASE  WHEN nvl(ef.phonemobile, '0') <> '0' THEN  'тел.: ' || ef.phonemobile ELSE CASE WHEN nvl(ef.phone2, '0') <> '0' THEN 'тел.: ' || ef.phone2 ELSE ' ' END END END as SellerPhone, CASE when nvl(io.transportmarkid,0)=0 then ' ' else 'на застрахованное Вами транспортное средство ' || nvl(tm.name,'') || ' ' end as MarkModel, CASE WHEN ci.insproductid IN (93,216,86,298) THEN 'auto.gif' ELSE CASE WHEN ci.insproductid IN (136,97,292,332,333) THEN 'property.gif' ELSE  CASE WHEN ci.insproductid IN (88,153) THEN 'dms.gif' ELSE 'default.gif' END END END as ProductIco, ci.validdate As ValidDate,ci.enddate as expiredDate, ip.name as Product, 0 AS ESB from ci inner join sogins.document d on d.documentid=ci.contractid left join sogins.osagosalesoffice oso on oso.saleofficeid=ci.saleofficeid  inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid=ftmp.faceid inner join sogins.face f on f.faceid= nvl(ftmp.mainfaceid,ftmp.faceid) inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id  left join sogins.agent sa on sa.agentid = os.faceid  left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.employee se on se.employeeid=os.faceid left join sogins.face ef on ef.faceid=se.faceid left join sogins.faceperson efp on efp.faceid=ef.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid inner join sogins.address adr on adr.faceid=f.faceid left join sogins.insobject io on io.insobjectid=ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid=io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid=io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and os.faceentityid NOT IN ($SKIP_FaceEntityid$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ and case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) And adr.addressid =(SELECT max(adr1.addressid) FROM sogins.address adr1 where adr1.faceid = f.faceid and adr1.adresstypeid in (1,2,3) and nvl(adr1.index_, '0') <> '0' and nvl(house,' ')<>' ' ) AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiaConnStrForPrinting	ORACLE	1	NULL	0	4	40	0	99
277	6	2	2	0	Пролонг Агент +Дилеры "плохие"	13.01.2016 17:52:00	Письмо с предложением продлить договор	Ручная печать писем. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть почтовыый индекс.	1	True	prolongation_bad.dotx	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, saleofficeid, insproductid, policyno_lv, enddate, validdate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, ci.contractid as id_ext, '№' || trim(d.number_) as ContractNumber, 0 AS SSB,0 AS external_sys_id, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, nvl(f.PhoneMobile,'0') as PhoneMobile, nvl(f.Email,'0') as Email, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText,f.faceid as idx_client,6 as id_ext_type,ci.contractid as idx_contract, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, CASE WHEN InStr(adr.address,adr.index_)=0 then adr.index_ || ', ' || adr.address ELSE adr.address END as Address,fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO, CASE nvl(fp.secondname, '') WHEN '' THEN '' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 1, 2))  WHEN 'ич' THEN 'Уважаемый' WHEN 'на' THEN 'Уважаемая' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 3, 4))  WHEN 'оглы' THEN 'Уважаемый' WHEN 'кызы' THEN 'Уважаемая' ELSE '' END END END  || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as reference, case os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') ELSE  CASE WHEN nvl(af.nameonprinter,'0')<>'0' THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.nameonprinter) ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.name) END END END ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(efp.lastname, '') || ' ' || nvl(efp.firstname, '') || ' ' ||  nvl(efp.secondname, '') END as Seller, CASE os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN CASE  WHEN nvl(af.phonemobile, '0') <> '0' THEN 'тел.: ' || af.phonemobile ELSE CASE WHEN nvl(af.phone2, '0') <> '0' THEN  'тел.: ' || af.phone2 ELSE ' ' END END ELSE  CASE WHEN nvl(af.phone1, '0') <> '0' THEN 'тел.: ' || af.phone1 ELSE ' ' END END END ELSE CASE  WHEN nvl(ef.phonemobile, '0') <> '0' THEN  'тел.: ' || ef.phonemobile ELSE CASE WHEN nvl(ef.phone2, '0') <> '0' THEN 'тел.: ' || ef.phone2 ELSE ' ' END END END as SellerPhone, CASE when nvl(io.transportmarkid,0)=0 then ' ' else 'на застрахованное Вами транспортное средство ' || nvl(tm.name,'') || ' ' end as MarkModel, CASE WHEN ci.insproductid IN (93,216,86,298) THEN 'auto.gif' ELSE CASE WHEN ci.insproductid IN (136,97,292,332,333) THEN 'property.gif' ELSE  CASE WHEN ci.insproductid IN (88,153) THEN 'dms.gif' ELSE 'default.gif' END END END as ProductIco, ci.validdate As ValidDate,ci.enddate as expiredDate, ip.name as Product, 0 AS ESB from ci inner join sogins.document d on d.documentid=ci.contractid left join sogins.osagosalesoffice oso on oso.saleofficeid=ci.saleofficeid  inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid=ftmp.faceid inner join sogins.face f on f.faceid= nvl(ftmp.mainfaceid,ftmp.faceid) inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id  left join sogins.agent sa on sa.agentid = os.faceid  left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.employee se on se.employeeid=os.faceid left join sogins.face ef on ef.faceid=se.faceid left join sogins.faceperson efp on efp.faceid=ef.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid inner join sogins.address adr on adr.faceid=f.faceid left join sogins.insobject io on io.insobjectid=ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid=io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid=io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and os.faceentityid NOT IN ($SKIP_FaceEntityid$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ and case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) And adr.addressid =(SELECT max(adr1.addressid) FROM sogins.address adr1 where adr1.faceid = f.faceid and adr1.adresstypeid in (1,2,3) and nvl(adr1.index_, '0') <> '0' and nvl(house,' ')<>' ' ) AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiaConnStrForPrinting	ORACLE	1	NULL	0	4	40	0	99
278	6	2	2	0	Пролонг Дилеры "хорошие"	13.01.2016 17:52:00	Письмо с предложением продлить договор	Ручная печать писем. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть почтовыый индекс.	1	True	prolongation_good.dotx	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, saleofficeid, insproductid, policyno_lv, enddate, validdate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, ci.contractid as id_ext, '№' || trim(d.number_) as ContractNumber, 0 AS SSB,0 AS external_sys_id, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, $SKIP_IF_EMAIL$ as SKIP_IF_EMAIL, nvl(f.PhoneMobile,'0') as PhoneMobile, nvl(f.Email,'0') as Email, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText,f.faceid as idx_client,6 as id_ext_type,ci.contractid as idx_contract, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, CASE WHEN InStr(adr.address,adr.index_)=0 then adr.index_ || ', ' || adr.address ELSE adr.address END as Address,fp.lastname || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as FIO, CASE nvl(fp.secondname, '') WHEN '' THEN '' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 1, 2))  WHEN 'ич' THEN 'Уважаемый' WHEN 'на' THEN 'Уважаемая' ELSE CASE lower(SUBSTR(fp.secondname, LENGTH(fp.secondname) - 3, 4))  WHEN 'оглы' THEN 'Уважаемый' WHEN 'кызы' THEN 'Уважаемая' ELSE '' END END END  || ' ' || fp.firstname || ' ' || nvl(fp.secondname, '') as reference, case os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(afp.lastname, '') || ' ' || nvl(afp.firstname, '') || ' ' ||  nvl(afp.secondname, '') ELSE  CASE WHEN nvl(af.nameonprinter,'0')<>'0' THEN 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.nameonprinter) ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || trim(af.name) END END END ELSE 'Ваш страховой агент' || CHR(13) || CHR(10) || nvl(efp.lastname, '') || ' ' || nvl(efp.firstname, '') || ' ' ||  nvl(efp.secondname, '') END as Seller, CASE os.faceentityid  WHEN 1267 THEN CASE WHEN (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid = sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid))=0 THEN ' ' ELSE CASE af.entityid WHEN 1001 THEN CASE  WHEN nvl(af.phonemobile, '0') <> '0' THEN 'тел.: ' || af.phonemobile ELSE CASE WHEN nvl(af.phone2, '0') <> '0' THEN  'тел.: ' || af.phone2 ELSE ' ' END END ELSE  CASE WHEN nvl(af.phone1, '0') <> '0' THEN 'тел.: ' || af.phone1 ELSE ' ' END END END ELSE CASE  WHEN nvl(ef.phonemobile, '0') <> '0' THEN  'тел.: ' || ef.phonemobile ELSE CASE WHEN nvl(ef.phone2, '0') <> '0' THEN 'тел.: ' || ef.phone2 ELSE ' ' END END END as SellerPhone, CASE when nvl(io.transportmarkid,0)=0 then ' ' else 'на застрахованное Вами транспортное средство ' || nvl(tm.name,'') || ' ' end as MarkModel, CASE WHEN ci.insproductid IN (93,216,86,298) THEN 'auto.gif' ELSE CASE WHEN ci.insproductid IN (136,97,292,332,333) THEN 'property.gif' ELSE  CASE WHEN ci.insproductid IN (88,153) THEN 'dms.gif' ELSE 'default.gif' END END END as ProductIco, ci.validdate As ValidDate,ci.enddate as expiredDate, ip.name as Product, 0 AS ESB from ci inner join sogins.document d on d.documentid=ci.contractid left join sogins.osagosalesoffice oso on oso.saleofficeid=ci.saleofficeid  inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid=ftmp.faceid inner join sogins.face f on f.faceid= nvl(ftmp.mainfaceid,ftmp.faceid) inner join sogins.faceperson fp on fp.faceid=f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id  left join sogins.agent sa on sa.agentid = os.faceid  left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.employee se on se.employeeid=os.faceid left join sogins.face ef on ef.faceid=se.faceid left join sogins.faceperson efp on efp.faceid=ef.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid inner join sogins.address adr on adr.faceid=f.faceid left join sogins.insobject io on io.insobjectid=ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid=io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid=io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and os.faceentityid NOT IN ($SKIP_FaceEntityid$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ and case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) And adr.addressid =(SELECT max(adr1.addressid) FROM sogins.address adr1 where adr1.faceid = f.faceid and adr1.adresstypeid in (1,2,3) and nvl(adr1.index_, '0') <> '0' and nvl(house,' ')<>' ' ) AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiaConnStrForPrinting	ORACLE	1	NULL	0	4	40	0	99
279	-1	1	2	1	АндерЗаявкаУсловEmail	17.02.2016 13:19:00	Электронное письмо андеррайтеру об условном согласовании заявки СОА	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	1	True	По заявке $НомерЗаявки$ на сумму $СтрСумма$ ($ТипСогласования$, $Филиал$) вынесено решение: УСЛОВНО СОГЛАСОВАНО.	SELECT 'STARTSELECT' AS STARTSELECT, 279 AS id_ext_type, b.uwbidid AS idx_client, TO_CHAR (h.createdate, 'ddmmyyyyhh24miss') || a.userid AS id_ext, 0 AS idx_loss, '' AS PhoneMobile, au.email_address AS Email FROM sogins.uwbid b JOIN sogins.uwbid_hist h ON b.uwbidid = h.uwbidid JOIN sogins.uwaccepts a ON a.processtypeid = b.processtypeid AND a.instypeid = b.instypeid AND a.insproductid = b.insproductid AND a.approvaltypeid = b.approvaltypeid AND A.HIGHLIMIT >= B.INSCOST and A.OUTERDEPID is null JOIN applicationuser au ON au.userid = a.userid WHERE b.isactive = 1 AND b.status = 6 AND XMLTYPE (h.snapshotdata).EXTRACT ('//status/text()').getNumberVal() = 6 AND (SYSDATE - h.createdate) * 24 <= $HOURS_INT$ AND REGEXP_LIKE (au.email_address, '^(([a-z0-9_\-]+\.)*[a-z0-9_\-]+@([a-z0-9][a-z0-9\-]*[a-z0-9]\.)+[a-z]{2,4}\;?)+' || CHR (36), 'i')	DiasoftConnectionString	ORACLE	1	NULL	1	2	25	90	99
280	-1	1	2	1	АндерВнешВходEmail	17.02.2016 13:50:00	Электронное письмо внешним согласующим о назначении заявки СОА	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	1	True	СОА: Поступила заявка № $НомерЗаявки$. $ВидСтрахования$, $ТипСогласования$. $Филиал$.	SELECT 'STARTSELECT' AS STARTSELECT, 280 AS id_ext_type, b.uwbidid AS idx_client, TO_CHAR (h.createdate, 'ddmmyyyyhh24miss') || oa.uwouterdepid AS id_ext, 0 AS idx_loss, '' AS PhoneMobile, od.email FROM sogins.uwbid b JOIN sogins.uwbid_hist h ON b.uwbidid = h.uwbidid join sogins.uwouterapproval oa on oa.uwbidid=b.uwbidid join sogins.uwouterdep od on od.uwouterdepid = oa.uwouterdepid WHERE b.isactive = 1 AND B.STATUS = 7 AND XMLTYPE (h.snapshotdata).EXTRACT ('//status/text()').getNumberVal() = 7 AND oa.statusid = 3 AND (SYSDATE - h.createdate) * 24 <= $HOURS_INT$ AND od.email is not null	DiasoftConnectionString	ORACLE	1	NULL	1	2	25	90	99
281	-1	1	2	1	АндерВнешEmail	17.02.2016 13:56:00	Электронное письмо андеррайтерам о внешнем согласовании заявки СОА	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	1	True	По заявке $НомерЗаявки$ ($ТипСогласования$, $Филиал$) $ВнДепартамент$ вынес решение: $ВнСтатус$	SELECT 'STARTSELECT' AS STARTSELECT, 281 AS id_ext_type, b.uwbidid AS idx_client, TO_CHAR (h.createdate, 'ddmmyyyyhh24miss') || oa.uwouterdepid AS id_ext, 0 AS idx_loss, '' as PhoneMobile, au.email_address as email FROM sogins.uwbid b JOIN sogins.uwbid_hist h ON b.uwbidid = h.uwbidid JOIN sogins.applicationuser au ON au.userid = b.acceptorid join sogins.uwouterapproval oa on oa.uwbidid=b.uwbidid join sogins.uwouterdep od on od.uwouterdepid = oa.uwouterdepid WHERE b.isactive = 1 AND B.STATUS = 7 AND XMLTYPE (h.snapshotdata).EXTRACT ('//status/text()').getNumberVal() = 7 AND oa.statusid not in (0,3) AND (sysdate - b.sentdate) * 24 <= $HOURS_INT$ AND REGEXP_LIKE (au.email_address, '^(([a-z0-9_\-]+\.)*[a-z0-9_\-]+@([a-z0-9][a-z0-9\-]*[a-z0-9]\.)+[a-z]{2,4}\;?)+' || CHR (36), 'i')	DiasoftConnectionString	ORACLE	1	NULL	1	2	25	90	99
282	-1	1	2	1	АндерЗаявкаВторичEmail	03.03.2016 14:24:00	Электронное письмо андеррайтеру о возврате его заявки СОА	Автомат Job Neptune (Comm5min.vbs) каждые 5 мин. Диасофт	1	True	СОА: Поступила вторичная заявка № $НомерЗаявки$. $ТипСогласования$. $Филиал$.	SELECT 'STARTSELECT' AS STARTSELECT, 282 as id_ext_type, b.uwbidid as idx_client, to_char(b.sentdate, 'ddmmyyyyhh24miss') as id_ext, 0 as idx_loss, '' as PhoneMobile, au.email_address AS Email FROM sogins.uwbid b JOIN sogins.applicationuser au ON au.userid = b.acceptorid WHERE b.status = 3 and b.isactive = 1 and (sysdate - b.sentdate) * 24 <= $HOURS_INT$ /*and B.INSTYPEID != 304 убрано Литуновский И. 03.08.16*/ AND REGEXP_LIKE (au.email_address, '^(([a-z0-9_\-]+\.)*[a-z0-9_\-]+@([a-z0-9][a-z0-9\-]*[a-z0-9]\.)+[a-z]{2,4}\;?)+' || CHR (36), 'i')	DiasoftConnectionString	ORACLE	1	NULL	1	2	25	90	99
283	-1	3	2	1	ПролонгСайт	13.04.2016 10:02:00	СМС с предложением оформить пролонгацию на сайте компании	NULL	1	True	$СвободныйТекст$, действие полиса №$СвободныйТекст$ заканчивается $Дата$. Продление договора доступно по ссылке www.soglasie.ru/making-policy/casco-prolongation/. С уважением, СК Согласие, 8 800 755-00-01	SELECT 0 as info from dual	DiasoftConnectionString	ORACLE	1	NULL	1	5	20	90	99
285	-1	1	1	4	loadInsurerOwner	05.05.2016 14:24:00	9	20	90	False	 	NULL	NULL	ORACLE	1	NULL	0	5	20	90	99
286	12	1	2	1	ПролонгEmail_ДилерыХор	18.05.2016 17:05:00	Электронное письмо с предложением продлить договор	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть email.	0	True	<table border=0 width=800px style=width:800px;><tr><td><p><b>$Обращение$!</b></p><p>ООО «СК «Согласие» благодарит Вас за доверие нашей Компании и напоминает, что</p><table cellpadding=5><tr><td><img src=http://kupi.soglasie.ru/eportal/Services/ProductIco/$ImageURL$></td><td>$ДатаОкончания$ $МаркаМодель$ истекает срок действия договора $НомерДоговораПолностью$ $Продукт$.</td></tr></table></br>$НомераСвязанныхДоговоров$<p>Для продления договора страхования обратитесь к Вашему страховому агенту или позвоните в контактный центр нашей Компании. <br/>В случае если Вы оформляли договор страхования через партнера нашей Компании, для продления договора Вы так же можете обратиться в офис нашего партнера.</p><p><b>С уважением,</br>ООО «СК «Согласие»</b></p><p><b>$Продавец$</b>$ТелефонПродавца$<p>Тел. контактного центра ООО «СК «Согласие»:<br/>8 (800) 755 0001<br/>8 (495) 739 0101</p><p><b>В Вашей заботе нуждается не только автомобиль, но и Ваш дом, родные и близкие люди.Мы предлагаем Вам специальные программы страхования для обеспечения комплексной защиты:</b></p><table cellpadding=5><tr><td><img src=http://kupi.soglasie.ru/eportal/Services/ProductIco/default.gif></td><td><li>страхование квартир и загородной недвижимости;<li>добровольное медицинское страхование (ДМС);<li>страхование от несчастного случая;<li>страхование путешественников, выезжающих за рубеж и другие.</td></tr></table><p><table border=0 cellpadding=5 ><tr><td colspan=3><b><large>Почему СК «Согласие» рекомендуют друзьям?</large></b></td></tr><tr><td><b>Опыт.</b><br>Более 20 лет страховая компания «Согласие» стабильно развивается на страховом рынке и осуществляет страхование малого, среднего и крупного бизнеса, государственных учреждений и физических лиц. </td><td><b>Профессионализм.</b><br> СК «Согласие» входит в состав Всероссийского Союза Страховщиков, Российского Союза Автостраховщиков, Национального союза страховщиков ответственности, Национального Союза Агростраховщиков и других ведущих профессиональных и отраслевых объединений.</td><td rowspan=2 width=33% valign=top><img src=http://kupi.soglasie.ru/eportal/Services/css/logo_color.gif></br><b>СК «Согласие» в цифрах:</b><br><li>1993 год – дата основания<li>450 подразделений по всей России<li>27,2 млрд рублей – общая сумма страховых выплат за 2014 год <li>8,4 млрд рублей – размер уставного капитала<li>12,2 млрд рублей – размер страховых резервов</td></tr><tr><td><b>Надежность.</b></br>Страховой компании «Согласие» в 2012 году присвоен рейтинг надежности «А++» (Исключительно высокий уровень надежности) рейтинговым агентством «Эксперт РА». </td><td><b>Признание.</b></br>СК «Согласие» имеет признание на высоком уровне: рейтинг «А++» (исключительно высокий уровень надежности) агентства «Эксперт РА», а также долгосрочный кредитный рейтинг на уровне «BB-» и рейтинг по национальной шкале на уровне «rusAA-» международного агентства Standard & Poor’s.</td></tr></table><p><table border=0 cellpadding=5 bgcolor=#dddddd ><tr><td>Отзывы о качестве обслуживания ООО «СК «Согласие» и партнеров просим оставлять на сайте <a href=http://www.soglasie.ru target=blank>www.soglasie.ru</a>, либо направлять в Отдел по работе с обращениями клиентов на адрес электронной почты <a href=mailto:claims@soglasie.ru>claims@soglasie.ru</a>.</td></tr></table></p></td></tr></table>	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText, (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid=sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid)) as ADExists, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 286 as id_ext_type, ci.contractid as idx_contract, f.PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join (select emm.employeeid, emm.dismissal, rank() over(partition by emm.employeeid order by emm.movedate desc) rnk from employeemove emm where emm.movedate < sysdate) emm on emm.employeeid = se.employeeid and emm.rnk = 1 left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND nvl(f.Email,'0')<>'0' AND case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiasoftConnectionString	ORACLE	1	NULL	0	2	25	90	99
287	12	1	2	1	ПролонгEmail_ДилерыПлох	18.05.2016 17:08:00	Электронное письмо с предложением продлить договор	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть email.	0	True	<table border=0 width=800px style=width:800px;><tr><td><p><b>$Обращение$!</b></p><p>ООО «СК «Согласие» благодарит Вас за доверие нашей Компании и напоминает, что</p><table cellpadding=5><tr><td><img src=http://kupi.soglasie.ru/eportal/Services/ProductIco/$ImageURL$></td><td>$ДатаОкончания$ $МаркаМодель$ истекает срок действия договора $НомерДоговораПолностью$ $Продукт$.</td></tr></table></br>$НомераСвязанныхДоговоров$<p>Для продления договора страхования обратитесь к Вашему страховому агенту или позвоните в контактный центр нашей Компании. <br/>В случае если Вы оформляли договор страхования через партнера нашей Компании, для продления договора Вы так же можете обратиться в офис нашего партнера.</p><p><b>С уважением,</br>ООО «СК «Согласие»</b></p><p><b>$Продавец$</b>$ТелефонПродавца$<p>Тел. контактного центра ООО «СК «Согласие»:<br/>8 (800) 755 0001<br/>8 (495) 739 0101</p><p><b>В Вашей заботе нуждается не только автомобиль, но и Ваш дом, родные и близкие люди.Мы предлагаем Вам специальные программы страхования для обеспечения комплексной защиты:</b></p><table cellpadding=5><tr><td><img src=http://kupi.soglasie.ru/eportal/Services/ProductIco/default.gif></td><td><li>страхование квартир и загородной недвижимости;<li>добровольное медицинское страхование (ДМС);<li>страхование от несчастного случая;<li>страхование путешественников, выезжающих за рубеж и другие.</td></tr></table><p><table border=0 cellpadding=5 ><tr><td colspan=3><b><large>Почему СК «Согласие» рекомендуют друзьям?</large></b></td></tr><tr><td><b>Опыт.</b><br>Более 20 лет страховая компания «Согласие» стабильно развивается на страховом рынке и осуществляет страхование малого, среднего и крупного бизнеса, государственных учреждений и физических лиц. </td><td><b>Профессионализм.</b><br> СК «Согласие» входит в состав Всероссийского Союза Страховщиков, Российского Союза Автостраховщиков, Национального союза страховщиков ответственности, Национального Союза Агростраховщиков и других ведущих профессиональных и отраслевых объединений.</td><td rowspan=2 width=33% valign=top><img src=http://kupi.soglasie.ru/eportal/Services/css/logo_color.gif></br><b>СК «Согласие» в цифрах:</b><br><li>1993 год – дата основания<li>450 подразделений по всей России<li>27,2 млрд рублей – общая сумма страховых выплат за 2014 год <li>8,4 млрд рублей – размер уставного капитала<li>12,2 млрд рублей – размер страховых резервов</td></tr><tr><td><b>Надежность.</b></br>Страховой компании «Согласие» в 2012 году присвоен рейтинг надежности «А++» (Исключительно высокий уровень надежности) рейтинговым агентством «Эксперт РА». </td><td><b>Признание.</b></br>СК «Согласие» имеет признание на высоком уровне: рейтинг «А++» (исключительно высокий уровень надежности) агентства «Эксперт РА», а также долгосрочный кредитный рейтинг на уровне «BB-» и рейтинг по национальной шкале на уровне «rusAA-» международного агентства Standard & Poor’s.</td></tr></table><p><table border=0 cellpadding=5 bgcolor=#dddddd ><tr><td>Отзывы о качестве обслуживания ООО «СК «Согласие» и партнеров просим оставлять на сайте <a href=http://www.soglasie.ru target=blank>www.soglasie.ru</a>, либо направлять в Отдел по работе с обращениями клиентов на адрес электронной почты <a href=mailto:claims@soglasie.ru>claims@soglasie.ru</a>.</td></tr></table></p></td></tr></table>	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText, (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid=sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid)) as ADExists, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 287 as id_ext_type, ci.contractid as idx_contract, f.PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join (select emm.employeeid, emm.dismissal, rank() over(partition by emm.employeeid order by emm.movedate desc) rnk from employeemove emm where emm.movedate < sysdate) emm on emm.employeeid = se.employeeid and emm.rnk = 1 left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND nvl(f.Email,'0')<>'0' AND case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiasoftConnectionString	ORACLE	1	NULL	0	2	25	90	99
288	12	1	2	1	ПролонгEmail_Штат	18.05.2016 17:08:00	Электронное письмо с предложением продлить договор	Автомат Job Neptune (crm_functions.vbs) 11-00. Диасофт. ФЛ. Не расторгнут. Полностью оплачен. Есть email.	0	True	<table border=0 width=800px style=width:800px;><tr><td><p><b>$Обращение$!</b></p><p>ООО «СК «Согласие» благодарит Вас за доверие нашей Компании и напоминает, что</p><table cellpadding=5><tr><td><img src=http://kupi.soglasie.ru/eportal/Services/ProductIco/$ImageURL$></td><td>$ДатаОкончания$ $МаркаМодель$ истекает срок действия договора $НомерДоговораПолностью$ $Продукт$.</td></tr></table></br>$НомераСвязанныхДоговоров$<p>Для продления договора страхования обратитесь к Вашему страховому агенту или позвоните в контактный центр нашей Компании. <br/>В случае если Вы оформляли договор страхования через партнера нашей Компании, для продления договора Вы так же можете обратиться в офис нашего партнера.</p><p><b>С уважением,</br>ООО «СК «Согласие»</b></p><p><b>$Продавец$</b>$ТелефонПродавца$<p>Тел. контактного центра ООО «СК «Согласие»:<br/>8 (800) 755 0001<br/>8 (495) 739 0101</p><p><b>В Вашей заботе нуждается не только автомобиль, но и Ваш дом, родные и близкие люди.Мы предлагаем Вам специальные программы страхования для обеспечения комплексной защиты:</b></p><table cellpadding=5><tr><td><img src=http://kupi.soglasie.ru/eportal/Services/ProductIco/default.gif></td><td><li>страхование квартир и загородной недвижимости;<li>добровольное медицинское страхование (ДМС);<li>страхование от несчастного случая;<li>страхование путешественников, выезжающих за рубеж и другие.</td></tr></table><p><table border=0 cellpadding=5 ><tr><td colspan=3><b><large>Почему СК «Согласие» рекомендуют друзьям?</large></b></td></tr><tr><td><b>Опыт.</b><br>Более 20 лет страховая компания «Согласие» стабильно развивается на страховом рынке и осуществляет страхование малого, среднего и крупного бизнеса, государственных учреждений и физических лиц. </td><td><b>Профессионализм.</b><br> СК «Согласие» входит в состав Всероссийского Союза Страховщиков, Российского Союза Автостраховщиков, Национального союза страховщиков ответственности, Национального Союза Агростраховщиков и других ведущих профессиональных и отраслевых объединений.</td><td rowspan=2 width=33% valign=top><img src=http://kupi.soglasie.ru/eportal/Services/css/logo_color.gif></br><b>СК «Согласие» в цифрах:</b><br><li>1993 год – дата основания<li>450 подразделений по всей России<li>27,2 млрд рублей – общая сумма страховых выплат за 2014 год <li>8,4 млрд рублей – размер уставного капитала<li>12,2 млрд рублей – размер страховых резервов</td></tr><tr><td><b>Надежность.</b></br>Страховой компании «Согласие» в 2012 году присвоен рейтинг надежности «А++» (Исключительно высокий уровень надежности) рейтинговым агентством «Эксперт РА». </td><td><b>Признание.</b></br>СК «Согласие» имеет признание на высоком уровне: рейтинг «А++» (исключительно высокий уровень надежности) агентства «Эксперт РА», а также долгосрочный кредитный рейтинг на уровне «BB-» и рейтинг по национальной шкале на уровне «rusAA-» международного агентства Standard & Poor’s.</td></tr></table><p><table border=0 cellpadding=5 bgcolor=#dddddd ><tr><td>Отзывы о качестве обслуживания ООО «СК «Согласие» и партнеров просим оставлять на сайте <a href=http://www.soglasie.ru target=blank>www.soglasie.ru</a>, либо направлять в Отдел по работе с обращениями клиентов на адрес электронной почты <a href=mailto:claims@soglasie.ru>claims@soglasie.ru</a>.</td></tr></table></p></td></tr></table>	with ci as ( select contractid, insurerid, seller1id, insobjectid, departid, insproductid, policyno_lv, enddate from sogins.contractins t inner join sogins.departmentmove dpm on dpm.departmentid = t.departid where enddate >= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MIN$, 'dd') AND 'd_rep_s'='d_rep_s' AND enddate <= TRUNC(SYSDATE + $INFORM_FOR_DAYS_MAX$, 'dd') and 'd_rep_e'='d_rep_e' and nvl(canceldate, enddate) >= enddate and (enddate - startdate_lv) >= $MIN_PERIOD$ and dpm.movedate = (SELECT max(dpm1.movedate) from sogins.departmentmove dpm1 where dpm1.departmentid = t.departid) AND 'p_rep_s'='p_rep_s' and NOT EXISTS (select * from sogins.scams scm where scm.faceid=t.insurerid) /* проверка страхователя на черный список */ and insproductid IN ($PRODUCT_SEL$) and t.departid not in (select departmentid from sogins.department dp where dp.code IN ($SKIP_DEPARMENT_CODE$)) and (SELECT cih.premium from sogins.contractins_hist cih WHERE cih.contractid = t.contractid AND cih.statedate = (SELECT MAX(cih1.statedate) from sogins.contractins_hist cih1 WHERE cih1.contractid = t.contractid)) * NVL((SELECT RT.COURSE FROM COURSE RT WHERE RT.COURSEDATE=t.signdate and rt.fundcastableid=t.fundid),1) >= $MIN_PREMIUM$ and seller1id not in (select sellerid from sogins.osagosellers where sellercode IN ($SKIP_IKP$)) and 'p_rep_e'='p_rep_e' ) SELECT 'STARTSELECT' AS STARTSELECT, $SKIP_IF_MOBILE$ as SKIP_IF_MOBILE, CASE ( SELECT count(*) from sogins.losso l where l.contractid=ci.contractid) WHEN 0 THEN '$NoLossText$' ELSE '$LossText$'  END as NoLossBlockText, (select count(*) from agentdocument ad inner join doccontr dc on dc.documentid = ad.agentdocumentid where ad.agentid=sa.agentid and ad.status in (21, 27) and dc.startdate <= sysdate and coalesce(ad.DateCancel, dc.EndDate, to_date('01.10.3000', 'dd.mm.yyyy')) >= sysdate and exists (select acac.contentid from agentcontractcontents acac inner join insproduct ip on ip.complexinskindid = acac.instype where acac.agentcontractid = ad.agentdocumentid and ip.insproductid = ci.insproductid)) as ADExists, ci.enddate as expiredDate, f.faceid as idx_client, ci.contractid as id_ext, 288 as id_ext_type, ci.contractid as idx_contract, f.PhoneMobile, f.Email, $DATE_SHIFT$ as date_shift, '$PRODUCT_SEL_SHIFT$' as PRODUCT_SEL_SHIFT, nvl(ci.policyno_lv, d.Number_) as ContractNumber from ci inner join sogins.document d on d.documentid = ci.contractid inner join sogins.insproduct ip on ip.insproductid=ci.insproductid inner join sogins.face ftmp on ci.insurerid = ftmp.faceid inner join sogins.face f on f.faceid = nvl(ftmp.mainfaceid, ftmp.faceid) inner join sogins.faceperson fp on fp.faceid = f.faceid inner join sogins.osagosellers os on os.sellerid = ci.seller1id left join sogins.agent sa on sa.agentid = os.faceid left join sogins.agentstatus ast on ast.agentstatusid = sa.status left join sogins.face af on af.faceid = sa.faceid left join sogins.faceperson afp on afp.faceid = af.faceid left join sogins.facejuridical afj on afj.faceid = af.faceid left join sogins.JuridicalOrgStatus jorg on afj.JuridicalOrgStatusID = jorg.JuridicalOrgStatusID left join sogins.employee se on se.employeeid = os.faceid left join (select emm.employeeid, emm.dismissal, rank() over(partition by emm.employeeid order by emm.movedate desc) rnk from employeemove emm where emm.movedate < sysdate) emm on emm.employeeid = se.employeeid and emm.rnk = 1 left join sogins.face ef on ef.faceid = se.faceid left join sogins.faceperson efp on efp.faceid = ef.faceid left join sogins.insobject io on io.insobjectid = ci.insobjectid left join sogins.transportmark tm on tm.transportmarkid = io.transportmarkid left join sogins.transportmodel tmd on tmd.transportmodelid = io.transportmodelid where nvl(d.endivision_orgstructureid,28) IN ($ORGSTRUCTURE_SEL$) and nvl(sa.status, 0) NOT IN ($SKIP_AGENT_TYPE$) and to_char(ci.enddate+1 ,'yyyy')-nvl(io.explyear, to_char(sysdate,'yyyy'))<=$YEAR_TS$ AND NOT EXISTS (SELECT 1 FROM sogins.ContractIns ci1 WHERE ci1.ContractInsParent = ci.ContractID AND ci1.statusid <> 20) and ((SELECT count(l.lossid) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) < $NLOSS_LIMIT$ or nvl((SELECT sum(l.declaredsuminlossfund) FROM sogins.losso l WHERE l.contractid = ci.contractid AND (GuiltyKind <> 'регресс' AND GuiltyKind NOT LIKE 'ответчик%')) / (SELECT sum(r.premium_lv) from sogins.insrisko r WHERE r.contractid = ci.contractid and r.insrisktypeid in (844, 784)), 0) <= to_number('$KUB_LIMIT$', '9.9')) AND nvl(f.Email,'0')<>'0' AND case when f.entityid=1001 then 'ФЛ' else 'ЮЛ' END IN ($FACE_TYPE$) and case when nvl((SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID), 0) = 0 then (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) else (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_MUST WHERE (ContractInsOID = ci.contractid) AND (IsFact = 0) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) end = (SELECT SUM(Ammount2) AS Expr1 FROM Sogins.Payment P_IS WHERE (ContractInsOID = ci.contractid) AND (IsFact = 1) AND (PaymentCategoryID = 34) GROUP BY ContractInsOID) ORDER BY CASE ci.insproductid WHEN 93 THEN 100 WHEN 216 THEN 90 WHEN 298 THEN 80 WHEN  86 THEN 70 ELSE 1 END DESC	DiasoftConnectionString	ORACLE	1	NULL	0	2	25	90	99
289	-1	4	1	6	eOSAGO.getPolicyStatus	06.06.2016 16:52:00	WS получение статуса загрузки проекта договора eOSAGO	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
   <soapenv:Header/>
   <soapenv:Body>
      <eos:getPolicyStatus>
         <request>
            <PolicyTitle>
               <TripNumber>?</TripNumber>
<!-- дата роли не играет, но ее наличие необходимо -->
               <TripTm>$TripTm$</TripTm>
            </PolicyTitle>
            <DraftPolicyImportId>$IDCHECK$</DraftPolicyImportId>
         </request>
      </eos:getPolicyStatus>
   </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 289 as id_ext_type, '$TagFailedFields$' as TagFailedFields, $IsAssynchron$ as IsAssynchron, '$TagSerialKey$' as DraftPolicySerialKey, '$TagNumberKey$' as DraftPolicyNumberKey, 0 as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID , $NextStatusIDFailure$ as NextStatusIDFailure, $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss from sogins.EOSAGOOBJECTS eo where eo.eosagoobjentityid=$ObjEntityID$ and eo.eosagoobjstatusid=$StatusID$	DiasoftTestingConnectionString	ORACLE	4	getPolicyStatus	1	9	20	90	86
290	-1	4	1	6	eOSAGO.setPolicyStatus	18.07.2016 15:06:00	WS изменения статуса проекта договора eOSAGO	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
   <soapenv:Header/>
   <soapenv:Body>
      <eos:setPolicyStatus>
         <request >
            <StatusPolicyTitle>
               <TripNumber>?</TripNumber>
<!-- дата роли не играет, но ее наличие необходимо -->
               <TripTm>$TripTm$</TripTm>              
            </StatusPolicyTitle>
            <StatusDraftPolicyRequest>
               <DraftPolicyID>$DraftPolicyID$</DraftPolicyID>
               <DateRevision>$DateRevision$</DateRevision>
               <DraftPolicySerialKey>1</DraftPolicySerialKey>
               <DraftPolicyNumberKey>2</DraftPolicyNumberKey>
               <DraftPolicyStatus>1 <!-- 0- Аннулирован, 1 – Действующий. --></DraftPolicyStatus>
            </StatusDraftPolicyRequest>
         </request>
      </eos:setPolicyStatus>
   </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 290 as id_ext_type, '$TagFailedFields$' as TagFailedFields, $IsAssynchron$ as IsAssynchron, 0 as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID , $NextStatusIDFailure$ as NextStatusIDFailure, $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss from sogins.EOSAGOOBJECTS eo inner join contractins ci on ci.contractid = eo.objectid where eo.eosagoobjentityid=$ObjEntityID$ and eo.eosagoobjstatusid=$StatusID$	DiasoftTestingConnectionString	ORACLE	4	setPolicyStatus	1	9	20	90	86
291	-1	4	1	6	eOSAGO.getSetStatusResult	18.07.2016 15:07:00	WS получение результата по переводу статуса проекта договора eOSAGO	Автомат Job Neptune (WSeOSAGO.vbs) каждые 3 мин. Диасофт	1	True	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:eos="http://eosago.rsa.soglasie.ru/">
   <soapenv:Header/>
   <soapenv:Body>
      <eos:getSetStatusResult>
         <request >
            <StatusPolicyTitle>
               <TripNumber>?</TripNumber>
               <TripTm>$TripTm$</TripTm>
            </StatusPolicyTitle>
            <StatusPolicyImportId>$IDCHECK$</StatusPolicyImportId>
         </request>
      </eos:getSetStatusResult>
   </soapenv:Body>
</soapenv:Envelope>	select 'STARTSELECT' AS STARTSELECT, 291 as id_ext_type, '$TagFailedFields$' as TagFailedFields, $IsAssynchron$ as IsAssynchron, 0 as idx_client, eo.eosagoobjid || 'v' || eo.ver as id_ext, eo.eosagoobjid as objid, $NextStatusID$ as NextStatusID , $NextStatusIDFailure$ as NextStatusIDFailure, $NextProgress$ as NextProgress, '$TagError$' as TagError, '$TagDescription$' as TagDescription, '$TagIDCheck$' as TagIDCheck, '$TagChecked$' as TagChecked, 0 as idx_loss from sogins.EOSAGOOBJECTS eo where eo.eosagoobjentityid=$ObjEntityID$ and eo.eosagoobjstatusid=$StatusID$	DiasoftTestingConnectionString	ORACLE	4	getSetStatusResult	1	9	20	90	86
